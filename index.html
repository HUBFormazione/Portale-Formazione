<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piattaforma E-Learning con Google Sheets</title>
  <script src="https://cdn.tailwindcss.com/3.3.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .upload-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full"><!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-white text-lg" id="loadingText">Caricamento dati...</p>
   </div>
  </div><!-- ‚ö†Ô∏è CONFIGURAZIONE GOOGLE SHEETS -->
  <script>
        // üîß INCOLLA QUI L'URL DEL TUO GOOGLE APPS SCRIPT
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxpbgfBbAWOoOvHZ2HVSLgZcXifk8jEhn2u8S_HJc0xz8AyDZPW8L9b3dI-u8Ub-zS9Xg/exec';
    </script><!-- Navigation -->
  <nav class="bg-white shadow-lg border-b-4 border-blue-500">
   <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center py-4">
     <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-lg">üéì</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800">EduPlatform <span class="text-sm text-green-600">‚òÅÔ∏è Cloud</span></h1>
     </div>
     <div class="flex items-center space-x-4"><span id="currentUser" class="text-gray-600 font-medium"></span> <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"> Logout </button>
     </div>
    </div>
   </div>
  </nav><!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">üéì</span>
     </div>
     <h2 class="text-3xl font-bold text-gray-800">Accedi alla Piattaforma</h2>
     <p class="text-gray-600 mt-2">Dati salvati su Google Sheets ‚òÅÔ∏è</p>
    </div>
    <form onsubmit="login(event)" class="space-y-6">
     <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div>
     <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors"> Accedi </button>
    </form>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
     <p class="text-sm text-gray-600 mb-2"><strong>Credenziali Demo:</strong></p>
     <p class="text-xs text-gray-500">Admin: admin@edu.com / admin123</p>
     <p class="text-xs text-gray-500">Studente: studente@edu.com / student123</p>
    </div>
    <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
     <p class="text-xs text-green-800">‚úÖ <strong>Dati Persistenti:</strong> I dati vengono salvati su Google Sheets e rimangono anche dopo il refresh!</p>
    </div>
   </div>
  </div><!-- Main Dashboard -->
  <div id="dashboard" class="hidden"><!-- Admin Dashboard -->
   <div id="adminDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Amministratore</h2>
     <p class="text-gray-600">Gestisci studenti e corsi - Dati salvati su Google Sheets ‚òÅÔ∏è</p>
    </div><!-- Admin Navigation Tabs -->
    <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg"><button onclick="showAdminTab('students')" id="studentsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-blue-600 shadow-sm"> üë• Gestione Studenti </button> <button onclick="showAdminTab('courses')" id="coursesTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> üìö Gestione Corsi </button> <button onclick="showAdminTab('reports')" id="reportsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> üìä Report </button> <button onclick="showAdminTab('settings')" id="settingsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> ‚öôÔ∏è Impostazioni </button>
    </div><!-- Students Management -->
    <div id="studentsSection" class="fade-in">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Studenti</h3>
       <div class="flex space-x-3"><button onclick="downloadExcelTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> üì• Scarica Template </button> <button onclick="document.getElementById('excelUpload').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> üì§ Carica Excel </button> <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)" class="hidden"> <button onclick="showModal('addStudentModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> ‚ûï Aggiungi Singolo </button>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gray-50">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nome</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azienda</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Stato</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azioni</th>
         </tr>
        </thead>
        <tbody id="studentsTable" class="divide-y divide-gray-200"><!-- Students will be populated here -->
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Courses Management -->
    <div id="coursesSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Corsi</h3><button onclick="showModal('addCourseModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> ‚ûï Crea Corso </button>
      </div>
      <div id="coursesList" class="space-y-4"><!-- Courses will be populated here -->
      </div>
     </div>
    </div><!-- Reports Section -->
    <div id="reportsSection" class="hidden">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Studenti Totali</p>
         <p id="totalStudents" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><span class="text-blue-600 text-xl">üë•</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Corsi Attivi</p>
         <p id="totalCourses" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><span class="text-green-600 text-xl">üìö</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Completamenti</p>
         <p id="totalCompletions" class="text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><span class="text-purple-600 text-xl">üèÜ</span>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Settings Section -->
    <div id="settingsSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">ÔøΩÔøΩÔøΩÔøΩÔ∏è Configurazione Piattaforma</h3><!-- EmailJS Configuration -->
      <div class="border-b border-gray-200 pb-6 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h4 class="text-lg font-medium text-gray-800">üìß Configurazione EmailJS</h4>
         <p class="text-sm text-gray-600 mt-1">Imposta le credenziali per l'invio automatico delle email agli studenti</p>
        </div>
        <div id="emailStatusBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
         ‚ùå Non Configurato
        </div>
       </div>
       <form onsubmit="saveEmailJSConfig(event)" class="space-y-4">
        <div><label for="emailJSPublicKey" class="block text-sm font-medium text-gray-700 mb-2">Public Key</label> <input type="text" id="emailJSPublicKey" placeholder="es: xYz123AbC456" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <p class="text-xs text-gray-500 mt-1">Vai su EmailJS ‚Üí Account ‚Üí General ‚Üí Public Key</p>
        </div>
        <div><label for="emailJSServiceID" class="block text-sm font-medium text-gray-700 mb-2">Service ID</label> <input type="text" id="emailJSServiceID" placeholder="es: service_abc123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <p class="text-xs text-gray-500 mt-1">Vai su EmailJS ‚Üí Email Services ‚Üí Il tuo Service ID</p>
        </div>
        <div><label for="emailJSTemplateID" class="block text-sm font-medium text-gray-700 mb-2">Template ID</label> <input type="text" id="emailJSTemplateID" placeholder="es: template_xyz789" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <p class="text-xs text-gray-500 mt-1">Vai su EmailJS ‚Üí Email Templates ‚Üí Il tuo Template ID</p>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
         <h5 class="font-medium text-blue-900 mb-2">üìã Template Email Richiesto</h5>
         <p class="text-sm text-blue-800 mb-2">Il tuo template EmailJS deve contenere questi parametri:</p>
         <ul class="text-xs text-blue-700 space-y-1 ml-4">
          <li>‚Ä¢ <code class="bg-blue-100 px-1 rounded">{{student_name}}</code> - Nome completo studente</li>
          <li>‚Ä¢ <code class="bg-blue-100 px-1 rounded">{{student_email}}</code> - Email studente</li>
          <li>‚Ä¢ <code class="bg-blue-100 px-1 rounded">{{activation_link}}</code> - Link per creare password</li>
          <li>‚Ä¢ <code class="bg-blue-100 px-1 rounded">{{platform_name}}</code> - Nome piattaforma</li>
          <li>‚Ä¢ <code class="bg-blue-100 px-1 rounded">{{company_name}}</code> - Nome azienda studente</li>
         </ul>
        </div>
        <div class="flex space-x-3"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> üíæ Salva Configurazione </button> <button type="button" onclick="testEmailJSConfig()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium"> üß™ Test Email </button>
        </div>
       </form>
      </div><!-- Google Sheets Connection Test -->
      <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl shadow-lg p-6 border-2 border-purple-200">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h3 class="text-xl font-semibold text-gray-800 mb-1">üîó Test Connessione Google Sheets</h3>
         <p class="text-sm text-gray-600">Diagnostica problemi di connessione con il database</p>
        </div>
        <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center"><span class="text-white text-xl">üß™</span>
        </div>
       </div>
       <div class="space-y-4">
        <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
         <p class="text-sm text-gray-700 font-medium mb-2">üìã URL Configurato:</p>
         <p id="sheetsUrlDisplay" class="text-xs text-gray-600 font-mono break-all p-2 bg-gray-50 rounded"></p>
        </div><button onclick="testConnection()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-4 rounded-lg transition-all font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105"> üß™ TESTA CONNESSIONE ORA </button>
        <div id="connectionResult" class="hidden"></div>
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
         <p class="text-xs text-blue-800">üí° <strong>Quando usare:</strong> Se non vedi i dati caricati o ricevi errori, usa questo test per capire esattamente dov'√® il problema!</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Student Dashboard -->
   <div id="studentDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">I Miei Corsi</h2>
     <p class="text-gray-600">Accedi ai tuoi corsi - Progressi salvati automaticamente ‚òÅÔ∏è</p>
    </div>
    <div id="studentCoursesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Student courses will be populated here -->
    </div>
   </div>
  </div><!-- Add Student Modal -->
  <div id="addStudentModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Studente</h3><button onclick="hideModal('addStudentModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <form onsubmit="addStudent(event)" class="space-y-4">
      <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label> <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label for="studentSurname" class="block text-sm font-medium text-gray-700 mb-1">Cognome</label> <input type="text" id="studentSurname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label for="studentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="studentEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label for="studentPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefono</label> <input type="tel" id="studentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label for="studentCompany" class="block text-sm font-medium text-gray-700 mb-1">Azienda</label> <input type="text" id="studentCompany" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addStudentModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Add Course Modal -->
  <div id="addCourseModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Crea Nuovo Corso</h3><button onclick="hideModal('addCourseModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <form onsubmit="addCourse(event)" class="space-y-4">
      <div><label for="courseTitle" class="block text-sm font-medium text-gray-700 mb-1">Titolo del Corso</label> <input type="text" id="courseTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div><label for="courseDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label> <textarea id="courseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
      </div>
      <div class="flex items-center space-x-2"><input type="checkbox" id="courseHasTest" class="rounded"> <label for="courseHasTest" class="text-sm font-medium text-gray-700">Il corso include un test finale</label>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addCourseModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Crea Corso </button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
        // ==========================================
        // EMAILJS FUNCTIONS
        // ==========================================

        // Inizializza EmailJS
        function initEmailJS() {
            if (typeof emailjs !== 'undefined' && emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId) {
                emailjs.init(emailJSConfig.publicKey);
                return true;
            }
            return false;
        }

        // Verifica se EmailJS √® configurato
        function isEmailJSConfigured() {
            return emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId;
        }

        // Genera token per attivazione account
        function generateActivationToken(studentId, email) {
            const timestamp = Date.now();
            const data = `${studentId}-${email}-${timestamp}`;
            return btoa(data);
        }

        // Invia email di benvenuto con link attivazione
        async function sendWelcomeEmail(student) {
            if (!initEmailJS()) {
                console.warn('EmailJS non configurato. Email non inviata.');
                return { success: false, message: 'EmailJS non configurato' };
            }

            try {
                const activationToken = generateActivationToken(student.id, student.email);
                const activationLink = `${window.location.origin}${window.location.pathname}?action=activate&token=${activationToken}`;

                const templateParams = {
                    student_name: `${student.name} ${student.surname}`,
                    student_email: student.email,
                    activation_link: activationLink,
                    platform_name: 'EduPlatform',
                    company_name: student.company
                };

                const response = await emailjs.send(
                    emailJSConfig.serviceId,
                    emailJSConfig.templateId,
                    templateParams
                );

                console.log('‚úÖ Email inviata con successo:', response);
                return { success: true, message: 'Email inviata con successo' };

            } catch (error) {
                console.error('‚ùå Errore invio email:', error);
                return { success: false, message: error.text || error.message };
            }
        }

        // ==========================================
        // GOOGLE SHEETS API FUNCTIONS
        // ==========================================

        // Mostra/nascondi loading
        function showLoading(message = 'Caricamento dati...') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = message;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Test connessione Google Sheets con diagnostica dettagliata
        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'p-4 rounded-lg bg-blue-50 border border-blue-200';
            resultDiv.innerHTML = '<p class="text-sm text-blue-800">üîÑ Controllo connessione in corso...</p>';
            
            try {
                // Test 1: Verifica URL
                if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('TUO_ID') || GOOGLE_SHEETS_URL.length < 50) {
                    resultDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-red-800 font-medium mb-2">‚ùå URL non configurato correttamente</p>
                        <p class="text-xs text-red-700 mb-3">L'URL di Google Sheets non √® valido o non √® stato configurato.</p>
                        <div class="bg-red-100 p-3 rounded text-xs text-red-800">
                            <p class="font-medium mb-2">‚úÖ SOLUZIONE:</p>
                            <ol class="list-decimal ml-4 space-y-1">
                                <li>Vai su Google Apps Script</li>
                                <li>Clicca "Deploy" ‚Üí "NUOVA distribuzione"</li>
                                <li>Scegli tipo "Web app"</li>
                                <li>Imposta "Chi ha accesso" su <strong>"Chiunque"</strong></li>
                                <li>Copia l'URL (inizia con https://script.google.com/macros/s/...)</li>
                                <li>Incollalo nel codice alla riga ~100</li>
                            </ol>
                        </div>
                    `;
                    return;
                }

                // Test 2: Tentativo di connessione
                const testUrl = `${GOOGLE_SHEETS_URL}?action=read&sheet=Studenti&_t=${Date.now()}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    resultDiv.className = 'p-4 rounded-lg bg-orange-50 border border-orange-200';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-orange-800 font-medium mb-2">‚ö†Ô∏è Errore dal server Google Sheets</p>
                        <p class="text-xs text-orange-700 mb-2">Messaggio: ${result.message}</p>
                        <div class="bg-orange-100 p-3 rounded text-xs text-orange-800">
                            <p class="font-medium mb-2">üîç POSSIBILI CAUSE:</p>
                            <ul class="list-disc ml-4 space-y-1">
                                <li>Il foglio "Studenti" non esiste nel Google Sheet</li>
                                <li>Le intestazioni non corrispondono</li>
                                <li>Errore nello script Google Apps Script</li>
                            </ul>
                        </div>
                    `;
                } else if (result.status === 'success') {
                    resultDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-green-800 font-medium mb-2">‚úÖ Connessione perfetta!</p>
                        <p class="text-xs text-green-700 mb-2">Il collegamento con Google Sheets funziona correttamente.</p>
                        <div class="bg-green-100 p-3 rounded text-xs text-green-800">
                            <p class="font-medium mb-1">üìä Dati trovati:</p>
                            <ul class="list-disc ml-4">
                                <li>Studenti caricati: <strong>${result.data ? result.data.length : 0}</strong></li>
                            </ul>
                            <p class="mt-2">Ora puoi aggiungere studenti e corsi! üöÄ</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    resultDiv.className = 'p-4 rounded-lg bg-yellow-50 border border-yellow-200';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-yellow-800 font-medium mb-2">‚è±Ô∏è Timeout connessione</p>
                        <p class="text-xs text-yellow-700 mb-3">Il server impiega troppo tempo a rispondere.</p>
                    `;
                } else {
                    resultDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
                    resultDiv.innerHTML = `
                        <p class="text-sm text-red-800 font-medium mb-2">‚ùå Errore connessione</p>
                        <p class="text-xs text-red-700 mb-2">Messaggio: ${error.message}</p>
                    `;
                }
            }
        }

        // Leggi dati da Google Sheets
        async function readFromSheets(sheetName) {
            try {
                showLoading(`Caricamento ${sheetName}...`);
                
                const url = `${GOOGLE_SHEETS_URL}?action=read&sheet=${sheetName}&_=${Date.now()}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                hideLoading();
                
                if (result.status === 'success') {
                    console.log(`‚úÖ ${sheetName} caricato:`, result.data.length, 'record');
                    return result.data || [];
                } else {
                    console.error(`‚ùå Errore ${sheetName}:`, result.message);
                    showNotification(`Errore caricamento ${sheetName}: ${result.message}`, 'error');
                    return [];
                }
            } catch (error) {
                hideLoading();
                console.error(`‚ùå Errore connessione ${sheetName}:`, error);
                showNotification(
                    `‚ö†Ô∏è Impossibile caricare ${sheetName}\n\nVai su Impostazioni ‚Üí Test Connessione per diagnosticare il problema.`,
                    'error'
                );
                return [];
            }
        }

        // Scrivi dati su Google Sheets (METODO POST con redirect follow)
        async function writeToSheets(sheetName, action, data) {
            try {
                showLoading('Salvataggio in corso...');
                
                console.log(`üì§ Invio ${action} a ${sheetName}:`, data);
                
                // Usa POST con redirect: 'follow' per gestire automaticamente i redirect di Google
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        sheet: sheetName,
                        data: data
                    }),
                    redirect: 'follow', // Segue automaticamente i redirect di Google
                    mode: 'no-cors' // Evita problemi CORS
                });
                
                // Con no-cors non possiamo leggere la risposta, quindi assumiamo successo
                hideLoading();
                console.log(`‚úÖ Richiesta ${action} inviata a ${sheetName}`);
                
                // Attendiamo 2 secondi per dare tempo a Google Sheets di processare
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                return { status: 'success' };
                
            } catch (error) {
                hideLoading();
                console.error(`‚ùå Errore ${action} su ${sheetName}:`, error);
                showNotification(`‚ùå Errore salvataggio: ${error.message}`, 'error');
                return null;
            }
        }

        // ==========================================
        // EXCEL UPLOAD FUNCTIONS
        // ==========================================

        function downloadExcelTemplate() {
            try {
                if (typeof XLSX === 'undefined') {
                    showNotification('‚ùå Errore: Libreria Excel non caricata. Ricarica la pagina.', 'error');
                    return;
                }
                
                const wb = XLSX.utils.book_new();
                
                const wsData = [
                    ['Nome', 'Cognome', 'Email', 'Telefono', 'Azienda'],
                    ['Mario', 'Rossi', 'mario.rossi@esempio.com', '3331234567', 'Azienda ABC'],
                    ['Laura', 'Bianchi', 'laura.bianchi@esempio.com', '3347654321', 'Azienda XYZ'],
                    ['', '', '', '', '']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                ws['!cols'] = [
                    {wch: 15},
                    {wch: 15},
                    {wch: 30},
                    {wch: 15},
                    {wch: 20}
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Studenti');
                XLSX.writeFile(wb, 'template_studenti.xlsx');
                
                showNotification('üì• Template scaricato! Compilalo e ricaricalo nella piattaforma.', 'success');
            } catch (error) {
                console.error('Errore download template:', error);
                showNotification('‚ùå Errore durante il download del template: ' + error.message, 'error');
            }
        }

        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('Lettura file Excel...');
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    hideLoading();
                    
                    if (jsonData.length === 0) {
                        showNotification('‚ö†Ô∏è Il file Excel √® vuoto!', 'error');
                        return;
                    }
                    
                    await importStudentsFromExcel(jsonData);
                    
                } catch (error) {
                    hideLoading();
                    console.error('Errore lettura Excel:', error);
                    showNotification('‚ùå Errore nella lettura del file Excel. Verifica il formato!', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        async function importStudentsFromExcel(excelData) {
            showLoading(`Importazione ${excelData.length} studenti...`);
            
            let successCount = 0;
            let errorCount = 0;
            let emailsSent = 0;
            let emailsFailed = 0;
            const errors = [];
            const importedStudents = [];
            
            console.log('üìä Dati Excel ricevuti:', excelData);
            console.log('üìã Colonne presenti:', Object.keys(excelData[0] || {}));
            
            for (let i = 0; i < excelData.length; i++) {
                const row = excelData[i];
                
                console.log(`\nüîç Elaborazione riga ${i + 2}:`, row);
                
                if (!row.Nome || !row.Cognome || !row.Email || !row.Azienda) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Campi obbligatori mancanti`);
                    console.error(`‚ùå Riga ${i + 2}: Campi mancanti`);
                    continue;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(row.Email)) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email non valida`);
                    console.error(`‚ùå Riga ${i + 2}: Email non valida`);
                    continue;
                }
                
                const duplicate = students.find(s => s.email.toLowerCase() === row.Email.toLowerCase());
                if (duplicate) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email gi√† esistente`);
                    console.error(`‚ùå Riga ${i + 2}: Email duplicata`);
                    continue;
                }
                
                const newStudent = {
                    id: Date.now().toString() + '_' + i,
                    name: row.Nome.trim(),
                    surname: row.Cognome.trim(),
                    email: row.Email.trim().toLowerCase(),
                    phone: row.Telefono ? row.Telefono.toString().trim() : '',
                    company: row.Azienda.trim(),
                    status: 'active',
                    registrationDate: new Date().toISOString()
                };
                
                console.log(`üì§ Invio studente:`, newStudent);
                
                const result = await writeToSheets('Studenti', 'create', newStudent);
                
                if (result && result.status === 'success') {
                    students.push(newStudent);
                    importedStudents.push(newStudent);
                    successCount++;
                    console.log(`‚úÖ Riga ${i + 2}: Salvato!`);
                } else {
                    errorCount++;
                    const errorMsg = result ? result.message : 'Nessuna risposta';
                    errors.push(`Riga ${i + 2}: ${errorMsg}`);
                    console.error(`‚ùå Riga ${i + 2}: Errore -`, errorMsg);
                }
                
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            if (importedStudents.length > 0) {
                showLoading(`Invio email a ${importedStudents.length} studenti...`);
                
                for (const student of importedStudents) {
                    const emailResult = await sendWelcomeEmail(student);
                    if (emailResult.success) {
                        emailsSent++;
                    } else {
                        emailsFailed++;
                    }
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            hideLoading();
            loadStudents();
            
            let message = `‚úÖ Importazione completata!\n\n`;
            message += `‚úîÔ∏è Studenti importati: ${successCount}\n`;
            message += `üìß Email inviate: ${emailsSent}\n`;
            if (emailsFailed > 0) {
                message += `‚ö†Ô∏è Email non inviate: ${emailsFailed}\n`;
            }
            if (errorCount > 0) {
                message += `‚ùå Errori: ${errorCount}\n\n`;
                message += `Dettagli:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    message += `\n... e altri ${errors.length - 5} errori`;
                }
            }
            
            showNotification(message, successCount > 0 ? 'success' : 'error');
        }

        // Notifiche toast
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white`;
            notification.style.whiteSpace = 'pre-line';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, type === 'error' ? 8000 : 5000);
        }

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let students = [];
        let courses = [];
        let progressData = [];
        let emailJSConfig = {
            publicKey: '',
            serviceId: '',
            templateId: ''
        };

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = {
                'admin@edu.com': { role: 'admin', name: 'Amministratore', password: 'admin123' },
                'studente@edu.com': { role: 'student', name: 'Mario Rossi', password: 'student123' }
            };
            
            if (users[email] && users[email].password === password) {
                currentUser = { email, ...users[email] };
                document.getElementById('currentUser').textContent = currentUser.name;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                if (currentUser.role === 'admin') {
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    await loadAllData();
                } else if (currentUser.role === 'student') {
                    document.getElementById('studentDashboard').classList.remove('hidden');
                    await loadStudentCourses();
                }
            } else {
                showNotification('‚ùå Credenziali non valide', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // ==========================================
        // DATA LOADING
        // ==========================================
        async function loadAllData() {
            students = await readFromSheets('Studenti');
            courses = await readFromSheets('Corsi');
            progressData = await readFromSheets('Progressi');
            await loadEmailJSConfig();
            
            loadStudents();
            loadCourses();
            updateStats();
        }

        // ==========================================
        // SETTINGS FUNCTIONS
        // ==========================================
        
        async function saveEmailJSConfig(event) {
            event.preventDefault();
            
            const publicKey = document.getElementById('emailJSPublicKey').value.trim();
            const serviceId = document.getElementById('emailJSServiceID').value.trim();
            const templateId = document.getElementById('emailJSTemplateID').value.trim();
            
            if (!publicKey || !serviceId || !templateId) {
                showNotification('‚ö†Ô∏è Compila tutti i campi!', 'error');
                return;
            }
            
            emailJSConfig.publicKey = publicKey;
            emailJSConfig.serviceId = serviceId;
            emailJSConfig.templateId = templateId;
            
            try {
                localStorage.setItem('emailjs_config', JSON.stringify(emailJSConfig));
                updateEmailStatusBadge();
                showNotification('‚úÖ Configurazione EmailJS salvata!', 'success');
            } catch (error) {
                console.error('Errore salvataggio:', error);
                showNotification('‚ùå Errore salvataggio: ' + error.message, 'error');
            }
        }
        
        async function testEmailJSConfig() {
            if (!isEmailJSConfigured()) {
                showNotification('‚ö†Ô∏è Configura EmailJS prima di testare!', 'error');
                return;
            }
            
            showLoading('Invio email di test...');
            
            const testStudent = {
                id: 'test_' + Date.now(),
                name: 'Test',
                surname: 'Utente',
                email: currentUser.email,
                company: 'Test Company'
            };
            
            const emailResult = await sendWelcomeEmail(testStudent);
            hideLoading();
            
            if (emailResult.success) {
                showNotification(`‚úÖ Email di test inviata!\nüìß Controlla ${currentUser.email}`, 'success');
            } else {
                showNotification(`‚ùå Errore: ${emailResult.message}`, 'error');
            }
        }
        
        async function loadEmailJSConfig() {
            try {
                const savedConfig = localStorage.getItem('emailjs_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    emailJSConfig.publicKey = config.publicKey || '';
                    emailJSConfig.serviceId = config.serviceId || '';
                    emailJSConfig.templateId = config.templateId || '';
                    
                    document.getElementById('emailJSPublicKey').value = emailJSConfig.publicKey;
                    document.getElementById('emailJSServiceID').value = emailJSConfig.serviceId;
                    document.getElementById('emailJSTemplateID').value = emailJSConfig.templateId;
                    
                    updateEmailStatusBadge();
                }
            } catch (error) {
                console.warn('Errore caricamento config:', error);
            }
        }
        
        function updateEmailStatusBadge() {
            const badge = document.getElementById('emailStatusBadge');
            if (isEmailJSConfigured()) {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                badge.textContent = '‚úÖ Configurato';
            } else {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                badge.textContent = '‚ùå Non Configurato';
            }
        }

        // ==========================================
        // ADMIN FUNCTIONS
        // ==========================================
        function showAdminTab(tab) {
            document.getElementById('studentsSection').classList.add('hidden');
            document.getElementById('coursesSection').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            
            document.getElementById('studentsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('coursesTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('reportsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('settingsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            
            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById(tab + 'Tab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-blue-600 shadow-sm';
            
            if (tab === 'reports') {
                updateStats();
            }
            
            if (tab === 'settings') {
                updateEmailStatusBadge();
                document.getElementById('sheetsUrlDisplay').textContent = GOOGLE_SHEETS_URL.substring(0, 80) + '...';
            }
        }

        function loadStudents() {
            const tbody = document.getElementById('studentsTable');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Nessuno studente presente. Aggiungi il primo studente o carica un file Excel!</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${student.name} ${student.surname}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.email}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.company}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${student.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${student.status === 'active' ? 'Attivo' : 'Inattivo'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addStudent(event) {
            event.preventDefault();
            const name = document.getElementById('studentName').value;
            const surname = document.getElementById('studentSurname').value;
            const email = document.getElementById('studentEmail').value;
            const phone = document.getElementById('studentPhone').value;
            const company = document.getElementById('studentCompany').value;
            
            const newStudent = {
                id: Date.now().toString(),
                name,
                surname,
                email,
                phone,
                company,
                status: 'active',
                registrationDate: new Date().toISOString()
            };
            
            const result = await writeToSheets('Studenti', 'create', newStudent);
            
            if (result) {
                students.push(newStudent);
                loadStudents();
                hideModal('addStudentModal');
                
                showLoading('Invio email di benvenuto...');
                const emailResult = await sendWelcomeEmail(newStudent);
                hideLoading();
                
                if (emailResult.success) {
                    showNotification(`‚úÖ Studente "${name} ${surname}" aggiunto!\nüìß Email inviata a ${email}`, 'success');
                } else {
                    showNotification(`‚úÖ Studente "${name} ${surname}" aggiunto!\n‚ö†Ô∏è Errore email: ${emailResult.message}`, 'success');
                }
                
                document.getElementById('studentName').value = '';
                document.getElementById('studentSurname').value = '';
                document.getElementById('studentEmail').value = '';
                document.getElementById('studentPhone').value = '';
                document.getElementById('studentCompany').value = '';
            }
        }

        async function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const confirmDelete = () => {
                executeDelete();
                cleanup();
            };
            
            const cancelDelete = () => {
                cleanup();
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
                confirmBtn.removeEventListener('click', confirmDelete);
                document.removeEventListener('click', cancelDelete);
            };
            
            const executeDelete = async () => {
                const result = await writeToSheets('Studenti', 'delete', { id });
                
                if (result) {
                    students = students.filter(s => s.id !== id);
                    loadStudents();
                    showNotification(`‚úÖ Studente "${student.name} ${student.surname}" eliminato!`, 'success');
                }
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', confirmDelete);
                setTimeout(() => {
                    document.addEventListener('click', cancelDelete, { once: true });
                }, 100);
            }, 0);
        }

        function loadCourses() {
            const container = document.getElementById('coursesList');
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun corso presente. Crea il primo corso!</p>';
                return;
            }
            
            container.innerHTML = courses.map(course => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${course.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${course.description}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-xs px-2 py-1 rounded-full ${course.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${course.status === 'published' ? '‚úÖ Pubblicato' : 'ÔøΩÔøΩ Bozza'}
                                </span>
                                ${course.hasTest === 'true' || course.hasTest === true ? '<span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full">Con Test</span>' : ''}
                            </div>
                        </div>
                        <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        async function addCourse(event) {
            event.preventDefault();
            const title = document.getElementById('courseTitle').value;
            const description = document.getElementById('courseDescription').value;
            const hasTest = document.getElementById('courseHasTest').checked;
            
            const newCourse = {
                id: Date.now().toString(),
                title,
                description,
                hasTest: hasTest.toString(),
                status: 'published',
                modules: '[]',
                createdDate: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            const result = await writeToSheets('Corsi', 'create', newCourse);
            
            if (result) {
                courses.push(newCourse);
                loadCourses();
                hideModal('addCourseModal');
                showNotification(`‚úÖ Corso "${title}" creato!`, 'success');
                
                document.getElementById('courseTitle').value = '';
                document.getElementById('courseDescription').value = '';
                document.getElementById('courseHasTest').checked = false;
            }
        }

        async function deleteCourse(id) {
            const course = courses.find(c => c.id === id);
            if (!course) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const confirmDelete = () => {
                executeDelete();
                cleanup();
            };
            
            const cancelDelete = () => {
                cleanup();
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
                confirmBtn.removeEventListener('click', confirmDelete);
                document.removeEventListener('click', cancelDelete);
            };
            
            const executeDelete = async () => {
                const result = await writeToSheets('Corsi', 'delete', { id });
                
                if (result) {
                    courses = courses.filter(c => c.id !== id);
                    loadCourses();
                    showNotification(`‚úÖ Corso "${course.title}" eliminato!`, 'success');
                }
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', confirmDelete);
                setTimeout(() => {
                    document.addEventListener('click', cancelDelete, { once: true });
                }, 100);
            }, 0);
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalCourses').textContent = courses.filter(c => c.status === 'published').length;
            
            const completions = progressData.filter(p => p.completed === 'true' || p.completed === true).length;
            document.getElementById('totalCompletions').textContent = completions;
        }

        // ==========================================
        // STUDENT FUNCTIONS
        // ==========================================
        async function loadStudentCourses() {
            const container = document.getElementById('studentCoursesList');
            
            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-gray-400 text-2xl">üìö</span>
                        </div>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">Nessun corso disponibile</h3>
                        <p class="text-gray-500">Al momento non ci sono corsi pubblicati.</p>
                    </div>
                `;
                return;
            }
            
            const publishedCourses = courses.filter(c => c.status === 'published');
            
            container.innerHTML = publishedCourses.map(course => `
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${course.title}</h3>
                    <p class="text-sm text-gray-600 mb-4">${course.description}</p>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Inizia Corso
                    </button>
                </div>
            `).join('');
        }

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            showAdminTab('students');
            console.log('üöÄ Piattaforma caricata');
            console.log('üîó Google Sheets URL:', GOOGLE_SHEETS_URL);
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a51212945809a1f',t:'MTc2NDI0MTMwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
