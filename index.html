<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduPlatform - Versione Supabase</title>
  <script src="https://cdn.tailwindcss.com/3.3.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script><!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-full"><!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-white text-lg" id="loadingText">Caricamento...</p>
    <p class="text-white text-sm mt-2 opacity-75" id="loadingSubtext">Attendere prego...</p>
   </div>
  </div><!-- Supabase Configuration Modal -->
  <div id="supabaseConfigModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-8">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">‚ö°</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-800">Configura Supabase</h2>
      <p class="text-gray-600 mt-2">Solo 2 credenziali - Setup in 5 minuti!</p>
     </div>
     <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-green-900 mb-2">üìã Come ottenere le credenziali:</h3>
      <ol class="text-sm text-green-800 space-y-1 ml-4">
       <li>1. Vai su <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" class="underline font-medium">supabase.com</a> e crea account gratis</li>
       <li>2. Clicca <strong>"New Project"</strong></li>
       <li>3. Scegli nome progetto (es: "eduplatform") e password database</li>
       <li>4. Vai su <strong>"Settings"</strong> ‚Üí <strong>"API"</strong></li>
       <li>5. Copia <code class="bg-green-100 px-1 rounded">Project URL</code> e <code class="bg-green-100 px-1 rounded">anon public</code> key</li>
      </ol>
     </div>
     <form onsubmit="saveSupabaseConfig(event)" class="space-y-4">
      <div><label for="supabaseUrl" class="block text-sm font-medium text-gray-700 mb-1">Project URL</label> <input type="url" id="supabaseUrl" required placeholder="https://tuoprogetto.supabase.co" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
       <p class="text-xs text-gray-500 mt-1">Es: https://xyzabcdef.supabase.co</p>
      </div>
      <div><label for="supabaseKey" class="block text-sm font-medium text-gray-700 mb-1">Anon Public Key</label> <textarea id="supabaseKey" required placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
       <p class="text-xs text-gray-500 mt-1">La chiave pubblica √® sicura da condividere</p>
      </div>
      <div class="flex space-x-3 pt-4"><button type="submit" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"> ‚ö° Connetti Supabase </button>
      </div>
     </form>
     <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-xs text-blue-800">üí° <strong>Dopo aver connesso:</strong> Tornerai qui per creare automaticamente le tabelle del database.</p>
     </div>
    </div>
   </div>
  </div><!-- Database Setup Modal -->
  <div id="dbSetupModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="p-8">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">üóÑÔ∏è</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Inizializza Database</h2>
      <p class="text-gray-600 mt-2">Crea le tabelle necessarie per la piattaforma</p>
     </div>
     <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-yellow-800">‚ö†Ô∏è Questa operazione va fatta <strong>solo la prima volta</strong>. Crea 4 tabelle: students, courses, progress, enrollments.</p>
     </div><button onclick="initializeDatabase()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold"> üöÄ Crea Tabelle </button> <button onclick="skipDatabaseSetup()" class="w-full mt-3 text-gray-600 hover:text-gray-800 text-sm"> Salta (gi√† fatto) </button>
    </div>
   </div>
  </div><!-- Navigation -->
  <nav class="bg-white shadow-lg border-b-4 border-green-500">
   <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center py-4">
     <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-lg">üéì</span>
      </div>
      <div>
       <h1 class="text-2xl font-bold text-gray-800">EduPlatform <span class="text-sm text-green-600">‚ö°</span></h1>
      </div>
     </div>
     <div class="flex items-center space-x-4"><span id="currentUser" class="text-gray-600 font-medium"></span> <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"> Logout </button>
     </div>
    </div>
   </div>
  </nav><!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">üéì</span>
     </div>
     <h2 class="text-3xl font-bold text-gray-800">Accedi alla Piattaforma</h2>
     <p class="text-gray-600 mt-2">Database Supabase ‚ö°</p>
    </div>
    <form onsubmit="login(event)" class="space-y-6">
     <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
     </div>
     <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
     </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors"> Accedi </button>
    </form>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
     <p class="text-sm text-gray-600 mb-2"><strong>Credenziali Demo:</strong></p>
     <p class="text-xs text-gray-500">Admin: admin@edu.com / admin123</p>
     <p class="text-xs text-gray-500">Studente: studente@edu.com / student123</p>
    </div>
    #<div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
     #<p class="text-xs text-green-800">‚ö° <strong>Supabase:</strong> PostgreSQL in cloud, pi√π semplice di Firebase!</p>
    #</div>
   </div>
  </div><!-- Account Activation Screen -->
  <div id="activationScreen" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">üîê</span>
     </div>
     <h2 class="text-3xl font-bold text-gray-800">Crea la tua Password</h2>
     <p class="text-gray-600 mt-2">Benvenuto! Imposta la password per il tuo account</p>
    </div>
    <div id="activationInfo" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
     <p class="text-sm text-green-800"><strong>Email:</strong> <span id="activationEmail"></span></p>
     <p class="text-sm text-green-800 mt-1"><strong>Nome:</strong> <span id="activationName"></span></p>
    </div>
    <form onsubmit="activateAccount(event)" class="space-y-6">
     <div><label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Nuova Password</label> <input type="password" id="newPassword" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Minimo 8 caratteri">
      <p class="text-xs text-gray-500 mt-1">La password deve contenere almeno 8 caratteri</p>
     </div>
     <div><label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Conferma Password</label> <input type="password" id="confirmPassword" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ripeti la password">
     </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors"> üîê Attiva Account </button>
    </form>
   </div>
  </div><!-- Main Dashboard -->
  <div id="dashboard" class="hidden"><!-- Admin Dashboard -->
   <div id="adminDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Amministratore</h2>
     <p class="text-gray-600">Gestisci studenti e corsi - Database Supabase ‚ö°</p>
    </div><!-- Admin Navigation Tabs -->
    <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg"><button onclick="showAdminTab('students')" id="studentsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-green-600 shadow-sm"> üë• Gestione Studenti </button> <button onclick="showAdminTab('courses')" id="coursesTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> üìö Gestione Corsi </button> <button onclick="showAdminTab('reports')" id="reportsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> üìä Report </button> <button onclick="showAdminTab('settings')" id="settingsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> ‚öôÔ∏è Impostazioni </button>
    </div><!-- Students Management -->
    <div id="studentsSection" class="fade-in">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Studenti</h3>
       <div class="flex space-x-3"><button onclick="downloadExcelTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> üì• Scarica Template </button> <button onclick="document.getElementById('excelUpload').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> üì§ Carica Excel </button> <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)" class="hidden"> <button onclick="showModal('addStudentModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> ‚ûï Aggiungi Singolo </button>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gray-50">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nome</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azienda</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Corsi</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ruolo</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Stato</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azioni</th>
         </tr>
        </thead>
        <tbody id="studentsTable" class="divide-y divide-gray-200">
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Courses Management -->
    <div id="coursesSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Corsi</h3><button onclick="showModal('addCourseModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> ‚ûï Crea Corso </button>
      </div>
      <div id="coursesList" class="space-y-4">
      </div>
     </div>
    </div><!-- Reports Section -->
    <div id="reportsSection" class="hidden">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Studenti Totali</p>
         <p id="totalStudents" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><span class="text-green-600 text-xl">üë•</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Corsi Attivi</p>
         <p id="totalCourses" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><span class="text-blue-600 text-xl">üìö</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Completamenti</p>
         <p id="totalCompletions" class="text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><span class="text-purple-600 text-xl">üèÜ</span>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Settings Section -->
    <div id="settingsSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">‚öôÔ∏è Configurazione Piattaforma</h3><!-- EmailJS Configuration -->
      <div class="border-b border-gray-200 pb-6 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h4 class="text-lg font-medium text-gray-800">üìß Configurazione EmailJS</h4>
         <p class="text-sm text-gray-600 mt-1">Imposta le credenziali per l'invio automatico delle email</p>
        </div>
        <div id="emailStatusBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
         ‚ùå Non Configurato
        </div>
       </div>
       <form onsubmit="saveEmailJSConfig(event)" class="space-y-4">
        <div><label for="emailJSPublicKey" class="block text-sm font-medium text-gray-700 mb-2">Public Key</label> <input type="text" id="emailJSPublicKey" placeholder="es: xYz123AbC456" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div><label for="emailJSServiceID" class="block text-sm font-medium text-gray-700 mb-2">Service ID</label> <input type="text" id="emailJSServiceID" placeholder="es: service_abc123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div><label for="emailJSTemplateID" class="block text-sm font-medium text-gray-700 mb-2">Template ID</label> <input type="text" id="emailJSTemplateID" placeholder="es: template_xyz789" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div class="flex space-x-3"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> üíæ Salva Configurazione </button> <button type="button" onclick="testEmailJSConfig()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium"> üß™ Test Email </button>
        </div>
       </form>
      </div><!-- Supabase Info -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border-2 border-green-200">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h3 class="text-xl font-semibold text-gray-800 mb-1">‚ö° Supabase Database</h3>
         <p class="text-sm text-gray-600">PostgreSQL in cloud - Pi√π semplice di Firebase</p>
        </div>
        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center"><span class="text-white text-xl">‚úÖ</span>
        </div>
       </div>
       <div class="space-y-3">
        <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
         <p class="text-sm text-gray-700 font-medium mb-2">üéØ Vantaggi Supabase:</p>
         <ul class="text-xs text-gray-600 space-y-1 ml-4">
          <li>‚úÖ <strong>Setup veloce</strong> - Solo 2 credenziali</li>
          <li>‚úÖ <strong>PostgreSQL</strong> - Database professionale</li>
          <li>‚úÖ <strong>Dashboard intuitiva</strong> - Visualizza dati facilmente</li>
          <li>‚úÖ <strong>Gratis</strong> - 500 MB storage + 2 GB bandwidth</li>
         </ul>
        </div><button onclick="showModal('supabaseConfigModal')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> üîß Riconfigura Supabase </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Student Dashboard -->
   <div id="studentDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">I Miei Corsi</h2>
     <p class="text-gray-600">Accedi ai tuoi corsi - Sincronizzato con Supabase ‚ö°</p>
    </div>
    <div id="studentCoursesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    </div>
   </div>
  </div><!-- Add Student Modal -->
  <div id="addStudentModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Studente</h3><button onclick="hideModal('addStudentModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <form onsubmit="addStudent(event)" class="space-y-4">
      <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label> <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentSurname" class="block text-sm font-medium text-gray-700 mb-1">Cognome</label> <input type="text" id="studentSurname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="studentEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefono</label> <input type="tel" id="studentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentCompany" class="block text-sm font-medium text-gray-700 mb-1">Azienda</label> <input type="text" id="studentCompany" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentRole" class="block text-sm font-medium text-gray-700 mb-1">Ruolo</label> <select id="studentRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"> <option value="student">üë§ Studente</option> <option value="admin">üëë Amministratore</option> </select>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addStudentModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Assign Courses Modal -->
  <div id="assignCoursesModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <div>
       <h3 class="text-xl font-semibold text-gray-800">Assegna Corsi</h3>
       <p class="text-sm text-gray-600 mt-1" id="assignStudentName"></p>
      </div><button onclick="hideModal('assignCoursesModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <div class="mb-4">
      <p class="text-sm font-medium text-gray-700 mb-3">Seleziona i corsi da assegnare:</p>
      <div id="coursesCheckboxList" class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4">
      </div>
     </div>
     <div class="flex space-x-3 pt-4"><button onclick="hideModal('assignCoursesModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button onclick="saveCoursesAssignment()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> üíæ Salva Assegnazioni </button>
     </div>
    </div>
   </div>
  </div><!-- Add Course Modal -->
  <div id="addCourseModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Crea Nuovo Corso</h3><button onclick="hideModal('addCourseModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <form onsubmit="addCourse(event)" class="space-y-4">
      <div><label for="courseTitle" class="block text-sm font-medium text-gray-700 mb-1">Titolo del Corso</label> <input type="text" id="courseTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="courseDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label> <textarea id="courseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
      </div>
      <div class="flex items-center space-x-2"><input type="checkbox" id="courseHasCertificate" class="rounded" checked> <label for="courseHasCertificate" class="text-sm font-medium text-gray-700">Rilascia certificato finale</label>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addCourseModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> Crea Corso </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Course Editor Modal -->
  <div id="courseEditorModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <div>
       <h3 class="text-2xl font-semibold text-gray-800" id="editorCourseTitle"></h3>
       <p class="text-sm text-gray-600 mt-1">Gestisci moduli, contenuti e test</p>
      </div><button onclick="hideModal('courseEditorModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <div class="flex space-x-6"><!-- Left: Modules List -->
      <div class="w-1/3 border-r border-gray-200 pr-6">
       <div class="flex justify-between items-center mb-4">
        <h4 class="font-semibold text-gray-800">üìö Moduli</h4><button onclick="addModule()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm"> ‚ûï Modulo </button>
       </div>
       <div id="modulesList" class="space-y-2 max-h-96 overflow-y-auto">
       </div>
      </div><!-- Right: Module Editor -->
      <div class="flex-1">
       <div id="moduleEditorEmpty" class="text-center py-12 text-gray-500">
        <p class="text-lg">ÔøΩÔøΩ Seleziona o crea un modulo per iniziare</p>
       </div>
       <div id="moduleEditorContent" class="hidden">
        <div class="mb-6"><label for="moduleTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo Modulo</label> <input type="text" id="moduleTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        <div class="mb-6"><label for="moduleDescription" class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label> <textarea id="moduleDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
        </div><!-- Media Section -->
        <div class="mb-6">
         <div class="flex justify-between items-center mb-3">
          <h5 class="font-semibold text-gray-800">üé¨ Contenuti Media</h5><button onclick="addMedia()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm"> ‚ûï Media </button>
         </div>
         <div id="mediaList" class="space-y-2">
         </div>
        </div><!-- Test Section -->
        <div class="mb-6">
         <div class="flex justify-between items-center mb-3">
          <h5 class="font-semibold text-gray-800">üìù Test Fine Modulo</h5><button onclick="toggleModuleTest()" id="toggleTestBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg text-sm"> ‚ûï Aggiungi Test </button>
         </div>
         <div id="testSection" class="hidden">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
           <div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-1">Punteggio Minimo (%)</label> <input type="number" id="testMinScore" min="0" max="100" value="70" class="w-32 px-3 py-2 border border-gray-300 rounded-lg">
           </div><button onclick="manageQuestions()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm"> üìã Gestisci Domande </button> <span id="questionCount" class="ml-3 text-sm text-gray-600">0 domande</span>
          </div>
         </div>
        </div>
        <div class="flex space-x-3 pt-4 border-t border-gray-200"><button onclick="saveModule()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"> üíæ Salva Modulo </button> <button onclick="deleteModule()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"> üóëÔ∏è Elimina </button>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Add Media Modal -->
  <div id="addMediaModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Media</h3><button onclick="hideModal('addMediaModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div>
     <form onsubmit="saveMedia(event)" class="space-y-4">
      <div><label for="mediaType" class="block text-sm font-medium text-gray-700 mb-2">Tipo Media</label> <select id="mediaType" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="updateMediaForm()"> <option value="video">üé• Video (YouTube, Vimeo)</option> <option value="pdf">üìÑ PDF</option> <option value="link">üîó Link Esterno</option> <option value="text">üìù Testo/Articolo</option> </select>
      </div>
      <div><label for="mediaTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo</label> <input type="text" id="mediaTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
      </div>
      <div id="mediaUrlField"><label for="mediaUrl" class="block text-sm font-medium text-gray-700 mb-2">URL</label> <input type="url" id="mediaUrl" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://">
      </div>
      <div id="mediaTextField" class="hidden"><label for="mediaText" class="block text-sm font-medium text-gray-700 mb-2">Contenuto</label> <textarea id="mediaText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addMediaModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Questions Manager Modal -->
  <div id="questionsModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Gestione Domande Test</h3><button onclick="hideModal('questionsModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">√ó</span> </button>
     </div><button onclick="addQuestion()" class="mb-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg"> ‚ûï Nuova Domanda </button>
     <div id="questionsList" class="space-y-4">
     </div>
     <div class="flex justify-end pt-4 border-t border-gray-200 mt-6"><button onclick="hideModal('questionsModal')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg"> ‚úÖ Fatto </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // ==========================================
        // SUPABASE CONFIGURATION & INITIALIZATION
        // ==========================================
        
        // üî• INSERISCI QUI LE TUE CREDENZIALI SUPABASE
        const SUPABASE_CONFIG = {
            url: 'https://tuoprogetto.supabase.co',  // ‚ö†Ô∏è SOSTITUISCI CON IL TUO PROJECT URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // ‚ö†Ô∏è SOSTITUISCI CON LA TUA ANON PUBLIC KEY
        };
        
        let supabase = null;
        let allStudents = [];
        let allCourses = [];
        let allProgress = [];
        let allEnrollments = [];
        let currentUser = null;
        let currentAssigningStudent = null;

        function loadSupabaseConfig() {
            // Prima controlla se ci sono credenziali hardcoded valide
            if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.key && 
                SUPABASE_CONFIG.url !== 'https://tuoprogetto.supabase.co' &&
                SUPABASE_CONFIG.key.length > 50) {
                return SUPABASE_CONFIG;
            }
            
            // Altrimenti cerca nel localStorage (per compatibilit√†)
            const savedConfig = localStorage.getItem('supabase_config');
            if (savedConfig) {
                return JSON.parse(savedConfig);
            }
            return null;
        }

        function saveSupabaseConfig(event) {
            event.preventDefault();
            
            const config = {
                url: document.getElementById('supabaseUrl').value.trim(),
                key: document.getElementById('supabaseKey').value.trim()
            };
            
            localStorage.setItem('supabase_config', JSON.stringify(config));
            hideModal('supabaseConfigModal');
            showNotification('‚úÖ Configurazione salvata! Ricarica la pagina.', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function initSupabase() {
            const config = loadSupabaseConfig();
            
            if (!config) {
                // Controlla se siamo in un link di attivazione
                const urlParams = new URLSearchParams(window.location.search);
                const isActivationLink = urlParams.get('action') === 'activate';
                
                if (isActivationLink) {
                    // Link di attivazione: mostra istruzioni per configurare Supabase
                    console.log('üîó Link attivazione senza config Supabase');
                    showActivationConfigNeeded();
                    return false;
                } else {
                    // Amministratore: chiedi configurazione
                    showModal('supabaseConfigModal');
                    return false;
                }
            }
            
            try {
                // Crea client Supabase
                supabase = window.supabase.createClient(config.url, config.key);
                console.log('‚úÖ Supabase connesso');
                
                // Carica dati in background (non blocca)
                loadAllData().catch(err => {
                    console.warn('‚ö†Ô∏è Database vuoto:', err.message);
                });
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore Supabase:', error);
                showNotification(`‚ùå Errore: ${error.message}`, 'error');
                return false;
            }
        }

        function showActivationConfigNeeded() {
            document.getElementById('loginScreen').classList.remove('hidden');
            
            const instructionDiv = document.createElement('div');
            instructionDiv.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
            instructionDiv.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl">‚ö†Ô∏è</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Configurazione Mancante</h2>
                        <p class="text-gray-600 mt-2">Per attivare il tuo account, l'amministratore deve configurare prima la piattaforma.</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-blue-900 mb-3"><strong>üìß Cosa fare:</strong></p>
                        <ol class="text-xs text-blue-800 space-y-2 ml-4">
                            <li><strong>1.</strong> Contatta l'amministratore della piattaforma</li>
                            <li><strong>2.</strong> Chiedi di configurare Supabase</li>
                            <li><strong>3.</strong> Clicca di nuovo sul link che hai ricevuto via email</li>
                        </ol>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600">üí° <strong>Per gli amministratori:</strong> Apri la piattaforma normalmente e configura Supabase nelle impostazioni, poi gli studenti potranno attivare i loro account.</p>
                    </div>
                    
                    <button onclick="window.location.reload()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold">
                        üîÑ Ricarica Pagina
                    </button>
                </div>
            `;
            
            document.body.appendChild(instructionDiv);
        }

        async function initializeDatabase() {
            showLoading('Creazione tabelle...');
            
            try {
                const { data: existingStudents, error: studentsCheckError } = await supabase
                    .from('students')
                    .select('id')
                    .limit(1);
                
                if (!studentsCheckError) {
                    localStorage.setItem('supabase_db_setup_done', 'true');
                    hideLoading();
                    hideModal('dbSetupModal');
                    showNotification('‚úÖ Database gi√† inizializzato!', 'success');
                    
                    await loadAllData();
                    return;
                }
                
                hideLoading();
                hideModal('dbSetupModal');
                
                const instructionsModal = document.createElement('div');
                instructionsModal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
                instructionsModal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-full overflow-y-auto p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">üìã Crea le Tabelle in Supabase</h2>
                        <p class="text-gray-600 mb-4">Segui questi passaggi nella dashboard di Supabase:</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <ol class="text-sm text-gray-800 space-y-2 ml-4">
                                <li><strong>1.</strong> Vai su <a href="https://app.supabase.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">app.supabase.com</a></li>
                                <li><strong>2.</strong> Seleziona il tuo progetto</li>
                                <li><strong>3.</strong> Clicca su "SQL Editor" nel menu laterale</li>
                                <li><strong>4.</strong> Copia e incolla questo codice SQL:</li>
                            </ol>
                        </div>
                        
                        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mb-4 overflow-x-auto">
                            <pre class="text-xs"><code>-- Tabella Studenti
CREATE TABLE students (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  surname TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  company TEXT NOT NULL,
  role TEXT DEFAULT 'student',
  status TEXT DEFAULT 'active',
  password TEXT,
  registration_date TIMESTAMP DEFAULT NOW()
);

-- Tabella Corsi (con moduli in JSONB)
CREATE TABLE courses (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  has_certificate BOOLEAN DEFAULT false,
  modules JSONB DEFAULT '[]'::jsonb,
  status TEXT DEFAULT 'published',
  created_date TIMESTAMP DEFAULT NOW(),
  created_by TEXT
);

-- Tabella Progressi (con progresso moduli in JSONB)
CREATE TABLE progress (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  completed BOOLEAN DEFAULT false,
  completed_modules INTEGER DEFAULT 0,
  module_progress JSONB DEFAULT '{}'::jsonb,
  completion_date TIMESTAMP,
  score INTEGER
);

-- Tabella Iscrizioni (enrollments) ‚≠ê NUOVO!
CREATE TABLE enrollments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  enrolled_date TIMESTAMP DEFAULT NOW(),
  assigned_by TEXT,
  UNIQUE(student_id, course_id)
);

-- Abilita Row Level Security (importante!)
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;

-- Policy per permettere tutte le operazioni (per ora)
CREATE POLICY "Enable all for students" ON students FOR ALL USING (true);
CREATE POLICY "Enable all for courses" ON courses FOR ALL USING (true);
CREATE POLICY "Enable all for progress" ON progress FOR ALL USING (true);
CREATE POLICY "Enable all for enrollments" ON enrollments FOR ALL USING (true);

-- Indici per query veloci
CREATE INDEX idx_enrollments_student ON enrollments(student_id);
CREATE INDEX idx_enrollments_course ON enrollments(course_id);</code></pre>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-sm text-yellow-800 font-semibold mb-2">‚ö†Ô∏è Se hai gi√† creato le tabelle prima:</p>
                            <p class="text-xs text-yellow-700 mb-2">Esegui SOLO queste righe per aggiungere la tabella enrollments:</p>
                            <div class="bg-gray-900 text-gray-100 p-3 rounded mt-2 overflow-x-auto">
                                <pre class="text-xs"><code>-- Aggiungi tabella enrollments (se altre tabelle gi√† esistono)
CREATE TABLE IF NOT EXISTS enrollments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  enrolled_date TIMESTAMP DEFAULT NOW(),
  assigned_by TEXT,
  UNIQUE(student_id, course_id)
);

ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for enrollments" ON enrollments FOR ALL USING (true);
CREATE INDEX idx_enrollments_student ON enrollments(student_id);
CREATE INDEX idx_enrollments_course ON enrollments(course_id);</code></pre>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-yellow-800">‚ö†Ô∏è <strong>Importante:</strong> Dopo aver eseguito il codice SQL, clicca "Fatto" qui sotto.</p>
                        </div>
                        
                        <button onclick="completeDatabaseSetup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold">
                            ‚úÖ Fatto - Ho creato le tabelle
                        </button>
                    </div>
                `;
                
                document.body.appendChild(instructionsModal);
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function completeDatabaseSetup() {
            const modal = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            
            showLoading('Verifica tabelle...');
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    hideLoading();
                    showNotification('‚ùå Tabelle non trovate. Verifica di aver eseguito il codice SQL correttamente.', 'error');
                    return;
                }
                
                localStorage.setItem('supabase_db_setup_done', 'true');
                
                await loadAllData();
                
                hideLoading();
                showNotification('‚úÖ Database pronto! Piattaforma operativa.', 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore verifica: ' + error.message, 'error');
            }
        }

        function skipDatabaseSetup() {
            localStorage.setItem('supabase_db_setup_done', 'true');
            hideModal('dbSetupModal');
            
            loadAllData().catch(() => {
                console.log('DB vuoto');
            });
        }

        async function loadAllData() {
            try {
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('registration_date', { ascending: false });
                
                if (studentsError) throw studentsError;
                allStudents = students || [];
                
                const { data: courses, error: coursesError } = await supabase
                    .from('courses')
                    .select('*')
                    .order('created_date', { ascending: false });
                
                if (coursesError) throw coursesError;
                allCourses = courses || [];
                
                const { data: progress, error: progressError } = await supabase
                    .from('progress')
                    .select('*');
                
                if (progressError) throw progressError;
                allProgress = progress || [];
                
                const { data: enrollments, error: enrollmentsError } = await supabase
                    .from('enrollments')
                    .select('*');
                
                if (enrollmentsError) throw enrollmentsError;
                allEnrollments = enrollments || [];
                
                console.log('üìä Dati caricati:', allStudents.length, 'studenti,', allCourses.length, 'corsi,', allEnrollments.length, 'iscrizioni');
                
            } catch (error) {
                console.error('‚ùå Errore caricamento dati:', error);
                throw error;
            }
        }

        // ==========================================
        // ENROLLMENT MANAGEMENT
        // ==========================================

        function getStudentEnrolledCourses(studentId) {
            return allEnrollments
                .filter(e => e.student_id === studentId)
                .map(e => e.course_id);
        }

        function getStudentEnrollmentCount(studentId) {
            return allEnrollments.filter(e => e.student_id === studentId).length;
        }

        function openAssignCoursesModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            currentAssigningStudent = student;
            document.getElementById('assignStudentName').textContent = `${student.name} ${student.surname}`;
            
            const enrolledCourseIds = getStudentEnrolledCourses(studentId);
            
            const checkboxList = document.getElementById('coursesCheckboxList');
            
            if (allCourses.length === 0) {
                checkboxList.innerHTML = '<p class="text-gray-500 text-center py-4">Nessun corso disponibile</p>';
            } else {
                checkboxList.innerHTML = allCourses.map(course => {
                    const isEnrolled = enrolledCourseIds.includes(course.id);
                    return `
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" 
                                   class="course-checkbox rounded" 
                                   data-course-id="${course.id}" 
                                   ${isEnrolled ? 'checked' : ''}>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${course.title}</p>
                                <p class="text-xs text-gray-500">${course.description || ''}</p>
                            </div>
                        </label>
                    `;
                }).join('');
            }
            
            showModal('assignCoursesModal');
        }

        async function saveCoursesAssignment() {
            if (!currentAssigningStudent) return;
            
            showLoading('Salvat aggio iscrizioni...');
            
            const checkboxes = document.querySelectorAll('.course-checkbox');
            const selectedCourseIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.courseId);
            
            const currentEnrollments = allEnrollments.filter(e => e.student_id === currentAssigningStudent.id);
            const currentCourseIds = currentEnrollments.map(e => e.course_id);
            
            // Corsi da aggiungere
            const toAdd = selectedCourseIds.filter(id => !currentCourseIds.includes(id));
            // Corsi da rimuovere
            const toRemove = currentCourseIds.filter(id => !selectedCourseIds.includes(id));
            
            try {
                // Aggiungi nuove iscrizioni
                if (toAdd.length > 0) {
                    const newEnrollments = toAdd.map(courseId => ({
                        student_id: currentAssigningStudent.id,
                        course_id: courseId,
                        enrolled_date: new Date().toISOString()
                    }));
                    
                    const { data, error } = await supabase
                        .from('enrollments')
                        .insert(newEnrollments)
                        .select();
                    
                    if (error) throw error;
                    
                    allEnrollments.push(...data);
                }
                
                // Rimuovi iscrizioni
                if (toRemove.length > 0) {
                    const enrollmentsToDelete = currentEnrollments.filter(e => toRemove.includes(e.course_id));
                    
                    for (const enrollment of enrollmentsToDelete) {
                        const { error } = await supabase
                            .from('enrollments')
                            .delete()
                            .eq('id', enrollment.id);
                        
                        if (error) throw error;
                        
                        allEnrollments = allEnrollments.filter(e => e.id !== enrollment.id);
                    }
                }
                
                hideLoading();
                hideModal('assignCoursesModal');
                loadStudents();
                showNotification(`‚úÖ Iscrizioni aggiornate!\n${toAdd.length} corsi aggiunti, ${toRemove.length} rimossi.`, 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // EMAILJS FUNCTIONS
        // ==========================================

        let emailJSConfig = {
            publicKey: '',
            serviceId: '',
            templateId: ''
        };

        function initEmailJS() {
            if (typeof emailjs !== 'undefined' && emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId) {
                emailjs.init(emailJSConfig.publicKey);
                return true;
            }
            return false;
        }

        function isEmailJSConfigured() {
            return emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId;
        }

        function generateActivationToken(studentId, email) {
            const timestamp = Date.now();
            const data = `${studentId}-${email}-${timestamp}`;
            return btoa(data);
        }

        async function sendWelcomeEmail(student) {
            if (!initEmailJS()) {
                console.warn('EmailJS non configurato.');
                return { success: false, message: 'EmailJS non configurato' };
            }

            try {
                const activationToken = generateActivationToken(student.id, student.email);
                const activationLink = `${window.location.origin}${window.location.pathname}?action=activate&token=${activationToken}&id=${student.id}`;

                const templateParams = {
                    student_name: `${student.name} ${student.surname}`,
                    student_email: student.email,
                    activation_link: activationLink,
                    platform_name: 'EduPlatform',
                    company_name: student.company
                };

                const response = await emailjs.send(
                    emailJSConfig.serviceId,
                    emailJSConfig.templateId,
                    templateParams
                );

                return { success: true, message: 'Email inviata' };

            } catch (error) {
                console.error('‚ùå Errore invio email:', error);
                return { success: false, message: error.text || error.message };
            }
        }

        async function saveEmailJSConfig(event) {
            event.preventDefault();
            
            const publicKey = document.getElementById('emailJSPublicKey').value.trim();
            const serviceId = document.getElementById('emailJSServiceID').value.trim();
            const templateId = document.getElementById('emailJSTemplateID').value.trim();
            
            if (!publicKey || !serviceId || !templateId) {
                showNotification('‚ö†Ô∏è Compila tutti i campi!', 'error');
                return;
            }
            
            emailJSConfig.publicKey = publicKey;
            emailJSConfig.serviceId = serviceId;
            emailJSConfig.templateId = templateId;
            
            try {
                localStorage.setItem('emailjs_config', JSON.stringify(emailJSConfig));
                updateEmailStatusBadge();
                showNotification('‚úÖ Configurazione EmailJS salvata!', 'success');
            } catch (error) {
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function testEmailJSConfig() {
            if (!isEmailJSConfigured()) {
                showNotification('‚ö†Ô∏è Configura EmailJS prima di testare!', 'error');
                return;
            }
            
            showLoading('Invio email di test...');
            
            const testStudent = {
                id: 'test_' + Date.now(),
                name: 'Test',
                surname: 'Utente',
                email: currentUser.email,
                company: 'Test Company'
            };
            
            const emailResult = await sendWelcomeEmail(testStudent);
            hideLoading();
            
            if (emailResult.success) {
                showNotification(`‚úÖ Email di test inviata a ${currentUser.email}`, 'success');
            } else {
                showNotification(`‚ùå Errore: ${emailResult.message}`, 'error');
            }
        }

        async function loadEmailJSConfig() {
            try {
                const savedConfig = localStorage.getItem('emailjs_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    emailJSConfig = config;
                    
                    document.getElementById('emailJSPublicKey').value = emailJSConfig.publicKey || '';
                    document.getElementById('emailJSServiceID').value = emailJSConfig.serviceId || '';
                    document.getElementById('emailJSTemplateID').value = emailJSConfig.templateId || '';
                    
                    updateEmailStatusBadge();
                }
            } catch (error) {
                console.warn('Errore caricamento config EmailJS:', error);
            }
        }

        function updateEmailStatusBadge() {
            const badge = document.getElementById('emailStatusBadge');
            if (isEmailJSConfigured()) {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                badge.textContent = '‚úÖ Configurato';
            } else {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                badge.textContent = '‚ùå Non Configurato';
            }
        }

        // ==========================================
        // UI HELPER FUNCTIONS
        // ==========================================

        function showLoading(message = 'Caricamento...', subText = 'Attendere...') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            updateLoadingText(message, subText);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingText(mainText, subText = 'Attendere...') {
            const loadingTextEl = document.getElementById('loadingText');
            const loadingSubtextEl = document.getElementById('loadingSubtext');
            if (loadingTextEl) loadingTextEl.textContent = mainText;
            if (loadingSubtextEl) loadingSubtextEl.textContent = subText;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white`;
            notification.style.whiteSpace = 'pre-line';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, type === 'error' ? 10000 : 5000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================

        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value;
            
            if (email === 'admin@edu.com' && password === 'admin123') {
                currentUser = { email, role: 'admin', name: 'Amministratore' };
                document.getElementById('currentUser').textContent = currentUser.name;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadStudents();
                loadCourses();
                updateStats();
                return;
            }
            
            const student = allStudents.find(s => s.email.toLowerCase() === email);
            
            if (!student) {
                showNotification('‚ùå Email non trovata', 'error');
                return;
            }
            
            if (!student.password) {
                showNotification('‚ö†Ô∏è Account non attivato!\nControlla la tua email.', 'error');
                return;
            }
            
            if (student.password !== password) {
                showNotification('‚ùå Password errata', 'error');
                return;
            }
            
            currentUser = { 
                email: student.email, 
                role: student.role || 'student', 
                name: `${student.name} ${student.surname}`,
                studentId: student.id
            };
            
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadStudents();
                loadCourses();
                updateStats();
            } else {
                document.getElementById('studentDashboard').classList.remove('hidden');
                loadStudentCourses();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // ==========================================
        // STUDENT MANAGEMENT
        // ==========================================

        function loadStudents() {
            const tbody = document.getElementById('studentsTable');
            if (allStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nessuno studente presente</td></tr>';
                return;
            }
            
            tbody.innerHTML = allStudents.map(student => {
                const enrollmentCount = getStudentEnrollmentCount(student.id);
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${student.name} ${student.surname}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.email}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.company}</td>
                    <td class="px-4 py-3">
                        <button onclick="openAssignCoursesModal('${student.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            üìö ${enrollmentCount} ${enrollmentCount === 1 ? 'corso' : 'corsi'}
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="changeUserRole('${student.id}', this.value)" class="text-xs px-2 py-1 border border-gray-300 rounded-md">
                            <option value="student" ${(student.role || 'student') === 'student' ? 'selected' : ''}>üë§ Studente</option>
                            <option value="admin" ${student.role === 'admin' ? 'selected' : ''}>üëë Admin</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        ${student.password ? 
                            `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">‚úÖ Attivato</span>` : 
                            `<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">‚è≥ Da Attivare</span>`
                        }
                    </td>
                    <td class="px-4 py-3 space-x-2">
                        ${!student.password ? `<button onclick="resendActivationEmail('${student.id}')" class="text-blue-600 hover:text-blue-800 text-sm">üìß Reinvia Email</button>` : ''}
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function addStudent(event) {
            event.preventDefault();

            const name = document.getElementById('studentName').value.trim();
            const surname = document.getElementById('studentSurname').value.trim();
            const email = document.getElementById('studentEmail').value.trim().toLowerCase();
            const phone = document.getElementById('studentPhone').value.trim();
            const company = document.getElementById('studentCompany').value.trim();
            const role = document.getElementById('studentRole').value;

            const duplicate = allStudents.find(s => s.email === email);
            if (duplicate) {
                showNotification('‚ùå Email gi√† registrata!', 'error');
                return;
            }
            
            const newStudent = {
                name,
                surname,
                email,
                phone,
                company,
                role,
                status: 'active',
                password: '',
                registration_date: new Date().toISOString()
            };

            showLoading('Salvataggio studente...');
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .insert([newStudent])
                    .select();
                
                if (error) throw error;
                
                const insertedStudent = data[0];
                allStudents.unshift(insertedStudent);
                
                hideLoading();
                hideModal('addStudentModal');
                loadStudents();
                
                showLoading('Invio email...');
                const emailResult = await sendWelcomeEmail(insertedStudent);
                hideLoading();
                
                if (emailResult.success) {
                    showNotification(`‚úÖ Studente aggiunto!\nüìß Email inviata a ${email}`, 'success');
                } else {
                    showNotification(`‚úÖ Studente aggiunto!\n‚ö†Ô∏è Errore email: ${emailResult.message}`, 'success');
                }
                
                event.target.reset();
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function changeUserRole(studentId, newRole) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            showLoading('Aggiornamento ruolo...');
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({ role: newRole })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                student.role = newRole;
                hideLoading();
                
                const roleName = newRole === 'admin' ? 'üëë Amministratore' : 'üë§ Studente';
                showNotification(`‚úÖ ${student.name} √® ora ${roleName}`, 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function resendActivationEmail(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                showNotification('‚ùå Studente non trovato', 'error');
                return;
            }
            
            if (student.password) {
                showNotification('‚ö†Ô∏è Account gi√† attivato!', 'error');
                return;
            }
            
            showLoading('Invio email di attivazione...');
            
            const emailResult = await sendWelcomeEmail(student);
            hideLoading();
            
            if (emailResult.success) {
                showNotification(`‚úÖ Email inviata a ${student.email}!\nüîó Il nuovo link √® valido per 7 giorni.`, 'success');
            } else {
                showNotification(`‚ùå Errore invio email: ${emailResult.message}`, 'error');
            }
        }

        async function deleteStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const executeDelete = async () => {
                showLoading('Eliminazione...');
                
                try {
                    const { error } = await supabase
                        .from('students')
                        .delete()
                        .eq('id', studentId);
                    
                    if (error) throw error;
                    
                    allStudents = allStudents.filter(s => s.id !== studentId);
                    allEnrollments = allEnrollments.filter(e => e.student_id !== studentId);
                    hideLoading();
                    loadStudents();
                    showNotification(`‚úÖ Studente "${student.name}" eliminato!`, 'success');
                } catch (error) {
                    hideLoading();
                    showNotification('‚ùå Errore: ' + error.message, 'error');
                }
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', () => {
                    executeDelete();
                    cleanup();
                }, { once: true });
                
                setTimeout(() => {
                    document.addEventListener('click', cleanup, { once: true });
                }, 100);
            }, 0);
        }

        // ==========================================
        // EXCEL FUNCTIONS
        // ==========================================

        function downloadExcelTemplate() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Nome', 'Cognome', 'Email', 'Telefono', 'Azienda', 'Ruolo'],
                ['Mario', 'Rossi', 'mario.rossi@esempio.com', '3331234567', 'Azienda ABC', 'student'],
                ['', '', '', '', '', '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 30}, {wch: 15}, {wch: 20}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, ws, 'Studenti');
            XLSX.writeFile(wb, 'template_studenti.xlsx');
            showNotification('üì• Template scaricato!', 'success');
        }

        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('Lettura file Excel...');
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    hideLoading();
                    
                    if (jsonData.length === 0) {
                        showNotification('‚ö†Ô∏è File Excel vuoto!', 'error');
                        return;
                    }
                    
                    await importStudentsFromExcel(jsonData);
                    
                } catch (error) {
                    hideLoading();
                    showNotification('‚ùå Errore lettura Excel: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        async function importStudentsFromExcel(excelData) {
            showLoading(`Importazione ${excelData.length} studenti...`);
            
            let successCount = 0;
            let errorCount = 0;
            let emailsSent = 0;
            const errors = [];
            const importedStudents = [];
            
            for (let i = 0; i < excelData.length; i++) {
                const row = excelData[i];
                
                if (!row.Nome || !row.Cognome || !row.Email || !row.Azienda) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Campi mancanti`);
                    continue;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(row.Email)) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email non valida`);
                    continue;
                }
                
                const duplicate = allStudents.find(s => s.email.toLowerCase() === row.Email.toLowerCase());
                if (duplicate) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email gi√† esistente`);
                    continue;
                }
                
                const newStudent = {
                    name: row.Nome.trim(),
                    surname: row.Cognome.trim(),
                    email: row.Email.trim().toLowerCase(),
                    phone: row.Telefono ? row.Telefono.toString().trim() : '',
                    company: row.Azienda.trim(),
                    role: row.Ruolo && row.Ruolo.toLowerCase() === 'admin' ? 'admin' : 'student',
                    status: 'active',
                    password: '',
                    registration_date: new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from('students')
                        .insert([newStudent])
                        .select();
                    
                    if (error) throw error;
                    
                    const insertedStudent = data[0];
                    allStudents.unshift(insertedStudent);
                    importedStudents.push(insertedStudent);
                    successCount++;
                } catch (error) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: ${error.message}`);
                }
            }
            
            if (importedStudents.length > 0) {
                showLoading(`Invio email a ${importedStudents.length} studenti...`);
                
                for (const student of importedStudents) {
                    const emailResult = await sendWelcomeEmail(student);
                    if (emailResult.success) emailsSent++;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            hideLoading();
            loadStudents();
            
            let message = `‚úÖ Importazione completata!\n\n`;
            message += `‚úîÔ∏è Studenti importati: ${successCount}\n`;
            message += `üìß Email inviate: ${emailsSent}\n`;
            if (errorCount > 0) {
                message += `‚ùå Errori: ${errorCount}\n\n`;
                message += errors.slice(0, 5).join('\n');
            }
            
            showNotification(message, successCount > 0 ? 'success' : 'error');
        }

        // ==========================================
        // COURSE MANAGEMENT
        // ==========================================

        function loadCourses() {
            const container = document.getElementById('coursesList');
            if (allCourses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun corso presente</p>';
                return;
            }
            
            container.innerHTML = allCourses.map(course => {
                const modules = course.modules || [];
                const enrolledCount = allEnrollments.filter(e => e.course_id === course.id).length;
                
                return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${course.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${course.description || ''}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-xs px-2 py-1 rounded-full ${course.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${course.status === 'published' ? '‚úÖ Pubblicato' : 'üìù Bozza'}
                                </span>
                                ${course.has_certificate ? '<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">üéì Certificato</span>' : ''}
                                <span class="text-xs text-gray-600">üìö ${modules.length} moduli</span>
                                <span class="text-xs text-gray-600">üë• ${enrolledCount} iscritti</span>
                            </div>
                            <div class="mt-3 flex space-x-2">
                                <button onclick="openCourseEditor('${course.id}')" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg">
                                    ‚úèÔ∏è Modifica Contenuti
                                </button>
                            </div>
                        </div>
                        <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-800 text-sm ml-4">Elimina</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function addCourse(event) {
            event.preventDefault();
            
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const hasCertificate = document.getElementById('courseHasCertificate').checked;
            
            const newCourse = {
                title,
                description,
                has_certificate: hasCertificate,
                modules: [],
                status: 'published',
                created_date: new Date().toISOString(),
                created_by: currentUser.name
            };

            showLoading('Creazione corso...');
            
            try {
                const { data, error } = await supabase
                    .from('courses')
                    .insert([newCourse])
                    .select();
                
                if (error) throw error;
                
                const insertedCourse = data[0];
                allCourses.unshift(insertedCourse);
                
                hideLoading();
                hideModal('addCourseModal');
                loadCourses();
                showNotification(`‚úÖ Corso "${title}" creato!\nüìù Ora puoi aggiungere moduli e contenuti.`, 'success');
                
                event.target.reset();
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function deleteCourse(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const executeDelete = async () => {
                showLoading('Eliminazione...');
                
                try {
                    const { error } = await supabase
                        .from('courses')
                        .delete()
                        .eq('id', courseId);
                    
                    if (error) throw error;
                    
                    allCourses = allCourses.filter(c => c.id !== courseId);
                    allEnrollments = allEnrollments.filter(e => e.course_id !== courseId);
                    hideLoading();
                    loadCourses();
                    showNotification(`‚úÖ Corso eliminato!`, 'success');
                } catch (error) {
                    hideLoading();
                    showNotification('‚ùå Errore: ' + error.message, 'error');
                }
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', () => {
                    executeDelete();
                    cleanup();
                }, { once: true });
                
                setTimeout(() => {
                    document.addEventListener('click', cleanup, { once: true });
                }, 100);
            }, 0);
        }

        // ==========================================
        // ADMIN TABS & STATS
        // ==========================================

        function showAdminTab(tab) {
            document.getElementById('studentsSection').classList.add('hidden');
            document.getElementById('coursesSection').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            
            document.getElementById('studentsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('coursesTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('reportsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('settingsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            
            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById(tab + 'Tab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-green-600 shadow-sm';
            
            if (tab === 'reports') {
                updateStats();
            }
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = allStudents.length;
            document.getElementById('totalCourses').textContent = allCourses.filter(c => c.status === 'published').length;
            document.getElementById('totalCompletions').textContent = allProgress.filter(p => p.completed === true).length;
        }

        // ==========================================
        // STUDENT DASHBOARD
        // ==========================================

        let currentViewingCourse = null;
        let currentModuleIndex = 0;

        function loadStudentCourses() {
            const container = document.getElementById('studentCoursesList');
            
            // Filtra solo i corsi a cui lo studente √® iscritto
            const enrolledCourseIds = getStudentEnrolledCourses(currentUser.studentId);
            const enrolledCourses = allCourses.filter(c => 
                c.status === 'published' && enrolledCourseIds.includes(c.id)
            );
            
            if (enrolledCourses.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">Non sei ancora iscritto a nessun corso.<br>Contatta l\'amministratore per l\'assegnazione.</p></div>';
                return;
            }
            
            container.innerHTML = enrolledCourses.map(course => {
                const progress = getStudentCourseProgress(course.id);
                const modules = course.modules || [];
                
                return `
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${course.title}</h3>
                    <p class="text-sm text-gray-600 mb-3">${course.description || ''}</p>
                    
                    ${modules.length > 0 ? `
                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Progresso</span>
                                <span>${progress.completedModules}/${modules.length} moduli</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: ${modules.length > 0 ? (progress.completedModules / modules.length * 100) : 0}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${progress.completed ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                            <p class="text-sm text-green-800 font-medium">‚úÖ Corso completato!</p>
                            ${course.has_certificate ? `
                                <button onclick="downloadCertificate('${course.id}')" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm">
                                    üéì Scarica Certificato
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <button onclick="startCourse('${course.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ${progress.completedModules > 0 ? '‚ñ∂Ô∏è Continua' : 'üöÄ Inizia Corso'}
                    </button>
                </div>
            `;
            }).join('');
        }

        function getStudentCourseProgress(courseId) {
            const progress = allProgress.find(p => 
                p.student_id === currentUser.studentId && 
                p.course_id === courseId
            );
            
            if (!progress) {
                return { completedModules: 0, completed: false };
            }
            
            return {
                completedModules: progress.completed_modules || 0,
                completed: progress.completed || false,
                moduleProgress: progress.module_progress || {}
            };
        }

        function startCourse(courseId) {
            currentViewingCourse = allCourses.find(c => c.id === courseId);
            if (!currentViewingCourse || !currentViewingCourse.modules || currentViewingCourse.modules.length === 0) {
                showNotification('‚ö†Ô∏è Questo corso non ha ancora moduli!', 'error');
                return;
            }
            
            const progress = getStudentCourseProgress(courseId);
            currentModuleIndex = progress.completedModules || 0;
            
            if (currentModuleIndex >= currentViewingCourse.modules.length) {
                currentModuleIndex = currentViewingCourse.modules.length - 1;
            }
            
            document.getElementById('studentDashboard').classList.add('hidden');
            showCourseViewer();
        }

        function showCourseViewer() {
            const viewer = document.createElement('div');
            viewer.id = 'courseViewer';
            viewer.className = 'max-w-4xl mx-auto p-6';
            
            viewer.innerHTML = `
                <div class="mb-6">
                    <button onclick="exitCourse()" class="text-blue-600 hover:text-blue-800 mb-4">
                        ‚Üê Torna ai corsi
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800">${currentViewingCourse.title}</h2>
                    <p class="text-gray-600 mt-2">${currentViewingCourse.description || ''}</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div id="moduleNavigation" class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                        <button onclick="previousModule()" id="prevModuleBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                            ‚Üê Precedente
                        </button>
                        <span id="moduleCounter" class="text-sm font-medium text-gray-700"></span>
                        <button onclick="nextModule()" id="nextModuleBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            Successivo ‚Üí
                        </button>
                    </div>
                    
                    <div id="moduleContent"></div>
                </div>
            `;
            
            document.getElementById('dashboard').appendChild(viewer);
            renderModule();
        }

        function renderModule() {
            const module = currentViewingCourse.modules[currentModuleIndex];
            const content = document.getElementById('moduleContent');
            const counter = document.getElementById('moduleCounter');
            const prevBtn = document.getElementById('prevModuleBtn');
            const nextBtn = document.getElementById('nextModuleBtn');
            
            counter.textContent = `Modulo ${currentModuleIndex + 1} di ${currentViewingCourse.modules.length}`;
            prevBtn.disabled = currentModuleIndex === 0;
            prevBtn.classList.toggle('opacity-50', currentModuleIndex === 0);
            prevBtn.classList.toggle('cursor-not-allowed', currentModuleIndex === 0);
            
            content.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-3">${module.title}</h3>
                ${module.description ? `<p class="text-gray-600 mb-6">${module.description}</p>` : ''}
                
                <div class="space-y-6">
                    ${renderModuleMedia(module)}
                </div>
                
                ${module.test ? `
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">üìù Test di Verifica</h4>
                        <p class="text-sm text-gray-600 mb-4">Punteggio minimo richiesto: ${module.test.minScore}%</p>
                        <button onclick="startModuleTest()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">
                            Inizia Test
                        </button>
                    </div>
                ` : `
                    <div class="mt-8 flex justify-end">
                        <button onclick="completeModuleAndNext()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                            ‚úÖ Completa e Vai Avanti
                        </button>
                    </div>
                `}
            `;
        }

        function renderModuleMedia(module) {
            const media = module.media || [];
            
            if (media.length === 0) {
                return '<p class="text-gray-500">Nessun contenuto disponibile</p>';
            }
            
            return media.map(item => {
                switch(item.type) {
                    case 'video':
                        const videoId = extractVideoId(item.url);
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">üé• ${item.title}</h5>
                                <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden">
                                    ${videoId ? `
                                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                                class="w-full h-full" 
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen></iframe>
                                    ` : `<p class="p-4 text-gray-500">Video non disponibile</p>`}
                                </div>
                            </div>
                        `;
                    
                    case 'pdf':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">üìÑ ${item.title}</h5>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                                   class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                    <span>Apri PDF</span>
                                    <span>‚Üó</span>
                                </a>
                            </div>
                        `;
                    
                    case 'link':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">üîó ${item.title}</h5>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                                   class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-800">
                                    <span>${item.url}</span>
                                    <span>‚Üó</span>
                                </a>
                            </div>
                        `;
                    
                    case 'text':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">üìù ${item.title}</h5>
                                <div class="prose prose-sm max-w-none text-gray-700">
                                    ${item.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `;
                    
                    default:
                        return '';
                }
            }).join('');
        }

        function extractVideoId(url) {
            // Supporta vari formati YouTube
            const patterns = [
                /(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,  // https://www.youtube.com/watch?v=VIDEO_ID
                /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,     // https://www.youtube.com/embed/VIDEO_ID
                /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,               // https://youtu.be/VIDEO_ID
                /(?:youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/          // https://www.youtube.com/v/VIDEO_ID
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function previousModule() {
            if (currentModuleIndex > 0) {
                currentModuleIndex--;
                renderModule();
            }
        }

        function nextModule() {
            if (currentModuleIndex < currentViewingCourse.modules.length - 1) {
                currentModuleIndex++;
                renderModule();
            }
        }

        async function completeModuleAndNext() {
            await updateModuleProgress(currentModuleIndex, true);
            
            if (currentModuleIndex < currentViewingCourse.modules.length - 1) {
                nextModule();
            } else {
                await completeCourse();
            }
        }

        function startModuleTest() {
            const module = currentViewingCourse.modules[currentModuleIndex];
            const test = module.test;
            
            if (!test || !test.questions || test.questions.length === 0) {
                showNotification('‚ö†Ô∏è Test non disponibile', 'error');
                return;
            }
            
            const testUI = document.createElement('div');
            testUI.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            testUI.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto p-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Test: ${module.title}</h3>
                    <form id="testForm" class="space-y-6">
                        ${test.questions.map((q, qIndex) => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <p class="font-medium text-gray-800 mb-3">${qIndex + 1}. ${q.question}</p>
                                <div class="space-y-2">
                                    ${q.options.map((opt, oIndex) => `
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="q${qIndex}" value="${oIndex}" required class="text-green-600">
                                            <span class="text-gray-700">${String.fromCharCode(65 + oIndex)}. ${opt}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                                Invia Risposte
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(testUI);
            
            document.getElementById('testForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                let correctAnswers = 0;
                test.questions.forEach((q, index) => {
                    const selected = parseInt(document.querySelector(`input[name="q${index}"]:checked`)?.value);
                    if (selected === q.correctAnswer) correctAnswers++;
                });
                
                const score = Math.round((correctAnswers / test.questions.length) * 100);
                const passed = score >= test.minScore;
                
                testUI.remove();
                
                if (passed) {
                    showNotification(`‚úÖ Test superato! Punteggio: ${score}%`, 'success');
                    await completeModuleAndNext();
                } else {
                    showNotification(`‚ùå Test non superato. Punteggio: ${score}% (minimo ${test.minScore}%)\nRipassa il materiale e riprova.`, 'error');
                }
            });
        }

        async function updateModuleProgress(moduleIndex, completed) {
            showLoading('Aggiornamento progresso...');
            
            try {
                let progress = allProgress.find(p => 
                    p.student_id === currentUser.studentId && 
                    p.course_id === currentViewingCourse.id
                );
                
                if (!progress) {
                    const { data, error } = await supabase
                        .from('progress')
                        .insert([{
                            student_id: currentUser.studentId,
                            course_id: currentViewingCourse.id,
                            completed: false,
                            completed_modules: completed ? 1 : 0,
                            module_progress: { [moduleIndex]: completed }
                        }])
                        .select();
                    
                    if (error) throw error;
                    progress = data[0];
                    allProgress.push(progress);
                } else {
                    const moduleProgress = progress.module_progress || {};
                    moduleProgress[moduleIndex] = completed;
                    
                    const completedCount = Object.values(moduleProgress).filter(v => v === true).length;
                    
                    const { error } = await supabase
                        .from('progress')
                        .update({
                            completed_modules: completedCount,
                            module_progress: moduleProgress
                        })
                        .eq('id', progress.id);
                    
                    if (error) throw error;
                    
                    progress.completed_modules = completedCount;
                    progress.module_progress = moduleProgress;
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore aggiornamento: ' + error.message, 'error');
            }
        }

        async function completeCourse() {
            showLoading('Completamento corso...');
            
            try {
                const progress = allProgress.find(p => 
                    p.student_id === currentUser.studentId && 
                    p.course_id === currentViewingCourse.id
                );
                
                if (progress) {
                    const { error } = await supabase
                        .from('progress')
                        .update({
                            completed: true,
                            completion_date: new Date().toISOString()
                        })
                        .eq('id', progress.id);
                    
                    if (error) throw error;
                    
                    progress.completed = true;
                    progress.completion_date = new Date().toISOString();
                }
                
                hideLoading();
                
                if (currentViewingCourse.has_certificate) {
                    showNotification('üéâ Congratulazioni! Corso completato!\nüéì Puoi scaricare il certificato.', 'success');
                } else {
                    showNotification('üéâ Congratulazioni! Hai completato il corso!', 'success');
                }
                
                setTimeout(() => exitCourse(), 2000);
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        function exitCourse() {
            const viewer = document.getElementById('courseViewer');
            if (viewer) viewer.remove();
            
            document.getElementById('studentDashboard').classList.remove('hidden');
            loadStudentCourses();
        }

        function downloadCertificate(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 800;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, 1200, 800);
            
            // Border
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 10;
            ctx.strokeRect(30, 30, 1140, 740);
            
            // Title
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CERTIFICATO DI COMPLETAMENTO', 600, 150);
            
            // Student Name
            ctx.font = 'bold 40px Arial';
            ctx.fillText(currentUser.name, 600, 350);
            
            // Course Name
            ctx.font = '30px Arial';
            ctx.fillText(`ha completato il corso`, 600, 450);
            ctx.font = 'bold 35px Arial';
            ctx.fillStyle = '#10b981';
            ctx.fillText(`"${course.title}"`, 600, 520);
            
            // Date
            ctx.fillStyle = '#6b7280';
            ctx.font = '20px Arial';
            const progress = allProgress.find(p => 
                p.student_id === currentUser.studentId && 
                p.course_id === courseId
            );
            const dateStr = progress?.completion_date ? 
                new Date(progress.completion_date).toLocaleDateString('it-IT') : 
                new Date().toLocaleDateString('it-IT');
            ctx.fillText(`Data: ${dateStr}`, 600, 650);
            
            // Download
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificato_${course.title.replace(/\s+/g, '_')}.png`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('üéì Certificato scaricato!', 'success');
            });
        }

        // ==========================================
        // ACCOUNT ACTIVATION
        // ==========================================

        function decodeActivationToken(token) {
            try {
                const decoded = atob(token);
                const [studentId, email, timestamp] = decoded.split('-');
                return { studentId, email, timestamp: parseInt(timestamp) };
            } catch (error) {
                return null;
            }
        }

        async function checkActivationLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const token = urlParams.get('token');
            const studentId = urlParams.get('id');
            
            console.log('üîç Checking activation link:', { action, hasToken: !!token, hasId: !!studentId });
            
            if (action === 'activate' && token && studentId) {
                showLoading('Verifica link di attivazione...');
                
                const tokenData = decodeActivationToken(token);
                
                if (!tokenData) {
                    hideLoading();
                    showNotification('‚ùå Link non valido', 'error');
                    return;
                }
                
                // Link non scade mai - valido fino all'attivazione dell'account
                console.log('‚è∞ Link creato:', new Date(tokenData.timestamp).toLocaleString());
                
                try {
                    const { data: students, error } = await supabase
                        .from('students')
                        .select('*')
                        .eq('id', studentId)
                        .single();
                    
                    if (error || !students) {
                        hideLoading();
                        showNotification('‚ùå Studente non trovato nel database', 'error');
                        console.error('Errore caricamento studente:', error);
                        return;
                    }
                    
                    const student = students;
                    
                    if (student.password) {
                        hideLoading();
                        showNotification('‚ö†Ô∏è Account gi√† attivato! Puoi fare il login.', 'success');
                        document.getElementById('loginEmail').value = student.email;
                        return;
                    }
                    
                    hideLoading();
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('activationScreen').classList.remove('hidden');
                    document.getElementById('activationEmail').textContent = student.email;
                    document.getElementById('activationName').textContent = `${student.name} ${student.surname}`;
                    
                    window.activatingStudent = student;
                    console.log('‚úÖ Schermata attivazione mostrata per:', student.email);
                    return;
                    
                } catch (error) {
                    hideLoading();
                    showNotification('‚ùå Errore caricamento dati: ' + error.message, 'error');
                    console.error('Errore:', error);
                    return;
                }
            }
        }

        async function activateAccount(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('‚ùå Le password non coincidono!', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showNotification('‚ùå Password minimo 8 caratteri', 'error');
                return;
            }
            
            if (!window.activatingStudent) {
                showNotification('‚ùå Errore dati studente', 'error');
                return;
            }
            
            showLoading('Attivazione account...');
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({
                        password: newPassword,
                        status: 'active'
                    })
                    .eq('id', window.activatingStudent.id);
                
                if (error) throw error;
                
                const studentIndex = allStudents.findIndex(s => s.id === window.activatingStudent.id);
                if (studentIndex !== -1) {
                    allStudents[studentIndex].password = newPassword;
                    allStudents[studentIndex].status = 'active';
                }
                
                delete window.activatingStudent;
                window.history.replaceState({}, document.title, window.location.pathname);
                
                hideLoading();
                showNotification('‚úÖ Account attivato! Ora puoi accedere.', 'success');
                
                setTimeout(() => {
                    document.getElementById('activationScreen').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    if (studentIndex !== -1) {
                        document.getElementById('loginEmail').value = allStudents[studentIndex].email;
                    }
                }, 2000);
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // COURSE EDITOR FUNCTIONS
        // ==========================================

        let currentEditingCourse = null;
        let currentEditingModule = null;

        function openCourseEditor(courseId) {
            currentEditingCourse = allCourses.find(c => c.id === courseId);
            if (!currentEditingCourse) return;
            
            if (!currentEditingCourse.modules) {
                currentEditingCourse.modules = [];
            }
            
            document.getElementById('editorCourseTitle').textContent = currentEditingCourse.title;
            showModal('courseEditorModal');
            renderModulesList();
            showEmptyModuleEditor();
        }

        function renderModulesList() {
            const container = document.getElementById('modulesList');
            const modules = currentEditingCourse.modules || [];
            
            if (modules.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nessun modulo</p>';
                return;
            }
            
            container.innerHTML = modules.map((module, index) => `
                <div onclick="selectModule(${index})" class="p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 ${currentEditingModule === module ? 'bg-blue-50 border-blue-500' : ''}">
                    <div class="font-medium text-sm text-gray-800">${index + 1}. ${module.title || 'Senza titolo'}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${(module.media || []).length} media
                        ${module.test ? 'ÔøΩÔøΩÔøΩ Test presente' : ''}
                    </div>
                </div>
            `).join('');
        }

        function addModule() {
            const newModule = {
                id: 'mod_' + Date.now(),
                title: 'Nuovo Modulo',
                description: '',
                media: [],
                test: null,
                order: currentEditingCourse.modules.length
            };
            
            currentEditingCourse.modules.push(newModule);
            renderModulesList();
            selectModule(currentEditingCourse.modules.length - 1);
        }

        function selectModule(index) {
            currentEditingModule = currentEditingCourse.modules[index];
            showModuleEditor();
        }

        function showEmptyModuleEditor() {
            document.getElementById('moduleEditorEmpty').classList.remove('hidden');
            document.getElementById('moduleEditorContent').classList.add('hidden');
            currentEditingModule = null;
        }

        function showModuleEditor() {
            if (!currentEditingModule) return;
            
            document.getElementById('moduleEditorEmpty').classList.add('hidden');
            document.getElementById('moduleEditorContent').classList.remove('hidden');
            
            document.getElementById('moduleTitle').value = currentEditingModule.title || '';
            document.getElementById('moduleDescription').value = currentEditingModule.description || '';
            
            renderMediaList();
            updateTestSection();
            renderModulesList();
        }

        function renderMediaList() {
            const container = document.getElementById('mediaList');
            const media = currentEditingModule.media || [];
            
            if (media.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Nessun media</p>';
                return;
            }
            
            const mediaIcons = {
                video: 'üé•',
                pdf: 'üìÑ',
                link: 'üîó',
                text: 'üìù'
            };
            
            container.innerHTML = media.map((item, index) => `
                <div class="flex items-center justify-between p-2 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-2">
                        <span>${mediaIcons[item.type] || 'üìé'}</span>
                        <span class="text-sm text-gray-800">${item.title}</span>
                    </div>
                    <button onclick="deleteMedia(${index})" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                </div>
            `).join('');
        }

        function addMedia() {
            showModal('addMediaModal');
            document.getElementById('mediaType').value = 'video';
            updateMediaForm();
        }

        function updateMediaForm() {
            const type = document.getElementById('mediaType').value;
            const urlField = document.getElementById('mediaUrlField');
            const textField = document.getElementById('mediaTextField');
            const urlInput = document.getElementById('mediaUrl');
            
            if (type === 'text') {
                urlField.classList.add('hidden');
                textField.classList.remove('hidden');
                urlInput.removeAttribute('required');
            } else {
                urlField.classList.remove('hidden');
                textField.classList.add('hidden');
                urlInput.setAttribute('required', 'required');
            }
        }

        function saveMedia(event) {
            event.preventDefault();
            
            const type = document.getElementById('mediaType').value;
            const title = document.getElementById('mediaTitle').value.trim();
            const url = document.getElementById('mediaUrl').value.trim();
            const text = document.getElementById('mediaText').value.trim();
            
            const mediaItem = {
                id: 'media_' + Date.now(),
                type,
                title,
                url: type === 'text' ? '' : url,
                content: type === 'text' ? text : ''
            };
            
            if (!currentEditingModule.media) {
                currentEditingModule.media = [];
            }
            
            currentEditingModule.media.push(mediaItem);
            renderMediaList();
            hideModal('addMediaModal');
            
            event.target.reset();
            showNotification('‚úÖ Media aggiunto!', 'success');
        }

        function deleteMedia(index) {
            currentEditingModule.media.splice(index, 1);
            renderMediaList();
            showNotification('‚úÖ Media eliminato', 'success');
        }

        function toggleModuleTest() {
            if (currentEditingModule.test) {
                currentEditingModule.test = null;
                showNotification('‚úÖ Test rimosso', 'success');
            } else {
                currentEditingModule.test = {
                    minScore: 70,
                    questions: []
                };
            }
            updateTestSection();
        }

        function updateTestSection() {
            const testSection = document.getElementById('testSection');
            const toggleBtn = document.getElementById('toggleTestBtn');
            const questionCount = document.getElementById('questionCount');
            
            if (currentEditingModule.test) {
                testSection.classList.remove('hidden');
                toggleBtn.textContent = '‚ùå Rimuovi Test';
                toggleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                document.getElementById('testMinScore').value = currentEditingModule.test.minScore || 70;
                questionCount.textContent = `${currentEditingModule.test.questions.length} domande`;
            } else {
                testSection.classList.add('hidden');
                toggleBtn.textContent = '‚ûï Aggiungi Test';
                toggleBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        }

        function manageQuestions() {
            showModal('questionsModal');
            renderQuestionsList();
        }

        function renderQuestionsList() {
            const container = document.getElementById('questionsList');
            const questions = currentEditingModule.test?.questions || [];
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna domanda</p>';
                return;
            }
            
            container.innerHTML = questions.map((q, index) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium text-gray-800">${index + 1}. ${q.question}</span>
                        <button onclick="deleteQuestion(${index})" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </div>
                    <div class="space-y-1 ml-4">
                        ${q.options.map((opt, i) => `
                            <div class="text-sm ${i === q.correctAnswer ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                ${String.fromCharCode(65 + i)}. ${opt} ${i === q.correctAnswer ? '‚úÖ' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function addQuestion() {
            const question = window.prompt('Inserisci la domanda:');
            if (!question) return;
            
            const optionA = window.prompt('Opzione A:');
            const optionB = window.prompt('Opzione B:');
            const optionC = window.prompt('Opzione C:');
            const optionD = window.prompt('Opzione D:');
            
            if (!optionA || !optionB || !optionC || !optionD) {
                showNotification('‚ö†Ô∏è Tutte le opzioni sono obbligatorie!', 'error');
                return;
            }
            
            const correctAnswer = parseInt(window.prompt('Numero risposta corretta (0=A, 1=B, 2=C, 3=D):'));
            
            if (isNaN(correctAnswer) || correctAnswer < 0 || correctAnswer > 3) {
                showNotification('‚ö†Ô∏è Risposta corretta non valida!', 'error');
                return;
            }
            
            const newQuestion = {
                id: 'q_' + Date.now(),
                question,
                options: [optionA, optionB, optionC, optionD],
                correctAnswer
            };
            
            if (!currentEditingModule.test.questions) {
                currentEditingModule.test.questions = [];
            }
            
            currentEditingModule.test.questions.push(newQuestion);
            renderQuestionsList();
            updateTestSection();
            showNotification('‚úÖ Domanda aggiunta!', 'success');
        }

        function deleteQuestion(index) {
            currentEditingModule.test.questions.splice(index, 1);
            renderQuestionsList();
            updateTestSection();
            showNotification('‚úÖ Domanda eliminata', 'success');
        }

        async function saveModule() {
            if (!currentEditingModule) return;
            
            currentEditingModule.title = document.getElementById('moduleTitle').value.trim();
            currentEditingModule.description = document.getElementById('moduleDescription').value.trim();
            
            if (currentEditingModule.test) {
                currentEditingModule.test.minScore = parseInt(document.getElementById('testMinScore').value);
            }
            
            showLoading('Salvataggio modulo...');
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .update({ modules: currentEditingCourse.modules })
                    .eq('id', currentEditingCourse.id);
                
                if (error) throw error;
                
                const courseIndex = allCourses.findIndex(c => c.id === currentEditingCourse.id);
                if (courseIndex !== -1) {
                    allCourses[courseIndex] = currentEditingCourse;
                }
                
                hideLoading();
                showNotification('‚úÖ Modulo salvato!', 'success');
                renderModulesList();
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        async function deleteModule() {
            if (!currentEditingModule) return;
            
            const moduleIndex = currentEditingCourse.modules.indexOf(currentEditingModule);
            
            const confirmDelete = window.confirm(`Eliminare il modulo "${currentEditingModule.title}"?`);
            if (!confirmDelete) return;
            
            currentEditingCourse.modules.splice(moduleIndex, 1);
            
            showLoading('Eliminazione modulo...');
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .update({ modules: currentEditingCourse.modules })
                    .eq('id', currentEditingCourse.id);
                
                if (error) throw error;
                
                const courseIndex = allCourses.findIndex(c => c.id === currentEditingCourse.id);
                if (courseIndex !== -1) {
                    allCourses[courseIndex] = currentEditingCourse;
                }
                
                hideLoading();
                showNotification('‚úÖ Modulo eliminato!', 'success');
                renderModulesList();
                showEmptyModuleEditor();
                
            } catch (error) {
                hideLoading();
                showNotification('‚ùå Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Avvio EduPlatform...');
            
            // üî• CONTROLLA LINK DI ATTIVAZIONE PRIMA DI TUTTO
            const urlParams = new URLSearchParams(window.location.search);
            const isActivationLink = urlParams.get('action') === 'activate' && urlParams.get('token') && urlParams.get('id');
            
            if (isActivationLink) {
                console.log('üîó Link di attivazione rilevato - avvio diretto');
                
                // Inizializza Supabase in background SENZA mostrare modal
                const config = loadSupabaseConfig();
                if (!config) {
                    showActivationConfigNeeded();
                    return;
                }
                
                supabase = window.supabase.createClient(config.url, config.key);
                
                try {
                    await loadAllData();
                    // Mostra SUBITO la schermata di attivazione
                    await checkActivationLink();
                } catch (error) {
                    console.error('Errore caricamento:', error);
                    showNotification('‚ùå Errore caricamento dati: ' + error.message, 'error');
                }
                
                return;
            }
            
            // Solo se NON √® un link di attivazione, mostra modal Supabase
            const supabaseReady = await initSupabase();
            
            if (!supabaseReady) {
                console.log('‚ö†Ô∏è Supabase non configurato');
                return;
            }
            
            await loadEmailJSConfig();
            
            console.log('‚úÖ Piattaforma pronta!');
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a65d325b25abaa5',t:'MTc2NDQ1ODMxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
