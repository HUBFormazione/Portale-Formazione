<!doctype html>
<html lang="it">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduPlatform - Versione Supabase</title>
  <script src="https://cdn.tailwindcss.com/3.3.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script><!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-full"><!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-white text-lg" id="loadingText">Caricamento...</p>
    <p class="text-white text-sm mt-2 opacity-75" id="loadingSubtext">Attendere prego...</p>
   </div>
  </div><!-- Supabase Configuration Modal -->
  <div id="supabaseConfigModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-8">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">âš¡</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-800">Configura Supabase</h2>
      <p class="text-gray-600 mt-2">Solo 2 credenziali - Setup in 5 minuti!</p>
     </div>
     <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-green-900 mb-2">ğŸ“‹ Come ottenere le credenziali:</h3>
      <ol class="text-sm text-green-800 space-y-1 ml-4">
       <li>1. Vai su <a href="https://supabase.com" target="_blank" rel="noopener noreferrer" class="underline font-medium">supabase.com</a> e crea account gratis</li>
       <li>2. Clicca <strong>"New Project"</strong></li>
       <li>3. Scegli nome progetto (es: "eduplatform") e password database</li>
       <li>4. Vai su <strong>"Settings"</strong> â†’ <strong>"API"</strong></li>
       <li>5. Copia <code class="bg-green-100 px-1 rounded">Project URL</code> e <code class="bg-green-100 px-1 rounded">anon public</code> key</li>
      </ol>
     </div>
     <form onsubmit="saveSupabaseConfig(event)" class="space-y-4">
      <div><label for="supabaseUrl" class="block text-sm font-medium text-gray-700 mb-1">Project URL</label> <input type="url" id="supabaseUrl" required placeholder="https://tuoprogetto.supabase.co" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
       <p class="text-xs text-gray-500 mt-1">Es: https://xyzabcdef.supabase.co</p>
      </div>
      <div><label for="supabaseKey" class="block text-sm font-medium text-gray-700 mb-1">Anon Public Key</label> <textarea id="supabaseKey" required placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
       <p class="text-xs text-gray-500 mt-1">La chiave pubblica Ã¨ sicura da condividere</p>
      </div>
      <div class="flex space-x-3 pt-4"><button type="submit" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"> âš¡ Connetti Supabase </button>
      </div>
     </form>
     <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-xs text-blue-800">ğŸ’¡ <strong>Dopo aver connesso:</strong> Tornerai qui per creare automaticamente le tabelle del database.</p>
     </div>
    </div>
   </div>
  </div><!-- Database Setup Modal -->
  <div id="dbSetupModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
    <div class="p-8">
     <div class="text-center mb-6">
      <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">ï¿½ï¿½ï¿½ï¿½ï¸</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Inizializza Database</h2>
      <p class="text-gray-600 mt-2">Crea le tabelle necessarie per la piattaforma</p>
     </div>
     <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-yellow-800">âš ï¸ Questa operazione va fatta <strong>solo la prima volta</strong>. Crea 4 tabelle: students, courses, progress, enrollments.</p>
     </div><button onclick="initializeDatabase()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold"> ğŸš€ Crea Tabelle </button> <button onclick="skipDatabaseSetup()" class="w-full mt-3 text-gray-600 hover:text-gray-800 text-sm"> Salta (giÃ  fatto) </button>
    </div>
   </div>
  </div><!-- Navigation -->
  <nav class="bg-white shadow-lg border-b-4 border-green-500">
   <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between items-center py-4">
     <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center"><span class="text-white font-bold text-lg">ğŸ“</span>
      </div>
      <div>
       <h1 class="text-2xl font-bold text-gray-800">EduPlatform <span class="text-sm text-green-600">âš¡ Supabase</span></h1>
      </div>
     </div>
     <div class="flex items-center space-x-4"><span id="currentUser" class="text-gray-600 font-medium"></span> <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"> Logout </button>
     </div>
    </div>
   </div>
  </nav><!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">ğŸ“</span>
     </div>
     <h2 class="text-3xl font-bold text-gray-800">Accedi alla Piattaforma</h2>
     <p class="text-gray-600 mt-2">Database Supabase âš¡</p>
    </div>
    <form onsubmit="login(event)" class="space-y-6">
     <div><label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label> <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
     </div>
     <div><label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
     </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors"> Accedi </button>
    </form>
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
     <p class="text-sm text-gray-600 mb-2"><strong>Credenziali Demo:</strong></p>
     <p class="text-xs text-gray-500">Admin: admin@edu.com / admin123</p>
     <p class="text-xs text-gray-500">Studente: studente@edu.com / student123</p>
    </div>
    <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
     <p class="text-xs text-green-800">âš¡ <strong>Supabase:</strong> PostgreSQL in cloud, piÃ¹ semplice di Firebase!</p>
    </div>
   </div>
  </div><!-- Account Activation Screen -->
  <div id="activationScreen" class="hidden min-h-screen flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-white text-2xl">ğŸ”</span>
     </div>
     <h2 class="text-3xl font-bold text-gray-800">Crea la tua Password</h2>
     <p class="text-gray-600 mt-2">Benvenuto! Imposta la password per il tuo account</p>
    </div>
    <div id="activationInfo" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
     <p class="text-sm text-green-800"><strong>Email:</strong> <span id="activationEmail"></span></p>
     <p class="text-sm text-green-800 mt-1"><strong>Nome:</strong> <span id="activationName"></span></p>
    </div>
    <form onsubmit="activateAccount(event)" class="space-y-6">
     <div><label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Nuova Password</label> <input type="password" id="newPassword" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Minimo 8 caratteri">
      <p class="text-xs text-gray-500 mt-1">La password deve contenere almeno 8 caratteri</p>
     </div>
     <div><label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-2">Conferma Password</label> <input type="password" id="confirmPassword" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ripeti la password">
     </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors"> ğŸ” Attiva Account </button>
    </form>
   </div>
  </div><!-- Main Dashboard -->
  <div id="dashboard" class="hidden"><!-- Admin Dashboard -->
   <div id="adminDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Amministratore</h2>
     <p class="text-gray-600">Gestisci studenti e corsi - Database Supabase ï¿½ï¿½ï¿½</p>
    </div><!-- Admin Navigation Tabs -->
    <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg"><button onclick="showAdminTab('students')" id="studentsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-green-600 shadow-sm"> ğŸ‘¥ Gestione Studenti </button> <button onclick="showAdminTab('companies')" id="companiesTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> ğŸ¢ Gestione Aziende </button> <button onclick="showAdminTab('courses')" id="coursesTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> ğŸ“š Gestione Corsi </button> <button onclick="showAdminTab('reports')" id="reportsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> ğŸ“Š Report </button> <button onclick="showAdminTab('settings')" id="settingsTab" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800"> âš™ï¸ Impostazioni </button>
    </div><!-- Students Management -->
    <div id="studentsSection" class="fade-in">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Studenti</h3>
       <div class="flex space-x-3"><button onclick="downloadExcelTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> ï¿½ï¿½ï¿½ Scarica Template </button> <button onclick="document.getElementById('excelUpload').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> ï¿½ï¿½ï¿½ Carica Excel </button> <input type="file" id="excelUpload" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)" class="hidden"> <button onclick="showModal('addStudentModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> â• Aggiungi Singolo </button>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gray-50">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nome</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azienda</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Corsi</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ruolo</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Stato</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azioni</th>
         </tr>
        </thead>
        <tbody id="studentsTable" class="divide-y divide-gray-200">
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Companies Management -->
    <div id="companiesSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Aziende</h3>
       <div class="flex space-x-3"><button onclick="downloadCompaniesExcelTemplate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“¥ Scarica Template </button> <button onclick="document.getElementById('companiesExcelUpload').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors"> ğŸ“¤ Carica Excel </button> <input type="file" id="companiesExcelUpload" accept=".xlsx,.xls,.csv" onchange="handleCompaniesExcelUpload(event)" class="hidden"> <button onclick="showModal('addCompanyModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> â• Aggiungi Azienda </button>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead class="bg-gray-50">
         <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Denominazione Sociale</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Partita IVA</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Referente</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Email</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Telefono</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Sito Web</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Logo</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Azioni</th>
         </tr>
        </thead>
        <tbody id="companiesTable" class="divide-y divide-gray-200">
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Courses Management -->
    <div id="coursesSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-6">
       <h3 class="text-xl font-semibold text-gray-800">Gestione Corsi</h3><button onclick="showModal('addCourseModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> â• Crea Corso </button>
      </div>
      <div id="coursesList" class="space-y-4">
      </div>
     </div>
    </div><!-- Reports Section -->
    <div id="reportsSection" class="hidden">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Studenti Totali</p>
         <p id="totalStudents" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><span class="text-green-600 text-xl">ğŸ‘¥</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Corsi Attivi</p>
         <p id="totalCourses" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><span class="text-blue-600 text-xl">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½</span>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-sm font-medium text-gray-600">Completamenti</p>
         <p id="totalCompletions" class="text-3xl font-bold text-purple-600">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><span class="text-purple-600 text-xl">ğŸ†</span>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Settings Section -->
    <div id="settingsSection" class="hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">âš™ï¸ Configurazione Piattaforma</h3><!-- Certificate Customization -->
      <div class="border-b border-gray-200 pb-6 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h4 class="text-lg font-medium text-gray-800">ğŸ“ Personalizzazione Attestato</h4>
         <p class="text-sm text-gray-600 mt-1">Personalizza l'aspetto del certificato finale</p>
        </div>
       </div>
       <form onsubmit="saveCertificateConfig(event)" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label for="certTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo Certificato</label> <input type="text" id="certTitle" placeholder="CERTIFICATO DI COMPLETAMENTO" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
         </div>
         <div><label for="certSubtitle" class="block text-sm font-medium text-gray-700 mb-2">Sottotitolo</label> <input type="text" id="certSubtitle" placeholder="ha completato con successo il corso" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
         </div>
        </div>
        <div><label for="certFooterText" class="block text-sm font-medium text-gray-700 mb-2">Testo a PiÃ¨ di Pagina</label> <input type="text" id="certFooterText" placeholder="EduPlatform - Formazione Professionale" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div><label for="certSignature" class="block text-sm font-medium text-gray-700 mb-2">Nome Firmatario</label> <input type="text" id="certSignature" placeholder="Direttore Formazione" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label for="certPrimaryColor" class="block text-sm font-medium text-gray-700 mb-2">Colore Primario</label>
          <div class="flex space-x-2"><input type="color" id="certPrimaryColor" value="#10b981" class="h-10 w-20 border border-gray-300 rounded-lg cursor-pointer"> <input type="text" id="certPrimaryColorHex" value="#10b981" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="#10b981">
          </div>
         </div>
         <div><label for="certSecondaryColor" class="block text-sm font-medium text-gray-700 mb-2">Colore Secondario</label>
          <div class="flex space-x-2"><input type="color" id="certSecondaryColor" value="#1f2937" class="h-10 w-20 border border-gray-300 rounded-lg cursor-pointer"> <input type="text" id="certSecondaryColorHex" value="#1f2937" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="#1f2937">
          </div>
         </div>
        </div>
        <div><label for="certPlatformLogo" class="block text-sm font-medium text-gray-700 mb-2">Logo Piattaforma (sinistra del certificato)</label>
         <div class="flex space-x-2"><input type="url" id="certPlatformLogo" placeholder="https://esempio.com/logo.png o carica file" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <button type="button" onclick="document.getElementById('platformLogoFile').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg whitespace-nowrap"> ğŸ“¤ Carica File </button>
         </div><input type="file" id="platformLogoFile" accept="image/png,image/jpeg,image/jpg,image/gif" onchange="handlePlatformLogoUpload(event)" class="hidden">
         <p class="text-xs text-gray-500 mt-1">Formato consigliato: PNG trasparente, max 2MB. ApparirÃ  in alto a sinistra del certificato.</p>
         <div id="platformLogoPreview" class="mt-2 hidden">
          <p class="text-xs text-gray-600 mb-1">Anteprima:</p><img id="platformLogoPreviewImg" class="h-16 border border-gray-200 rounded" alt="Preview logo piattaforma">
         </div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
         <p class="text-sm text-blue-900 font-medium mb-2">ğŸ“ Nota sui Loghi Aziendali</p>
         <p class="text-xs text-blue-800">Il logo dell'azienda dello studente viene configurato nella sezione "Gestione Studenti" e apparirÃ  automaticamente in alto a destra nel certificato. Ogni studente avrÃ  il logo della propria azienda.</p>
        </div>
        <div class="flex space-x-3 pt-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> ï¿½ï¿½ Salva Configurazione </button> <button type="button" onclick="previewCertificate()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium"> ğŸ‘ï¸ Anteprima </button>
        </div>
       </form>
      </div><!-- EmailJS Configuration -->
      <div class="border-b border-gray-200 pb-6 mb-6">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h4 class="text-lg font-medium text-gray-800">ğŸ“§ Configurazione EmailJS</h4>
         <p class="text-sm text-gray-600 mt-1">Imposta le credenziali per l'invio automatico delle email</p>
        </div>
        <div id="emailStatusBadge" class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
         âŒ Non Configurato
        </div>
       </div>
       <form onsubmit="saveEmailJSConfig(event)" class="space-y-4">
        <div><label for="emailJSPublicKey" class="block text-sm font-medium text-gray-700 mb-2">Public Key</label> <input type="text" id="emailJSPublicKey" placeholder="es: xYz123AbC456" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div><label for="emailJSServiceID" class="block text-sm font-medium text-gray-700 mb-2">Service ID</label> <input type="text" id="emailJSServiceID" placeholder="es: service_abc123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div><label for="emailJSTemplateID" class="block text-sm font-medium text-gray-700 mb-2">Template ID</label> <input type="text" id="emailJSTemplateID" placeholder="es: template_xyz789" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div class="flex space-x-3"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> ğŸ’¾ Salva Configurazione </button> <button type="button" onclick="testEmailJSConfig()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium"> ğŸ§ª Test Email </button>
        </div>
       </form>
      </div><!-- Supabase Info -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border-2 border-green-200">
       <div class="flex items-center justify-between mb-4">
        <div>
         <h3 class="text-xl font-semibold text-gray-800 mb-1">âš¡ Supabase Database</h3>
         <p class="text-sm text-gray-600">PostgreSQL in cloud - PiÃ¹ semplice di Firebase</p>
        </div>
        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center"><span class="text-white text-xl">âœ…</span>
        </div>
       </div>
       <div class="space-y-3">
        <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
         <p class="text-sm text-gray-700 font-medium mb-2">ğŸ¯ Vantaggi Supabase:</p>
         <ul class="text-xs text-gray-600 space-y-1 ml-4">
          <li>âœ… <strong>Setup veloce</strong> - Solo 2 credenziali</li>
          <li>âœ… <strong>PostgreSQL</strong> - Database professionale</li>
          <li>âœ… <strong>Dashboard intuitiva</strong> - Visualizza dati facilmente</li>
          <li>âœ… <strong>Gratis</strong> - 500 MB storage + 2 GB bandwidth</li>
         </ul>
        </div><button onclick="showModal('supabaseConfigModal')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors font-medium"> ğŸ”§ Riconfigura Supabase </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Student Dashboard -->
   <div id="studentDashboard" class="hidden max-w-7xl mx-auto p-6">
    <div class="mb-8">
     <h2 class="text-3xl font-bold text-gray-800 mb-2">I Miei Corsi</h2>
     <p class="text-gray-600">Accedi ai tuoi corsi - Sincronizzato con Supabase âš¡</p>
    </div>
    <div id="studentCoursesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    </div>
   </div>
  </div><!-- Add Company Modal -->
  <div id="addCompanyModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Azienda</h3><button onclick="hideModal('addCompanyModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div>
     <form onsubmit="addCompany(event)" class="space-y-4">
      <div><label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Denominazione Sociale</label> <input type="text" id="companyName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyVatNumber" class="block text-sm font-medium text-gray-700 mb-1">Partita IVA</label> <input type="text" id="companyVatNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyWebsite" class="block text-sm font-medium text-gray-700 mb-1">Sito Web</label> <input type="url" id="companyWebsite" placeholder="https://esempio.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyReferentName" class="block text-sm font-medium text-gray-700 mb-1">Nome Referente</label> <input type="text" id="companyReferentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyReferentSurname" class="block text-sm font-medium text-gray-700 mb-1">Cognome Referente</label> <input type="text" id="companyReferentSurname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyReferentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Referente</label> <input type="email" id="companyReferentEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefono</label> <input type="tel" id="companyPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="companyLogoUrl" class="block text-sm font-medium text-gray-700 mb-1">Logo Azienda</label>
       <div class="flex space-x-2"><input type="url" id="companyLogoUrl" placeholder="https://esempio.com/logo.png o carica file" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"> <button type="button" onclick="document.getElementById('companyLogoFileInput').click()" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg whitespace-nowrap text-sm"> ğŸ“¤ Carica </button>
       </div><input type="file" id="companyLogoFileInput" accept="image/png,image/jpeg,image/jpg,image/gif" onchange="handleCompanyLogoFileUpload(event)" class="hidden">
       <p class="text-xs text-gray-500 mt-1">Opzionale - Formato consigliato: PNG trasparente (max 2MB)</p>
       <div id="companyLogoUploadPreview" class="mt-2 hidden">
        <p class="text-xs text-gray-600 mb-1">Anteprima:</p><img id="companyLogoUploadPreviewImg" class="h-12 border border-gray-200 rounded" alt="Preview logo">
       </div>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addCompanyModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Add Student Modal -->
  <div id="addStudentModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Studente</h3><button onclick="hideModal('addStudentModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div>
     <form onsubmit="addStudent(event)" class="space-y-4">
      <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">Nome</label> <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentSurname" class="block text-sm font-medium text-gray-700 mb-1">Cognome</label> <input type="text" id="studentSurname" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label> <input type="email" id="studentEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentPhone" class="block text-sm font-medium text-gray-700 mb-1">Telefono</label> <input type="tel" id="studentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="studentCompany" class="block text-sm font-medium text-gray-700 mb-1">Azienda</label> <select id="studentCompany" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"> <option value="">-- Seleziona Azienda --</option> </select>
       <p class="text-xs text-gray-500 mt-1">Se l'azienda non Ã¨ presente, aggiungila nella sezione "Gestione Aziende"</p>
      </div>
      <div id="studentCompanyLogoSection"><label class="block text-sm font-medium text-gray-700 mb-1">Logo Azienda</label> <input type="hidden" id="studentCompanyLogo">
       <div id="companyLogoPreview" class="mt-2 hidden">
        <p class="text-xs text-gray-600 mb-1">Logo dell'azienda selezionata:</p><img id="companyLogoPreviewImg" class="h-16 border border-gray-200 rounded" alt="Preview logo azienda">
       </div>
       <p class="text-xs text-gray-500 mt-2">ğŸ’¡ Il logo viene caricato automaticamente dalla sezione "Gestione Aziende"</p>
      </div>
      <div><label for="studentRole" class="block text-sm font-medium text-gray-700 mb-1">Ruolo</label> <select id="studentRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"> <option value="student">ğŸ‘¤ Studente</option> <option value="admin">ğŸ‘‘ Amministratore</option> </select>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addStudentModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Assign Courses Modal -->
  <div id="assignCoursesModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <div>
       <h3 class="text-xl font-semibold text-gray-800">Assegna Corsi</h3>
       <p class="text-sm text-gray-600 mt-1" id="assignStudentName"></p>
      </div><button onclick="hideModal('assignCoursesModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div>
     <div class="mb-4">
      <p class="text-sm font-medium text-gray-700 mb-3">Seleziona i corsi da assegnare:</p>
      <div id="coursesCheckboxList" class="space-y-2 max-h-96 overflow-y-auto border border-gray-200 rounded-lg p-4">
      </div>
     </div>
     <div class="flex space-x-3 pt-4"><button onclick="hideModal('assignCoursesModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button onclick="saveCoursesAssignment()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> ğŸ’¾ Salva Assegnazioni </button>
     </div>
    </div>
   </div>
  </div><!-- Add Course Modal -->
  <div id="addCourseModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Crea Nuovo Corso</h3><button onclick="hideModal('addCourseModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div>
     <form onsubmit="addCourse(event)" class="space-y-4">
      <div><label for="courseTitle" class="block text-sm font-medium text-gray-700 mb-1">Titolo del Corso</label> <input type="text" id="courseTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      <div><label for="courseDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrizione</label> <textarea id="courseDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
      </div>
      <div class="flex items-center space-x-2"><input type="checkbox" id="courseHasCertificate" class="rounded" checked> <label for="courseHasCertificate" class="text-sm font-medium text-gray-700">Rilascia certificato finale</label>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addCourseModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> Crea Corso </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Course Editor Modal -->
  <div id="courseEditorModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <div>
       <h3 class="text-2xl font-semibold text-gray-800" id="editorCourseTitle"></h3>
       <p class="text-sm text-gray-600 mt-1">Gestisci moduli, contenuti e test</p>
      </div><button onclick="hideModal('courseEditorModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div>
     <div class="flex space-x-6"><!-- Left: Modules List -->
      <div class="w-1/3 border-r border-gray-200 pr-6">
       <div class="flex justify-between items-center mb-4">
        <h4 class="font-semibold text-gray-800">ğŸ“š Moduli</h4><button onclick="addModule()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm"> â• Modulo </button>
       </div>
       <div id="modulesList" class="space-y-2 max-h-96 overflow-y-auto">
       </div>
      </div><!-- Right: Module Editor -->
      <div class="flex-1">
       <div id="moduleEditorEmpty" class="text-center py-12 text-gray-500">
        <p class="text-lg">ï¿½ï¿½ Seleziona o crea un modulo per iniziare</p>
       </div>
       <div id="moduleEditorContent" class="hidden">
        <div class="mb-6"><label for="moduleTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo Modulo</label> <input type="text" id="moduleTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        <div class="mb-6"><label for="moduleDescription" class="block text-sm font-medium text-gray-700 mb-2">Descrizione</label> <textarea id="moduleDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
        </div><!-- Media Section -->
        <div class="mb-6">
         <div class="flex justify-between items-center mb-3">
          <h5 class="font-semibold text-gray-800">ğŸ¬ Contenuti Media</h5><button onclick="addMedia()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm"> â• Media </button>
         </div>
         <div id="mediaList" class="space-y-2">
         </div>
        </div><!-- Test Section -->
        <div class="mb-6">
         <div class="flex justify-between items-center mb-3">
          <h5 class="font-semibold text-gray-800">ğŸ“ Test Fine Modulo</h5><button onclick="toggleModuleTest()" id="toggleTestBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg text-sm"> â• Aggiungi Test </button>
         </div>
         <div id="testSection" class="hidden">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
           <div class="mb-3"><label class="block text-sm font-medium text-gray-700 mb-1">Punteggio Minimo (%)</label> <input type="number" id="testMinScore" min="0" max="100" value="70" class="w-32 px-3 py-2 border border-gray-300 rounded-lg">
           </div><button onclick="manageQuestions()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm"> ğŸ“‹ Gestisci Domande </button> <span id="questionCount" class="ml-3 text-sm text-gray-600">0 domande</span>
          </div>
         </div>
        </div>
        <div class="flex space-x-3 pt-4 border-t border-gray-200"><button onclick="saveModule()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"> ğŸ’¾ Salva Modulo </button> <button onclick="deleteModule()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"> ğŸ—‘ï¸ Elimina </button>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Add Media Modal -->
  <div id="addMediaModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Aggiungi Media</h3><button onclick="hideModal('addMediaModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">ï¿½ï¿½</span> </button>
     </div>
     <form onsubmit="saveMedia(event)" class="space-y-4">
      <div><label for="mediaType" class="block text-sm font-medium text-gray-700 mb-2">Tipo Media</label> <select id="mediaType" class="w-full px-3 py-2 border border-gray-300 rounded-lg" onchange="updateMediaForm()"> <option value="video">ğŸ¥ Video (YouTube, Vimeo)</option> <option value="pdf">ğŸ“„ PDF</option> <option value="link">ğŸ”— Link Esterno</option> <option value="text">ğŸ“ Testo/Articolo</option> </select>
      </div>
      <div><label for="mediaTitle" class="block text-sm font-medium text-gray-700 mb-2">Titolo</label> <input type="text" id="mediaTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
      </div>
      <div id="mediaUrlField"><label for="mediaUrl" class="block text-sm font-medium text-gray-700 mb-2">URL</label> <input type="url" id="mediaUrl" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="https://">
      </div>
      <div id="mediaTextField" class="hidden"><label for="mediaText" class="block text-sm font-medium text-gray-700 mb-2">Contenuto</label> <textarea id="mediaText" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
      </div>
      <div class="flex space-x-3 pt-4"><button type="button" onclick="hideModal('addMediaModal')" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"> Annulla </button> <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"> Aggiungi </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Questions Manager Modal -->
  <div id="questionsModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-full overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold text-gray-800">Gestione Domande Test</h3><button onclick="hideModal('questionsModal')" class="text-gray-400 hover:text-gray-600"> <span class="text-2xl">Ã—</span> </button>
     </div><button onclick="addQuestion()" class="mb-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg"> â• Nuova Domanda </button>
     <div id="questionsList" class="space-y-4">
     </div>
     <div class="flex justify-end pt-4 border-t border-gray-200 mt-6"><button onclick="hideModal('questionsModal')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg"> âœ… Fatto </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // ==========================================
        // SUPABASE CONFIGURATION & INITIALIZATION
        // ==========================================
        
        // ğŸ”¥ INSERISCI QUI LE TUE CREDENZIALI SUPABASE
        const SUPABASE_CONFIG = {
            url: 'https://tuoprogetto.supabase.co',  // âš ï¸ SOSTITUISCI CON IL TUO PROJECT URL
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'  // âš ï¸ SOSTITUISCI CON LA TUA ANON PUBLIC KEY
        };
        
        let supabase = null;
        let allStudents = [];
        let allCourses = [];
        let allProgress = [];
        let allEnrollments = [];
        let allCompanies = [];
        let currentUser = null;
        let currentAssigningStudent = null;

        function loadSupabaseConfig() {
            // Prima controlla se ci sono credenziali hardcoded valide
            if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.key && 
                SUPABASE_CONFIG.url !== 'https://tuoprogetto.supabase.co' &&
                SUPABASE_CONFIG.key.length > 50) {
                return SUPABASE_CONFIG;
            }
            
            // Altrimenti cerca nel localStorage (per compatibilitÃ )
            const savedConfig = localStorage.getItem('supabase_config');
            if (savedConfig) {
                return JSON.parse(savedConfig);
            }
            return null;
        }

        function saveSupabaseConfig(event) {
            event.preventDefault();
            
            const config = {
                url: document.getElementById('supabaseUrl').value.trim(),
                key: document.getElementById('supabaseKey').value.trim()
            };
            
            localStorage.setItem('supabase_config', JSON.stringify(config));
            hideModal('supabaseConfigModal');
            showNotification('âœ… Configurazione salvata! Ricarica la pagina.', 'success');
            
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        async function initSupabase() {
            const config = loadSupabaseConfig();
            
            if (!config) {
                // Controlla se siamo in un link di attivazione
                const urlParams = new URLSearchParams(window.location.search);
                const isActivationLink = urlParams.get('action') === 'activate';
                
                if (isActivationLink) {
                    // Link di attivazione: mostra istruzioni per configurare Supabase
                    console.log('ğŸ”— Link attivazione senza config Supabase');
                    showActivationConfigNeeded();
                    return false;
                } else {
                    // Amministratore: chiedi configurazione
                    showModal('supabaseConfigModal');
                    return false;
                }
            }
            
            try {
                // Crea client Supabase
                supabase = window.supabase.createClient(config.url, config.key);
                console.log('âœ… Supabase connesso');
                
                // Carica dati in background (non blocca)
                loadAllData().catch(err => {
                    console.warn('ï¿½ï¿½ï¿½ï¸ Database vuoto:', err.message);
                });
                
                return true;
                
            } catch (error) {
                console.error('âŒ Errore Supabase:', error);
                showNotification(`âŒ Errore: ${error.message}`, 'error');
                return false;
            }
        }

        function showActivationConfigNeeded() {
            document.getElementById('loginScreen').classList.remove('hidden');
            
            const instructionDiv = document.createElement('div');
            instructionDiv.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
            instructionDiv.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl">âš ï¸</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Configurazione Mancante</h2>
                        <p class="text-gray-600 mt-2">Per attivare il tuo account, l'amministratore deve configurare prima la piattaforma.</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <p class="text-sm text-blue-900 mb-3"><strong>ğŸ“§ Cosa fare:</strong></p>
                        <ol class="text-xs text-blue-800 space-y-2 ml-4">
                            <li><strong>1.</strong> Contatta l'amministratore della piattaforma</li>
                            <li><strong>2.</strong> Chiedi di configurare Supabase</li>
                            <li><strong>3.</strong> Clicca di nuovo sul link che hai ricevuto via email</li>
                        </ol>
                    </div>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p class="text-xs text-gray-600">ï¿½ï¿½ <strong>Per gli amministratori:</strong> Apri la piattaforma normalmente e configura Supabase nelle impostazioni, poi gli studenti potranno attivare i loro account.</p>
                    </div>
                    
                    <button onclick="window.location.reload()" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold">
                        ï¿½ï¿½ï¿½ Ricarica Pagina
                    </button>
                </div>
            `;
            
            document.body.appendChild(instructionDiv);
        }

        async function initializeDatabase() {
            showLoading('Creazione tabelle...');
            
            try {
                const { data: existingStudents, error: studentsCheckError } = await supabase
                    .from('students')
                    .select('id')
                    .limit(1);
                
                if (!studentsCheckError) {
                    localStorage.setItem('supabase_db_setup_done', 'true');
                    hideLoading();
                    hideModal('dbSetupModal');
                    showNotification('âœ… Database giÃ  inizializzato!', 'success');
                    
                    await loadAllData();
                    return;
                }
                
                hideLoading();
                hideModal('dbSetupModal');
                
                const instructionsModal = document.createElement('div');
                instructionsModal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
                instructionsModal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-full overflow-y-auto p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ Crea le Tabelle in Supabase</h2>
                        <p class="text-gray-600 mb-4">Segui questi passaggi nella dashboard di Supabase:</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <ol class="text-sm text-gray-800 space-y-2 ml-4">
                                <li><strong>1.</strong> Vai su <a href="https://app.supabase.com" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">app.supabase.com</a></li>
                                <li><strong>2.</strong> Seleziona il tuo progetto</li>
                                <li><strong>3.</strong> Clicca su "SQL Editor" nel menu laterale</li>
                                <li><strong>4.</strong> Copia e incolla questo codice SQL:</li>
                            </ol>
                        </div>
                        
                        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mb-4 overflow-x-auto">
                            <pre class="text-xs"><code>-- Tabella Studenti (con logo aziendale)
CREATE TABLE students (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  surname TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT,
  company TEXT NOT NULL,
  company_logo TEXT,
  role TEXT DEFAULT 'student',
  status TEXT DEFAULT 'active',
  password TEXT,
  registration_date TIMESTAMP DEFAULT NOW()
);

-- Tabella Corsi (con moduli in JSONB)
CREATE TABLE courses (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  has_certificate BOOLEAN DEFAULT false,
  modules JSONB DEFAULT '[]'::jsonb,
  status TEXT DEFAULT 'published',
  created_date TIMESTAMP DEFAULT NOW(),
  created_by TEXT
);

-- Tabella Progressi (con progresso moduli in JSONB)
CREATE TABLE progress (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  completed BOOLEAN DEFAULT false,
  completed_modules INTEGER DEFAULT 0,
  module_progress JSONB DEFAULT '{}'::jsonb,
  completion_date TIMESTAMP,
  score INTEGER
);

-- Tabella Iscrizioni (enrollments) â­ NUOVO!
CREATE TABLE enrollments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  enrolled_date TIMESTAMP DEFAULT NOW(),
  assigned_by TEXT,
  UNIQUE(student_id, course_id)
);

-- Abilita Row Level Security (importante!)
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;

-- Policy per permettere tutte le operazioni (per ora)
CREATE POLICY "Enable all for students" ON students FOR ALL USING (true);
CREATE POLICY "Enable all for courses" ON courses FOR ALL USING (true);
CREATE POLICY "Enable all for progress" ON progress FOR ALL USING (true);
CREATE POLICY "Enable all for enrollments" ON enrollments FOR ALL USING (true);

-- Indici per query veloci
CREATE INDEX idx_enrollments_student ON enrollments(student_id);
CREATE INDEX idx_enrollments_course ON enrollments(course_id);</code></pre>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <p class="text-sm text-yellow-800 font-semibold mb-2">âš ï¸ Se hai giÃ  creato le tabelle prima:</p>
                            <p class="text-xs text-yellow-700 mb-2">Esegui queste righe per aggiungere enrollments e company_logo:</p>
                            <div class="bg-gray-900 text-gray-100 p-3 rounded mt-2 overflow-x-auto">
                                <pre class="text-xs"><code>-- Aggiungi colonna logo aziendale alla tabella students
ALTER TABLE students ADD COLUMN IF NOT EXISTS company_logo TEXT;

-- Aggiungi tabella enrollments (se altre tabelle giÃ  esistono)
CREATE TABLE IF NOT EXISTS enrollments (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id UUID REFERENCES students(id) ON DELETE CASCADE,
  course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
  enrolled_date TIMESTAMP DEFAULT NOW(),
  assigned_by TEXT,
  UNIQUE(student_id, course_id)
);

ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all for enrollments" ON enrollments FOR ALL USING (true);
CREATE INDEX idx_enrollments_student ON enrollments(student_id);
CREATE INDEX idx_enrollments_course ON enrollments(course_id);</code></pre>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <p class="text-sm text-yellow-800">âš ï¸ <strong>Importante:</strong> Dopo aver eseguito il codice SQL, clicca "Fatto" qui sotto.</p>
                        </div>
                        
                        <button onclick="completeDatabaseSetup()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold">
                            âœ… Fatto - Ho creato le tabelle
                        </button>
                    </div>
                `;
                
                document.body.appendChild(instructionsModal);
                
            } catch (error) {
                hideLoading();
                showNotification('ï¿½ï¿½ï¿½ Errore: ' + error.message, 'error');
            }
        }

        async function completeDatabaseSetup() {
            const modal = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            
            showLoading('Verifica tabelle...');
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    hideLoading();
                    showNotification('âŒ Tabelle non trovate. Verifica di aver eseguito il codice SQL correttamente.', 'error');
                    return;
                }
                
                localStorage.setItem('supabase_db_setup_done', 'true');
                
                await loadAllData();
                
                hideLoading();
                showNotification('âœ… Database pronto! Piattaforma operativa.', 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore verifica: ' + error.message, 'error');
            }
        }

        function skipDatabaseSetup() {
            localStorage.setItem('supabase_db_setup_done', 'true');
            hideModal('dbSetupModal');
            
            loadAllData().catch(() => {
                console.log('DB vuoto');
            });
        }

        async function loadAllData() {
            try {
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('registration_date', { ascending: false });
                
                if (studentsError) throw studentsError;
                allStudents = students || [];
                
                const { data: courses, error: coursesError } = await supabase
                    .from('courses')
                    .select('*')
                    .order('created_date', { ascending: false });
                
                if (coursesError) throw coursesError;
                allCourses = courses || [];
                
                const { data: progress, error: progressError } = await supabase
                    .from('progress')
                    .select('*');
                
                if (progressError) throw progressError;
                allProgress = progress || [];
                
                const { data: enrollments, error: enrollmentsError } = await supabase
                    .from('enrollments')
                    .select('*');
                
                if (enrollmentsError) throw enrollmentsError;
                allEnrollments = enrollments || [];
                
                const { data: companies, error: companiesError } = await supabase
                    .from('companies')
                    .select('*')
                    .order('company_name', { ascending: true });
                
                if (companiesError && companiesError.code !== 'PGRST116') throw companiesError;
                allCompanies = companies || [];
                
                console.log('ğŸ“Š Dati caricati:', allStudents.length, 'studenti,', allCourses.length, 'corsi,', allEnrollments.length, 'iscrizioni,', allCompanies.length, 'aziende');
                
            } catch (error) {
                console.error('âŒ Errore caricamento dati:', error);
                throw error;
            }
        }

        // ==========================================
        // ENROLLMENT MANAGEMENT
        // ==========================================

        function getStudentEnrolledCourses(studentId) {
            return allEnrollments
                .filter(e => e.student_id === studentId)
                .map(e => e.course_id);
        }

        function getStudentEnrollmentCount(studentId) {
            return allEnrollments.filter(e => e.student_id === studentId).length;
        }

        function openAssignCoursesModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            currentAssigningStudent = student;
            document.getElementById('assignStudentName').textContent = `${student.name} ${student.surname}`;
            
            const enrolledCourseIds = getStudentEnrolledCourses(studentId);
            
            const checkboxList = document.getElementById('coursesCheckboxList');
            
            if (allCourses.length === 0) {
                checkboxList.innerHTML = '<p class="text-gray-500 text-center py-4">Nessun corso disponibile</p>';
            } else {
                checkboxList.innerHTML = allCourses.map(course => {
                    const isEnrolled = enrolledCourseIds.includes(course.id);
                    return `
                        <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" 
                                   class="course-checkbox rounded" 
                                   data-course-id="${course.id}" 
                                   ${isEnrolled ? 'checked' : ''}>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${course.title}</p>
                                <p class="text-xs text-gray-500">${course.description || ''}</p>
                            </div>
                        </label>
                    `;
                }).join('');
            }
            
            showModal('assignCoursesModal');
        }

        async function saveCoursesAssignment() {
            if (!currentAssigningStudent) return;
            
            showLoading('Salvat aggio iscrizioni...');
            
            const checkboxes = document.querySelectorAll('.course-checkbox');
            const selectedCourseIds = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.courseId);
            
            const currentEnrollments = allEnrollments.filter(e => e.student_id === currentAssigningStudent.id);
            const currentCourseIds = currentEnrollments.map(e => e.course_id);
            
            // Corsi da aggiungere
            const toAdd = selectedCourseIds.filter(id => !currentCourseIds.includes(id));
            // Corsi da rimuovere
            const toRemove = currentCourseIds.filter(id => !selectedCourseIds.includes(id));
            
            try {
                // Aggiungi nuove iscrizioni
                if (toAdd.length > 0) {
                    const newEnrollments = toAdd.map(courseId => ({
                        student_id: currentAssigningStudent.id,
                        course_id: courseId,
                        enrolled_date: new Date().toISOString()
                    }));
                    
                    const { data, error } = await supabase
                        .from('enrollments')
                        .insert(newEnrollments)
                        .select();
                    
                    if (error) throw error;
                    
                    allEnrollments.push(...data);
                }
                
                // Rimuovi iscrizioni
                if (toRemove.length > 0) {
                    const enrollmentsToDelete = currentEnrollments.filter(e => toRemove.includes(e.course_id));
                    
                    for (const enrollment of enrollmentsToDelete) {
                        const { error } = await supabase
                            .from('enrollments')
                            .delete()
                            .eq('id', enrollment.id);
                        
                        if (error) throw error;
                        
                        allEnrollments = allEnrollments.filter(e => e.id !== enrollment.id);
                    }
                }
                
                hideLoading();
                hideModal('assignCoursesModal');
                loadStudents();
                showNotification(`âœ… Iscrizioni aggiornate!\n${toAdd.length} corsi aggiunti, ${toRemove.length} rimossi.`, 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // IMAGE UPLOAD HELPERS
        // ==========================================

        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handlePlatformLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('âš ï¸ Seleziona un file immagine valido', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('âš ï¸ Immagine troppo grande (max 2MB)', 'error');
                return;
            }
            
            showLoading('Caricamento logo...');
            
            try {
                const base64 = await convertImageToBase64(file);
                document.getElementById('certPlatformLogo').value = base64;
                
                // Mostra anteprima
                const preview = document.getElementById('platformLogoPreview');
                const previewImg = document.getElementById('platformLogoPreviewImg');
                previewImg.src = base64;
                preview.classList.remove('hidden');
                
                hideLoading();
                showNotification('âœ… Logo caricato!', 'success');
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore caricamento: ' + error.message, 'error');
            }
            
            event.target.value = '';
        }

        async function handleCompanyLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('âš ï¸ Seleziona un file immagine valido', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('âš ï¸ Immagine troppo grande (max 2MB)', 'error');
                return;
            }
            
            showLoading('Caricamento logo...');
            
            try {
                const base64 = await convertImageToBase64(file);
                document.getElementById('studentCompanyLogo').value = base64;
                
                // Mostra anteprima
                const preview = document.getElementById('companyLogoPreview');
                const previewImg = document.getElementById('companyLogoPreviewImg');
                previewImg.src = base64;
                preview.classList.remove('hidden');
                
                hideLoading();
                showNotification('âœ… Logo caricato!', 'success');
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore caricamento: ' + error.message, 'error');
            }
            
            event.target.value = '';
        }

        // ==========================================
        // CERTIFICATE CUSTOMIZATION
        // ==========================================

        let certificateConfig = {
            title: 'CERTIFICATO DI COMPLETAMENTO',
            subtitle: 'ha completato con successo il corso',
            footerText: 'EduPlatform - Formazione Professionale',
            signature: 'Direttore Formazione',
            primaryColor: '#10b981',
            secondaryColor: '#1f2937',
            platformLogo: '' // Logo della piattaforma (sinistra)
        };

        function loadCertificateConfig() {
            try {
                const savedConfig = localStorage.getItem('certificate_config');
                if (savedConfig) {
                    certificateConfig = { ...certificateConfig, ...JSON.parse(savedConfig) };
                }
                
                // Popola i campi del form
                document.getElementById('certTitle').value = certificateConfig.title;
                document.getElementById('certSubtitle').value = certificateConfig.subtitle;
                document.getElementById('certFooterText').value = certificateConfig.footerText;
                document.getElementById('certSignature').value = certificateConfig.signature;
                document.getElementById('certPrimaryColor').value = certificateConfig.primaryColor;
                document.getElementById('certPrimaryColorHex').value = certificateConfig.primaryColor;
                document.getElementById('certSecondaryColor').value = certificateConfig.secondaryColor;
                document.getElementById('certSecondaryColorHex').value = certificateConfig.secondaryColor;
                document.getElementById('certPlatformLogo').value = certificateConfig.platformLogo || '';
                
                // Mostra anteprima logo se presente
                if (certificateConfig.platformLogo) {
                    const preview = document.getElementById('platformLogoPreview');
                    const previewImg = document.getElementById('platformLogoPreviewImg');
                    previewImg.src = certificateConfig.platformLogo;
                    preview.classList.remove('hidden');
                }
                
                // Sincronizza color picker con hex input
                document.getElementById('certPrimaryColor').addEventListener('input', (e) => {
                    document.getElementById('certPrimaryColorHex').value = e.target.value;
                });
                document.getElementById('certPrimaryColorHex').addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        document.getElementById('certPrimaryColor').value = e.target.value;
                    }
                });
                document.getElementById('certSecondaryColor').addEventListener('input', (e) => {
                    document.getElementById('certSecondaryColorHex').value = e.target.value;
                });
                document.getElementById('certSecondaryColorHex').addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        document.getElementById('certSecondaryColor').value = e.target.value;
                    }
                });
            } catch (error) {
                console.warn('Errore caricamento config certificato:', error);
            }
        }

        function saveCertificateConfig(event) {
            event.preventDefault();
            
            certificateConfig = {
                title: document.getElementById('certTitle').value.trim() || 'CERTIFICATO DI COMPLETAMENTO',
                subtitle: document.getElementById('certSubtitle').value.trim() || 'ha completato con successo il corso',
                footerText: document.getElementById('certFooterText').value.trim() || 'EduPlatform',
                signature: document.getElementById('certSignature').value.trim() || '',
                primaryColor: document.getElementById('certPrimaryColorHex').value || '#10b981',
                secondaryColor: document.getElementById('certSecondaryColorHex').value || '#1f2937',
                platformLogo: document.getElementById('certPlatformLogo').value.trim() || ''
            };
            
            try {
                localStorage.setItem('certificate_config', JSON.stringify(certificateConfig));
                showNotification('âœ… Configurazione certificato salvata!', 'success');
            } catch (error) {
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        function previewCertificate() {
            // Salva temporaneamente la configurazione corrente
            const tempConfig = {
                title: document.getElementById('certTitle').value.trim() || 'CERTIFICATO DI COMPLETAMENTO',
                subtitle: document.getElementById('certSubtitle').value.trim() || 'ha completato con successo il corso',
                footerText: document.getElementById('certFooterText').value.trim() || 'EduPlatform',
                signature: document.getElementById('certSignature').value.trim() || '',
                primaryColor: document.getElementById('certPrimaryColorHex').value || '#10b981',
                secondaryColor: document.getElementById('certSecondaryColorHex').value || '#1f2937',
                platformLogo: document.getElementById('certPlatformLogo').value.trim() || ''
            };
            
            generateCertificatePreview(tempConfig, {
                studentName: currentUser?.name || 'Mario Rossi',
                courseName: 'Corso di Esempio',
                completionDate: new Date().toLocaleDateString('it-IT'),
                companyLogo: 'https://via.placeholder.com/150x75/3b82f6/ffffff?text=AZIENDA'
            });
        }

        function generateCertificatePreview(config, data) {
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 800;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 1200, 800);
            
            // Border decorativo
            ctx.strokeStyle = config.primaryColor;
            ctx.lineWidth = 12;
            ctx.strokeRect(40, 40, 1120, 720);
            
            ctx.strokeStyle = config.secondaryColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(60, 60, 1080, 680);
            
            // Caricamento loghi (piattaforma sinistra, azienda destra)
            const logosToLoad = [];
            let loadedLogos = 0;
            const totalLogos = (config.platformLogo ? 1 : 0) + (data.companyLogo ? 1 : 0);
            
            function checkAllLogosLoaded() {
                if (loadedLogos >= totalLogos) {
                    continueDrawing();
                }
            }
            
            if (config.platformLogo) {
                const platformLogo = new Image();
                platformLogo.crossOrigin = 'anonymous';
                platformLogo.onload = function() {
                    logosToLoad.push({ img: platformLogo, position: 'left' });
                    loadedLogos++;
                    checkAllLogosLoaded();
                };
                platformLogo.onerror = function() {
                    console.warn('Logo piattaforma non caricato');
                    loadedLogos++;
                    checkAllLogosLoaded();
                };
                platformLogo.src = config.platformLogo;
            }
            
            if (data.companyLogo) {
                const companyLogo = new Image();
                companyLogo.crossOrigin = 'anonymous';
                companyLogo.onload = function() {
                    logosToLoad.push({ img: companyLogo, position: 'right' });
                    loadedLogos++;
                    checkAllLogosLoaded();
                };
                companyLogo.onerror = function() {
                    console.warn('Logo azienda non caricato');
                    loadedLogos++;
                    checkAllLogosLoaded();
                };
                companyLogo.src = data.companyLogo;
            }
            
            // Se non ci sono loghi, procedi subito
            if (totalLogos === 0) {
                continueDrawing();
            }
            
            function continueDrawing() {
                // Disegna i loghi caricati
                logosToLoad.forEach(logoData => {
                    const logoWidth = 150;
                    const logoHeight = (logoData.img.height / logoData.img.width) * logoWidth;
                    const logoX = logoData.position === 'left' ? 80 : 970;
                    ctx.drawImage(logoData.img, logoX, 80, logoWidth, logoHeight);
                });
                
                const hasLogos = logosToLoad.length > 0;
                const startY = hasLogos ? 230 : 150;
                
                // Titolo
                ctx.fillStyle = config.secondaryColor;
                ctx.font = 'bold 56px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(config.title, 600, startY);
                
                // Decorazione sotto il titolo
                ctx.fillStyle = config.primaryColor;
                ctx.fillRect(450, startY + 20, 300, 4);
                
                // Sottotitolo
                ctx.fillStyle = config.secondaryColor;
                ctx.font = '28px Arial, sans-serif';
                ctx.fillText(config.subtitle, 600, startY + 100);
                
                // Nome studente (evidenziato)
                ctx.font = 'bold 48px Arial, sans-serif';
                ctx.fillStyle = config.primaryColor;
                ctx.fillText(data.studentName, 600, startY + 180);
                
                // Nome corso
                ctx.font = '32px Arial, sans-serif';
                ctx.fillStyle = config.secondaryColor;
                ctx.fillText('per aver completato il corso', 600, startY + 260);
                
                ctx.font = 'bold 38px Arial, sans-serif';
                ctx.fillStyle = config.primaryColor;
                ctx.fillText(`"${data.courseName}"`, 600, startY + 320);
                
                // Data
                ctx.fillStyle = '#6b7280';
                ctx.font = '22px Arial, sans-serif';
                ctx.fillText(`Rilasciato il ${data.completionDate}`, 600, startY + 400);
                
                // Firma
                if (config.signature) {
                    ctx.fillStyle = config.secondaryColor;
                    ctx.font = 'italic 28px Arial, sans-serif';
                    ctx.fillText(config.signature, 600, startY + 480);
                    
                    // Linea firma
                    ctx.strokeStyle = config.secondaryColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(450, startY + 460);
                    ctx.lineTo(750, startY + 460);
                    ctx.stroke();
                }
                
                // Footer
                if (config.footerText) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '18px Arial, sans-serif';
                    ctx.fillText(config.footerText, 600, 750);
                }
                
                // Mostra anteprima in modal
                showCertificatePreviewModal(canvas);
            }
        }

        function showCertificatePreviewModal(canvas) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">ğŸ‘ï¸ Anteprima Certificato</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <span class="text-2xl">Ã—</span>
                            </button>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4 flex justify-center items-center" style="min-height: 500px;">
                            <img id="previewImage" class="max-w-full h-auto rounded shadow-lg" />
                        </div>
                        
                        <div class="mt-4 flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Chiudi
                            </button>
                            <button onclick="downloadPreviewCertificate()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                ğŸ“¥ Scarica Anteprima
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Converti canvas in immagine
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                document.getElementById('previewImage').src = url;
                
                // Salva per il download
                modal.previewBlob = blob;
            });
        }

        function downloadPreviewCertificate() {
            const modal = document.querySelector('.modal-backdrop');
            if (!modal || !modal.previewBlob) return;
            
            const url = URL.createObjectURL(modal.previewBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Anteprima_Certificato.png';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ğŸ“¥ Anteprima scaricata!', 'success');
        }

        // ==========================================
        // EMAILJS FUNCTIONS
        // ==========================================

        let emailJSConfig = {
            publicKey: '',
            serviceId: '',
            templateId: ''
        };

        function initEmailJS() {
            if (typeof emailjs !== 'undefined' && emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId) {
                emailjs.init(emailJSConfig.publicKey);
                return true;
            }
            return false;
        }

        function isEmailJSConfigured() {
            return emailJSConfig.publicKey && emailJSConfig.serviceId && emailJSConfig.templateId;
        }

        function generateActivationToken(studentId, email) {
            const timestamp = Date.now();
            const data = `${studentId}-${email}-${timestamp}`;
            return btoa(data);
        }

        async function sendWelcomeEmail(student) {
            if (!initEmailJS()) {
                console.warn('EmailJS non configurato.');
                return { success: false, message: 'EmailJS non configurato' };
            }

            try {
                const activationToken = generateActivationToken(student.id, student.email);
                const activationLink = `${window.location.origin}${window.location.pathname}?action=activate&token=${activationToken}&id=${student.id}`;

                const templateParams = {
                    student_name: `${student.name} ${student.surname}`,
                    student_email: student.email,
                    activation_link: activationLink,
                    platform_name: 'EduPlatform',
                    company_name: student.company
                };

                const response = await emailjs.send(
                    emailJSConfig.serviceId,
                    emailJSConfig.templateId,
                    templateParams
                );

                return { success: true, message: 'Email inviata' };

            } catch (error) {
                console.error('âŒ Errore invio email:', error);
                return { success: false, message: error.text || error.message };
            }
        }

        async function saveEmailJSConfig(event) {
            event.preventDefault();
            
            const publicKey = document.getElementById('emailJSPublicKey').value.trim();
            const serviceId = document.getElementById('emailJSServiceID').value.trim();
            const templateId = document.getElementById('emailJSTemplateID').value.trim();
            
            if (!publicKey || !serviceId || !templateId) {
                showNotification('âš ï¸ Compila tutti i campi!', 'error');
                return;
            }
            
            emailJSConfig.publicKey = publicKey;
            emailJSConfig.serviceId = serviceId;
            emailJSConfig.templateId = templateId;
            
            try {
                localStorage.setItem('emailjs_config', JSON.stringify(emailJSConfig));
                updateEmailStatusBadge();
                showNotification('âœ… Configurazione EmailJS salvata!', 'success');
            } catch (error) {
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        async function testEmailJSConfig() {
            if (!isEmailJSConfigured()) {
                showNotification('âš ï¸ Configura EmailJS prima di testare!', 'error');
                return;
            }
            
            showLoading('Invio email di test...');
            
            const testStudent = {
                id: 'test_' + Date.now(),
                name: 'Test',
                surname: 'Utente',
                email: currentUser.email,
                company: 'Test Company'
            };
            
            const emailResult = await sendWelcomeEmail(testStudent);
            hideLoading();
            
            if (emailResult.success) {
                showNotification(`âœ… Email di test inviata a ${currentUser.email}`, 'success');
            } else {
                showNotification(`âŒ Errore: ${emailResult.message}`, 'error');
            }
        }

        async function loadEmailJSConfig() {
            try {
                const savedConfig = localStorage.getItem('emailjs_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    emailJSConfig = config;
                    
                    document.getElementById('emailJSPublicKey').value = emailJSConfig.publicKey || '';
                    document.getElementById('emailJSServiceID').value = emailJSConfig.serviceId || '';
                    document.getElementById('emailJSTemplateID').value = emailJSConfig.templateId || '';
                    
                    updateEmailStatusBadge();
                }
            } catch (error) {
                console.warn('Errore caricamento config EmailJS:', error);
            }
        }

        function updateEmailStatusBadge() {
            const badge = document.getElementById('emailStatusBadge');
            if (isEmailJSConfigured()) {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                badge.textContent = 'ï¿½ï¿½ Configurato';
            } else {
                badge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                badge.textContent = 'âŒ Non Configurato';
            }
        }

        // ==========================================
        // UI HELPER FUNCTIONS
        // ==========================================

        function showLoading(message = 'Caricamento...', subText = 'Attendere...') {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            updateLoadingText(message, subText);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingText(mainText, subText = 'Attendere...') {
            const loadingTextEl = document.getElementById('loadingText');
            const loadingSubtextEl = document.getElementById('loadingSubtext');
            if (loadingTextEl) loadingTextEl.textContent = mainText;
            if (loadingSubtextEl) loadingSubtextEl.textContent = subText;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            } text-white`;
            notification.style.whiteSpace = 'pre-line';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, type === 'error' ? 10000 : 5000);
        }

        function showModal(modalId) {
            // Se stiamo aprendo il modal studenti, popola le aziende
            if (modalId === 'addStudentModal') {
                populateCompanySelect();
                
                // Se NON stiamo modificando (= nuovo studente), resetta i campi
                if (!document.getElementById('addStudentModal').dataset.editingId) {
                    document.getElementById('studentCompanyLogo').value = '';
                    document.getElementById('companyLogoPreview').classList.add('hidden');
                }
            }
            
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // ==========================================
        // AUTHENTICATION
        // ==========================================

        async function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value;
            
            if (email === 'admin@edu.com' && password === 'admin123') {
                currentUser = { email, role: 'admin', name: 'Amministratore' };
                document.getElementById('currentUser').textContent = currentUser.name;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadStudents();
                loadCourses();
                updateStats();
                return;
            }
            
            const student = allStudents.find(s => s.email.toLowerCase() === email);
            
            if (!student) {
                showNotification('âŒ Email non trovata', 'error');
                return;
            }
            
            if (!student.password) {
                showNotification('âš ï¸ Account non attivato!\nControlla la tua email.', 'error');
                return;
            }
            
            if (student.password !== password) {
                showNotification('âŒ Password errata', 'error');
                return;
            }
            
            currentUser = { 
                email: student.email, 
                role: student.role || 'student', 
                name: `${student.name} ${student.surname}`,
                studentId: student.id
            };
            
            document.getElementById('currentUser').textContent = currentUser.name;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
                loadStudents();
                loadCourses();
                updateStats();
            } else {
                document.getElementById('studentDashboard').classList.remove('hidden');
                loadStudentCourses();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        // ==========================================
        // COMPANY MANAGEMENT
        // ==========================================

        function loadCompanies() {
            const tbody = document.getElementById('companiesTable');
            if (allCompanies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nessuna azienda presente</td></tr>';
                return;
            }
            
            tbody.innerHTML = allCompanies.map(company => {
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${company.company_name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${company.vat_number}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${company.referent_name} ${company.referent_surname}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${company.referent_email || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${company.phone}</td>
                    <td class="px-4 py-3">
                        ${company.website ? `<a href="${company.website}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm">ğŸ”— Sito</a>` : '<span class="text-xs text-gray-400">-</span>'}
                    </td>
                    <td class="px-4 py-3">
                        ${company.logo ? '<span class="text-green-600 text-sm">âœ… Presente</span>' : '<span class="text-xs text-gray-400">-</span>'}
                    </td>
                    <td class="px-4 py-3 space-x-2">
                        <button onclick="editCompany('${company.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Modifica</button>
                        <button onclick="deleteCompany('${company.id}')" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function addCompany(event) {
            event.preventDefault();

            const companyName = document.getElementById('companyName').value.trim();
            const vatNumber = document.getElementById('companyVatNumber').value.trim();
            const website = document.getElementById('companyWebsite').value.trim();
            const referentName = document.getElementById('companyReferentName').value.trim();
            const referentSurname = document.getElementById('companyReferentSurname').value.trim();
            const referentEmail = document.getElementById('companyReferentEmail').value.trim();
            const phone = document.getElementById('companyPhone').value.trim();
            const logo = document.getElementById('companyLogoUrl').value.trim();
            
            const modal = document.getElementById('addCompanyModal');
            const editingId = modal.dataset.editingId;

            // MODALITÃ€ MODIFICA
            if (editingId) {
                const company = allCompanies.find(c => c.id === editingId);
                if (!company) {
                    showNotification('âŒ Azienda non trovata!', 'error');
                    return;
                }
                
                // Controlla duplicato P.IVA solo se Ã¨ cambiata
                if (vatNumber !== company.vat_number) {
                    const duplicate = allCompanies.find(c => c.vat_number === vatNumber && c.id !== editingId);
                    if (duplicate) {
                        showNotification('âŒ Partita IVA giÃ  registrata!', 'error');
                        return;
                    }
                }
                
                showLoading('Aggiornamento azienda...');
                
                try {
                    const { error } = await supabase
                        .from('companies')
                        .update({
                            company_name: companyName,
                            vat_number: vatNumber,
                            website: website || null,
                            referent_name: referentName,
                            referent_surname: referentSurname,
                            referent_email: referentEmail,
                            phone: phone,
                            logo: logo || null
                        })
                        .eq('id', editingId);
                    
                    if (error) throw error;
                    
                    // Aggiorna l'array locale
                    const index = allCompanies.findIndex(c => c.id === editingId);
                    if (index !== -1) {
                        allCompanies[index] = {
                            ...allCompanies[index],
                            company_name: companyName,
                            vat_number: vatNumber,
                            website: website || null,
                            referent_name: referentName,
                            referent_surname: referentSurname,
                            referent_email: referentEmail,
                            phone: phone,
                            logo: logo || null
                        };
                    }
                    allCompanies.sort((a, b) => a.company_name.localeCompare(b.company_name));
                    
                    hideLoading();
                    
                    // Reset modal
                    delete modal.dataset.editingId;
                    document.querySelector('#addCompanyModal h3').textContent = 'Aggiungi Azienda';
                    document.querySelector('#addCompanyModal button[type="submit"]').textContent = 'Aggiungi';
                    
                    hideModal('addCompanyModal');
                    loadCompanies();
                    
                    showNotification(`âœ… Azienda "${companyName}" aggiornata!`, 'success');
                    
                    event.target.reset();
                    document.getElementById('companyLogoUploadPreview').classList.add('hidden');
                    
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore: ' + error.message, 'error');
                }
                
                return;
            }

            // MODALITÃ€ CREAZIONE
            const duplicate = allCompanies.find(c => c.vat_number === vatNumber);
            if (duplicate) {
                showNotification('âŒ Partita IVA giÃ  registrata!', 'error');
                return;
            }
            
            const newCompany = {
                company_name: companyName,
                vat_number: vatNumber,
                website: website || null,
                referent_name: referentName,
                referent_surname: referentSurname,
                referent_email: referentEmail,
                phone: phone,
                logo: logo || null,
                created_date: new Date().toISOString()
            };

            showLoading('Salvataggio azienda...');
            
            try {
                const { data, error } = await supabase
                    .from('companies')
                    .insert([newCompany])
                    .select();
                
                if (error) throw error;
                
                const insertedCompany = data[0];
                allCompanies.push(insertedCompany);
                allCompanies.sort((a, b) => a.company_name.localeCompare(b.company_name));
                
                hideLoading();
                hideModal('addCompanyModal');
                loadCompanies();
                
                showNotification(`âœ… Azienda "${companyName}" aggiunta!`, 'success');
                
                event.target.reset();
                document.getElementById('companyLogoUploadPreview').classList.add('hidden');
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        async function deleteCompany(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const executeDelete = async () => {
                showLoading('Eliminazione...');
                
                try {
                    const { error } = await supabase
                        .from('companies')
                        .delete()
                        .eq('id', companyId);
                    
                    if (error) throw error;
                    
                    allCompanies = allCompanies.filter(c => c.id !== companyId);
                    hideLoading();
                    loadCompanies();
                    showNotification(`âœ… Azienda eliminata!`, 'success');
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore: ' + error.message, 'error');
                }
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', () => {
                    executeDelete();
                    cleanup();
                }, { once: true });
                
                setTimeout(() => {
                    document.addEventListener('click', cleanup, { once: true });
                }, 100);
            }, 0);
        }

        function editCompany(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) return;
            
            // Popola il modal con i dati esistenti
            document.getElementById('companyName').value = company.company_name;
            document.getElementById('companyVatNumber').value = company.vat_number;
            document.getElementById('companyWebsite').value = company.website || '';
            document.getElementById('companyReferentName').value = company.referent_name;
            document.getElementById('companyReferentSurname').value = company.referent_surname;
            document.getElementById('companyReferentEmail').value = company.referent_email || '';
            document.getElementById('companyPhone').value = company.phone;
            document.getElementById('companyLogoUrl').value = company.logo || '';
            
            // Mostra anteprima logo se presente
            if (company.logo) {
                const preview = document.getElementById('companyLogoUploadPreview');
                const previewImg = document.getElementById('companyLogoUploadPreviewImg');
                previewImg.src = company.logo;
                preview.classList.remove('hidden');
            }
            
            // Cambia il titolo del modal
            document.querySelector('#addCompanyModal h3').textContent = 'Modifica Azienda';
            
            // Cambia il testo del bottone
            const submitBtn = document.querySelector('#addCompanyModal button[type="submit"]');
            submitBtn.textContent = 'Aggiorna';
            
            // Memorizza l'ID per l'aggiornamento
            document.getElementById('addCompanyModal').dataset.editingId = companyId;
            
            showModal('addCompanyModal');
        }

        async function handleCompanyLogoFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('âš ï¸ Seleziona un file immagine valido', 'error');
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) {
                showNotification('âš ï¸ Immagine troppo grande (max 2MB)', 'error');
                return;
            }
            
            showLoading('Caricamento logo...');
            
            try {
                const base64 = await convertImageToBase64(file);
                document.getElementById('companyLogoUrl').value = base64;
                
                const preview = document.getElementById('companyLogoUploadPreview');
                const previewImg = document.getElementById('companyLogoUploadPreviewImg');
                previewImg.src = base64;
                preview.classList.remove('hidden');
                
                hideLoading();
                showNotification('âœ… Logo caricato!', 'success');
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore caricamento: ' + error.message, 'error');
            }
            
            event.target.value = '';
        }

        function downloadCompaniesExcelTemplate() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Denominazione Sociale', 'Partita IVA', 'Sito Web', 'Nome Referente', 'Cognome Referente', 'Email Referente', 'Telefono', 'Logo'],
                ['Azienda Esempio Srl', '12345678901', 'https://esempio.com', 'Mario', 'Rossi', 'mario.rossi@esempio.com', '3331234567', 'https://esempio.com/logo.png'],
                ['', '', '', '', '', '', '', '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 30}, {wch: 15}, {wch: 15}, {wch: 30}, {wch: 15}, {wch: 35}];
            XLSX.utils.book_append_sheet(wb, ws, 'Aziende');
            XLSX.writeFile(wb, 'template_aziende.xlsx');
            showNotification('ğŸ“¥ Template aziende scaricato!', 'success');
        }

        async function handleCompaniesExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('Lettura file Excel...');
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    hideLoading();
                    
                    if (jsonData.length === 0) {
                        showNotification('âš ï¿½ï¿½ï¿½ File Excel vuoto!', 'error');
                        return;
                    }
                    
                    await importCompaniesFromExcel(jsonData);
                    
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore lettura Excel: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        async function importCompaniesFromExcel(excelData) {
            showLoading(`Importazione ${excelData.length} aziende...`);
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (let i = 0; i < excelData.length; i++) {
                const row = excelData[i];
                
                if (!row['Denominazione Sociale'] || !row['Partita IVA'] || !row['Nome Referente'] || !row['Cognome Referente'] || !row['Email Referente'] || !row['Telefono']) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Campi obbligatori mancanti`);
                    continue;
                }
                
                const duplicate = allCompanies.find(c => c.vat_number === row['Partita IVA'].toString().trim());
                if (duplicate) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Partita IVA giÃ  esistente`);
                    continue;
                }
                
                const newCompany = {
                    company_name: row['Denominazione Sociale'].trim(),
                    vat_number: row['Partita IVA'].toString().trim(),
                    website: row['Sito Web'] ? row['Sito Web'].toString().trim() : null,
                    referent_name: row['Nome Referente'].trim(),
                    referent_surname: row['Cognome Referente'].trim(),
                    referent_email: row['Email Referente'].trim(),
                    phone: row['Telefono'].toString().trim(),
                    logo: row['Logo'] ? row['Logo'].toString().trim() : null,
                    created_date: new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from('companies')
                        .insert([newCompany])
                        .select();
                    
                    if (error) throw error;
                    
                    allCompanies.push(data[0]);
                    successCount++;
                } catch (error) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: ${error.message}`);
                }
            }
            
            allCompanies.sort((a, b) => a.company_name.localeCompare(b.company_name));
            
            hideLoading();
            loadCompanies();
            
            let message = `âœ… Importazione completata!\n\n`;
            message += `âœ”ï¸ Aziende importate: ${successCount}\n`;
            if (errorCount > 0) {
                message += `âŒ Errori: ${errorCount}\n\n`;
                message += errors.slice(0, 5).join('\n');
            }
            
            showNotification(message, successCount > 0 ? 'success' : 'error');
        }

        // ==========================================
        // STUDENT MANAGEMENT
        // ==========================================

        function populateCompanySelect() {
            const select = document.getElementById('studentCompany');
            
            // Mantieni l'opzione vuota
            select.innerHTML = '<option value="">-- Seleziona Azienda --</option>';
            
            // Ordina aziende alfabeticamente
            const sortedCompanies = [...allCompanies].sort((a, b) => 
                a.company_name.localeCompare(b.company_name)
            );
            
            // Aggiungi le aziende
            sortedCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.company_name;
                option.textContent = company.company_name;
                option.dataset.logo = company.logo || '';
                select.appendChild(option);
            });
            
            // Listener per aggiornare automaticamente il logo quando si seleziona un'azienda
            select.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const companyLogo = selectedOption.dataset.logo;
                
                if (companyLogo) {
                    document.getElementById('studentCompanyLogo').value = companyLogo;
                    
                    // Mostra anteprima
                    const preview = document.getElementById('companyLogoPreview');
                    const previewImg = document.getElementById('companyLogoPreviewImg');
                    previewImg.src = companyLogo;
                    preview.classList.remove('hidden');
                } else {
                    document.getElementById('studentCompanyLogo').value = '';
                    document.getElementById('companyLogoPreview').classList.add('hidden');
                }
            });
        }

        function loadStudents() {
            const tbody = document.getElementById('studentsTable');
            if (allStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nessuno studente presente</td></tr>';
                return;
            }
            
            tbody.innerHTML = allStudents.map(student => {
                const enrollmentCount = getStudentEnrollmentCount(student.id);
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-900">${student.name} ${student.surname}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.email}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${student.company}</span>
                            ${student.company_logo ? '<span class="text-xs text-green-600" title="Logo aziendale presente">ğŸ¢</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="openAssignCoursesModal('${student.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            ï¿½ï¿½ï¿½ ${enrollmentCount} ${enrollmentCount === 1 ? 'corso' : 'corsi'}
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <select onchange="changeUserRole('${student.id}', this.value)" class="text-xs px-2 py-1 border border-gray-300 rounded-md">
                            <option value="student" ${(student.role || 'student') === 'student' ? 'selected' : ''}>ğŸ‘¤ Studente</option>
                            <option value="admin" ${student.role === 'admin' ? 'selected' : ''}>ğŸ‘‘ Admin</option>
                        </select>
                    </td>
                    <td class="px-4 py-3">
                        ${student.password ? 
                            `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">âœ… Attivato</span>` : 
                            `<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">â³ Da Attivare</span>`
                        }
                    </td>
                    <td class="px-4 py-3 space-x-2">
                        ${!student.password ? `<button onclick="resendActivationEmail('${student.id}')" class="text-blue-600 hover:text-blue-800 text-sm">ğŸ“§ Reinvia Email</button>` : ''}
                        <button onclick="editStudent('${student.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Modifica</button>
                        <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        async function addStudent(event) {
            event.preventDefault();

            const name = document.getElementById('studentName').value.trim();
            const surname = document.getElementById('studentSurname').value.trim();
            const email = document.getElementById('studentEmail').value.trim().toLowerCase();
            const phone = document.getElementById('studentPhone').value.trim();
            const company = document.getElementById('studentCompany').value.trim();
            const companyLogo = document.getElementById('studentCompanyLogo').value.trim();
            const role = document.getElementById('studentRole').value;

            const modal = document.getElementById('addStudentModal');
            const editingId = modal.dataset.editingId;

            // MODALITÃ€ MODIFICA
            if (editingId) {
                const student = allStudents.find(s => s.id === editingId);
                if (!student) {
                    showNotification('âŒ Studente non trovato!', 'error');
                    return;
                }
                
                // Controlla duplicato email solo se Ã¨ cambiata
                if (email !== student.email) {
                    const duplicate = allStudents.find(s => s.email === email && s.id !== editingId);
                    if (duplicate) {
                        showNotification('âŒ Email giÃ  registrata!', 'error');
                        return;
                    }
                }
                
                showLoading('Aggiornamento studente...');
                
                try {
                    const { error } = await supabase
                        .from('students')
                        .update({
                            name: name,
                            surname: surname,
                            email: email,
                            phone: phone,
                            company: company,
                            company_logo: companyLogo || null,
                            role: role
                        })
                        .eq('id', editingId);
                    
                    if (error) throw error;
                    
                    // Aggiorna l'array locale
                    const index = allStudents.findIndex(s => s.id === editingId);
                    if (index !== -1) {
                        allStudents[index] = {
                            ...allStudents[index],
                            name: name,
                            surname: surname,
                            email: email,
                            phone: phone,
                            company: company,
                            company_logo: companyLogo || null,
                            role: role
                        };
                    }
                    
                    hideLoading();
                    
                    // Reset modal
                    delete modal.dataset.editingId;
                    document.querySelector('#addStudentModal h3').textContent = 'Aggiungi Studente';
                    document.querySelector('#addStudentModal button[type="submit"]').textContent = 'Aggiungi';
                    
                    hideModal('addStudentModal');
                    loadStudents();
                    
                    showNotification(`âœ… Studente "${name} ${surname}" aggiornato!`, 'success');
                    
                    event.target.reset();
                    document.getElementById('companyLogoPreview').classList.add('hidden');
                    
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore: ' + error.message, 'error');
                }
                
                return;
            }

            // MODALITÃ€ CREAZIONE
            const duplicate = allStudents.find(s => s.email === email);
            if (duplicate) {
                showNotification('âŒ Email giÃ  registrata!', 'error');
                return;
            }
            
            const newStudent = {
                name,
                surname,
                email,
                phone,
                company,
                company_logo: companyLogo || null,
                role,
                status: 'active',
                password: '',
                registration_date: new Date().toISOString()
            };

            showLoading('Salvataggio studente...');
            
            try {
                const { data, error } = await supabase
                    .from('students')
                    .insert([newStudent])
                    .select();
                
                if (error) throw error;
                
                const insertedStudent = data[0];
                allStudents.unshift(insertedStudent);
                
                hideLoading();
                hideModal('addStudentModal');
                loadStudents();
                
                showLoading('Invio email...');
                const emailResult = await sendWelcomeEmail(insertedStudent);
                hideLoading();
                
                if (emailResult.success) {
                    showNotification(`âœ… Studente aggiunto!\nğŸ“§ Email inviata a ${email}`, 'success');
                } else {
                    showNotification(`âœ… Studente aggiunto!\nâš ï¸ Errore email: ${emailResult.message}`, 'success');
                }
                
                event.target.reset();
                document.getElementById('companyLogoPreview').classList.add('hidden');
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        function editStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            // Popola il modal con i dati esistenti
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentSurname').value = student.surname;
            document.getElementById('studentEmail').value = student.email;
            document.getElementById('studentPhone').value = student.phone || '';
            document.getElementById('studentRole').value = student.role || 'student';
            
            // Memorizza l'ID per l'aggiornamento PRIMA di popolare la select
            document.getElementById('addStudentModal').dataset.editingId = studentId;
            
            // Popola la select delle aziende (questo deve avvenire prima di impostare il valore)
            populateCompanySelect();
            
            // Imposta l'azienda selezionata DOPO aver popolato la select
            document.getElementById('studentCompany').value = student.company;
            document.getElementById('studentCompanyLogo').value = student.company_logo || '';
            
            // Mostra anteprima logo se presente
            if (student.company_logo) {
                const preview = document.getElementById('companyLogoPreview');
                const previewImg = document.getElementById('companyLogoPreviewImg');
                previewImg.src = student.company_logo;
                preview.classList.remove('hidden');
            } else {
                document.getElementById('companyLogoPreview').classList.add('hidden');
            }
            
            // Cambia il titolo del modal
            document.querySelector('#addStudentModal h3').textContent = 'Modifica Studente';
            
            // Cambia il testo del bottone
            const submitBtn = document.querySelector('#addStudentModal button[type="submit"]');
            submitBtn.textContent = 'Aggiorna';
            
            showModal('addStudentModal');
        }

        async function changeUserRole(studentId, newRole) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            showLoading('Aggiornamento ruolo...');
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({ role: newRole })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                student.role = newRole;
                hideLoading();
                
                const roleName = newRole === 'admin' ? 'ğŸ‘‘ Amministratore' : 'ğŸ‘¤ Studente';
                showNotification(`âœ… ${student.name} ï¿½ï¿½ ora ${roleName}`, 'success');
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        async function resendActivationEmail(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                showNotification('âŒ Studente non trovato', 'error');
                return;
            }
            
            if (student.password) {
                showNotification('âš ï¸ Account giÃ  attivato!', 'error');
                return;
            }
            
            showLoading('Invio email di attivazione...');
            
            const emailResult = await sendWelcomeEmail(student);
            hideLoading();
            
            if (emailResult.success) {
                showNotification(`âœ… Email inviata a ${student.email}!\nğŸ”— Il nuovo link Ã¨ valido per 7 giorni.`, 'success');
            } else {
                showNotification(`âŒ Errore invio email: ${emailResult.message}`, 'error');
            }
        }

        async function deleteStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const executeDelete = async () => {
                showLoading('Eliminazione...');
                
                try {
                    const { error } = await supabase
                        .from('students')
                        .delete()
                        .eq('id', studentId);
                    
                    if (error) throw error;
                    
                    allStudents = allStudents.filter(s => s.id !== studentId);
                    allEnrollments = allEnrollments.filter(e => e.student_id !== studentId);
                    hideLoading();
                    loadStudents();
                    showNotification(`âœ… Studente "${student.name}" eliminato!`, 'success');
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore: ' + error.message, 'error');
                }
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', () => {
                    executeDelete();
                    cleanup();
                }, { once: true });
                
                setTimeout(() => {
                    document.addEventListener('click', cleanup, { once: true });
                }, 100);
            }, 0);
        }

        // ==========================================
        // EXCEL FUNCTIONS
        // ==========================================

        function downloadExcelTemplate() {
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Nome', 'Cognome', 'Email', 'Telefono', 'Azienda', 'LogoAzienda', 'Ruolo'],
                ['Mario', 'Rossi', 'mario.rossi@esempio.com', '3331234567', 'Azienda ABC', 'https://esempio.com/logo.png', 'student'],
                ['', '', '', '', '', '', '']
            ];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 30}, {wch: 15}, {wch: 20}, {wch: 35}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, ws, 'Studenti');
            XLSX.writeFile(wb, 'template_studenti.xlsx');
            showNotification('ğŸ“¥ Template scaricato!', 'success');
        }

        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading('Lettura file Excel...');
            
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    hideLoading();
                    
                    if (jsonData.length === 0) {
                        showNotification('âš ï¸ File Excel vuoto!', 'error');
                        return;
                    }
                    
                    await importStudentsFromExcel(jsonData);
                    
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore lettura Excel: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        async function importStudentsFromExcel(excelData) {
            showLoading(`Importazione ${excelData.length} studenti...`);
            
            let successCount = 0;
            let errorCount = 0;
            let emailsSent = 0;
            const errors = [];
            const importedStudents = [];
            
            for (let i = 0; i < excelData.length; i++) {
                const row = excelData[i];
                
                if (!row.Nome || !row.Cognome || !row.Email || !row.Azienda) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Campi mancanti`);
                    continue;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(row.Email)) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email non valida`);
                    continue;
                }
                
                const duplicate = allStudents.find(s => s.email.toLowerCase() === row.Email.toLowerCase());
                if (duplicate) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: Email giÃ  esistente`);
                    continue;
                }
                
                const newStudent = {
                    name: row.Nome.trim(),
                    surname: row.Cognome.trim(),
                    email: row.Email.trim().toLowerCase(),
                    phone: row.Telefono ? row.Telefono.toString().trim() : '',
                    company: row.Azienda.trim(),
                    company_logo: row.LogoAzienda ? row.LogoAzienda.toString().trim() : null,
                    role: row.Ruolo && row.Ruolo.toLowerCase() === 'admin' ? 'admin' : 'student',
                    status: 'active',
                    password: '',
                    registration_date: new Date().toISOString()
                };
                
                try {
                    const { data, error } = await supabase
                        .from('students')
                        .insert([newStudent])
                        .select();
                    
                    if (error) throw error;
                    
                    const insertedStudent = data[0];
                    allStudents.unshift(insertedStudent);
                    importedStudents.push(insertedStudent);
                    successCount++;
                } catch (error) {
                    errorCount++;
                    errors.push(`Riga ${i + 2}: ${error.message}`);
                }
            }
            
            if (importedStudents.length > 0) {
                showLoading(`Invio email a ${importedStudents.length} studenti...`);
                
                for (const student of importedStudents) {
                    const emailResult = await sendWelcomeEmail(student);
                    if (emailResult.success) emailsSent++;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            hideLoading();
            loadStudents();
            
            let message = `âœ… Importazione completata!\n\n`;
            message += `âœ”ï¸ Studenti importati: ${successCount}\n`;
            message += `ğŸ“§ Email inviate: ${emailsSent}\n`;
            if (errorCount > 0) {
                message += `ï¿½ï¿½ Errori: ${errorCount}\n\n`;
                message += errors.slice(0, 5).join('\n');
            }
            
            showNotification(message, successCount > 0 ? 'success' : 'error');
        }

        // ==========================================
        // COURSE MANAGEMENT
        // ==========================================

        function loadCourses() {
            const container = document.getElementById('coursesList');
            if (allCourses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nessun corso presente</p>';
                return;
            }
            
            container.innerHTML = allCourses.map(course => {
                const modules = course.modules || [];
                const enrolledCount = allEnrollments.filter(e => e.course_id === course.id).length;
                
                return `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${course.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${course.description || ''}</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="text-xs px-2 py-1 rounded-full ${course.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${course.status === 'published' ? 'âœ… Pubblicato' : 'ğŸ“ Bozza'}
                                </span>
                                ${course.has_certificate ? '<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">ğŸ“ Certificato</span>' : ''}
                                <span class="text-xs text-gray-600">ğŸ“š ${modules.length} moduli</span>
                                <span class="text-xs text-gray-600">ï¿½ï¿½ ${enrolledCount} iscritti</span>
                            </div>
                            <div class="mt-3 flex space-x-2">
                                <button onclick="openCourseEditor('${course.id}')" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg">
                                    âœï¸ Modifica Contenuti
                                </button>
                            </div>
                        </div>
                        <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-800 text-sm ml-4">Elimina</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function addCourse(event) {
            event.preventDefault();
            
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const hasCertificate = document.getElementById('courseHasCertificate').checked;
            
            const newCourse = {
                title,
                description,
                has_certificate: hasCertificate,
                modules: [],
                status: 'published',
                created_date: new Date().toISOString(),
                created_by: currentUser.name
            };

            showLoading('Creazione corso...');
            
            try {
                const { data, error } = await supabase
                    .from('courses')
                    .insert([newCourse])
                    .select();
                
                if (error) throw error;
                
                const insertedCourse = data[0];
                allCourses.unshift(insertedCourse);
                
                hideLoading();
                hideModal('addCourseModal');
                loadCourses();
                showNotification(`âœ… Corso "${title}" creato!\nğŸ“ Ora puoi aggiungere moduli e contenuti.`, 'success');
                
                event.target.reset();
                
            } catch (error) {
                hideLoading();
                showNotification('ï¿½ï¿½ï¿½ Errore: ' + error.message, 'error');
            }
        }

        async function deleteCourse(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) return;
            
            const confirmBtn = event.target;
            const originalText = confirmBtn.textContent;
            
            confirmBtn.textContent = 'Conferma?';
            confirmBtn.classList.add('bg-red-100', 'px-2', 'py-1', 'rounded');
            
            const executeDelete = async () => {
                showLoading('Eliminazione...');
                
                try {
                    const { error } = await supabase
                        .from('courses')
                        .delete()
                        .eq('id', courseId);
                    
                    if (error) throw error;
                    
                    allCourses = allCourses.filter(c => c.id !== courseId);
                    allEnrollments = allEnrollments.filter(e => e.course_id !== courseId);
                    hideLoading();
                    loadCourses();
                    showNotification(`âœ… Corso eliminato!`, 'success');
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore: ' + error.message, 'error');
                }
            };
            
            const cleanup = () => {
                confirmBtn.textContent = originalText;
                confirmBtn.classList.remove('bg-red-100', 'px-2', 'py-1', 'rounded');
            };
            
            setTimeout(() => {
                confirmBtn.addEventListener('click', () => {
                    executeDelete();
                    cleanup();
                }, { once: true });
                
                setTimeout(() => {
                    document.addEventListener('click', cleanup, { once: true });
                }, 100);
            }, 0);
        }

        // ==========================================
        // ADMIN TABS & STATS
        // ==========================================

        function showAdminTab(tab) {
            document.getElementById('studentsSection').classList.add('hidden');
            document.getElementById('companiesSection').classList.add('hidden');
            document.getElementById('coursesSection').classList.add('hidden');
            document.getElementById('reportsSection').classList.add('hidden');
            document.getElementById('settingsSection').classList.add('hidden');
            
            document.getElementById('studentsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('companiesTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('coursesTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('reportsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            document.getElementById('settingsTab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors text-gray-600 hover:text-gray-800';
            
            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById(tab + 'Tab').className = 'flex-1 py-2 px-4 rounded-md font-medium transition-colors bg-white text-green-600 shadow-sm';
            
            if (tab === 'reports') {
                updateStats();
            } else if (tab === 'companies') {
                loadCompanies();
            }
        }

        function updateStats() {
            document.getElementById('totalStudents').textContent = allStudents.length;
            document.getElementById('totalCourses').textContent = allCourses.filter(c => c.status === 'published').length;
            document.getElementById('totalCompletions').textContent = allProgress.filter(p => p.completed === true).length;
        }

        // ==========================================
        // STUDENT DASHBOARD
        // ==========================================

        let currentViewingCourse = null;
        let currentModuleIndex = 0;

        function loadStudentCourses() {
            const container = document.getElementById('studentCoursesList');
            
            // Filtra solo i corsi a cui lo studente Ã¨ iscritto
            const enrolledCourseIds = getStudentEnrolledCourses(currentUser.studentId);
            const enrolledCourses = allCourses.filter(c => 
                c.status === 'published' && enrolledCourseIds.includes(c.id)
            );
            
            if (enrolledCourses.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">Non sei ancora iscritto a nessun corso.<br>Contatta l\'amministratore per l\'assegnazione.</p></div>';
                return;
            }
            
            container.innerHTML = enrolledCourses.map(course => {
                const progress = getStudentCourseProgress(course.id);
                const modules = course.modules || [];
                
                return `
                <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${course.title}</h3>
                    <p class="text-sm text-gray-600 mb-3">${course.description || ''}</p>
                    
                    ${modules.length > 0 ? `
                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Progresso</span>
                                <span>${progress.completedModules}/${modules.length} moduli</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: ${modules.length > 0 ? (progress.completedModules / modules.length * 100) : 0}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${progress.completed ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                            <p class="text-sm text-green-800 font-medium">âœ… Corso completato!</p>
                            ${course.has_certificate ? `
                                <button onclick="downloadCertificate('${course.id}')" class="mt-2 w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm">
                                    ğŸ“ Scarica Certificato
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <button onclick="startCourse('${course.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ${progress.completedModules > 0 ? 'â–¶ï¸ Continua' : 'ğŸš€ Inizia Corso'}
                    </button>
                </div>
            `;
            }).join('');
        }

        function getStudentCourseProgress(courseId) {
            const progress = allProgress.find(p => 
                p.student_id === currentUser.studentId && 
                p.course_id === courseId
            );
            
            if (!progress) {
                return { completedModules: 0, completed: false };
            }
            
            return {
                completedModules: progress.completed_modules || 0,
                completed: progress.completed || false,
                moduleProgress: progress.module_progress || {}
            };
        }

        function startCourse(courseId) {
            currentViewingCourse = allCourses.find(c => c.id === courseId);
            if (!currentViewingCourse || !currentViewingCourse.modules || currentViewingCourse.modules.length === 0) {
                showNotification('âš ï¸ Questo corso non ha ancora moduli!', 'error');
                return;
            }
            
            const progress = getStudentCourseProgress(courseId);
            currentModuleIndex = progress.completedModules || 0;
            
            if (currentModuleIndex >= currentViewingCourse.modules.length) {
                currentModuleIndex = currentViewingCourse.modules.length - 1;
            }
            
            document.getElementById('studentDashboard').classList.add('hidden');
            showCourseViewer();
        }

        function showCourseViewer() {
            const viewer = document.createElement('div');
            viewer.id = 'courseViewer';
            viewer.className = 'max-w-4xl mx-auto p-6';
            
            viewer.innerHTML = `
                <div class="mb-6">
                    <button onclick="exitCourse()" class="text-blue-600 hover:text-blue-800 mb-4">
                        â† Torna ai corsi
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800">${currentViewingCourse.title}</h2>
                    <p class="text-gray-600 mt-2">${currentViewingCourse.description || ''}</p>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div id="moduleNavigation" class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                        <button onclick="previousModule()" id="prevModuleBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                            â† Precedente
                        </button>
                        <span id="moduleCounter" class="text-sm font-medium text-gray-700"></span>
                        <button onclick="nextModule()" id="nextModuleBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                            Successivo â†’
                        </button>
                    </div>
                    
                    <div id="moduleContent"></div>
                </div>
            `;
            
            document.getElementById('dashboard').appendChild(viewer);
            renderModule();
        }

        function renderModule() {
            const module = currentViewingCourse.modules[currentModuleIndex];
            const content = document.getElementById('moduleContent');
            const counter = document.getElementById('moduleCounter');
            const prevBtn = document.getElementById('prevModuleBtn');
            const nextBtn = document.getElementById('nextModuleBtn');
            
            counter.textContent = `Modulo ${currentModuleIndex + 1} di ${currentViewingCourse.modules.length}`;
            prevBtn.disabled = currentModuleIndex === 0;
            prevBtn.classList.toggle('opacity-50', currentModuleIndex === 0);
            prevBtn.classList.toggle('cursor-not-allowed', currentModuleIndex === 0);
            
            content.innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-3">${module.title}</h3>
                ${module.description ? `<p class="text-gray-600 mb-6">${module.description}</p>` : ''}
                
                <div class="space-y-6">
                    ${renderModuleMedia(module)}
                </div>
                
                ${module.test ? `
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ Test di Verifica</h4>
                        <p class="text-sm text-gray-600 mb-4">Punteggio minimo richiesto: ${module.test.minScore}%</p>
                        <button onclick="startModuleTest()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">
                            Inizia Test
                        </button>
                    </div>
                ` : `
                    <div class="mt-8 flex justify-end">
                        <button onclick="completeModuleAndNext()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                            âœ… Completa e Vai Avanti
                        </button>
                    </div>
                `}
            `;
        }

        function renderModuleMedia(module) {
            const media = module.media || [];
            
            if (media.length === 0) {
                return '<p class="text-gray-500">Nessun contenuto disponibile</p>';
            }
            
            return media.map(item => {
                switch(item.type) {
                    case 'video':
                        const videoId = extractVideoId(item.url);
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">ğŸ¥ ${item.title}</h5>
                                <div class="aspect-video bg-gray-100 rounded-lg overflow-hidden">
                                    ${videoId ? `
                                        <iframe src="https://www.youtube.com/embed/${videoId}" 
                                                class="w-full h-full" 
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen></iframe>
                                    ` : `<p class="p-4 text-gray-500">Video non disponibile</p>`}
                                </div>
                            </div>
                        `;
                    
                    case 'pdf':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">ğŸ“„ ${item.title}</h5>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                                   class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                    <span>Apri PDF</span>
                                    <span>â†—</span>
                                </a>
                            </div>
                        `;
                    
                    case 'link':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">ï¿½ï¿½ï¿½ï¿½ ${item.title}</h5>
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" 
                                   class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-800">
                                    <span>${item.url}</span>
                                    <span>â†—</span>
                                </a>
                            </div>
                        `;
                    
                    case 'text':
                        return `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h5 class="font-medium text-gray-800 mb-3">ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ${item.title}</h5>
                                <div class="prose prose-sm max-w-none text-gray-700">
                                    ${item.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `;
                    
                    default:
                        return '';
                }
            }).join('');
        }

        function extractVideoId(url) {
            // Supporta vari formati YouTube
            const patterns = [
                /(?:youtube\.com\/watch\?v=)([a-zA-Z0-9_-]{11})/,  // https://www.youtube.com/watch?v=VIDEO_ID
                /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,     // https://www.youtube.com/embed/VIDEO_ID
                /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,               // https://youtu.be/VIDEO_ID
                /(?:youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/          // https://www.youtube.com/v/VIDEO_ID
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function previousModule() {
            if (currentModuleIndex > 0) {
                currentModuleIndex--;
                renderModule();
            }
        }

        function nextModule() {
            if (currentModuleIndex < currentViewingCourse.modules.length - 1) {
                currentModuleIndex++;
                renderModule();
            }
        }

        async function completeModuleAndNext() {
            await updateModuleProgress(currentModuleIndex, true);
            
            if (currentModuleIndex < currentViewingCourse.modules.length - 1) {
                nextModule();
            } else {
                await completeCourse();
            }
        }

        function startModuleTest() {
            const module = currentViewingCourse.modules[currentModuleIndex];
            const test = module.test;
            
            if (!test || !test.questions || test.questions.length === 0) {
                showNotification('âš ï¸ Test non disponibile', 'error');
                return;
            }
            
            const testUI = document.createElement('div');
            testUI.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            testUI.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto p-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Test: ${module.title}</h3>
                    <form id="testForm" class="space-y-6">
                        ${test.questions.map((q, qIndex) => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <p class="font-medium text-gray-800 mb-3">${qIndex + 1}. ${q.question}</p>
                                <div class="space-y-2">
                                    ${q.options.map((opt, oIndex) => `
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="q${qIndex}" value="${oIndex}" required class="text-green-600">
                                            <span class="text-gray-700">${String.fromCharCode(65 + oIndex)}. ${opt}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button type="submit" class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                                Invia Risposte
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(testUI);
            
            document.getElementById('testForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                let correctAnswers = 0;
                test.questions.forEach((q, index) => {
                    const selected = parseInt(document.querySelector(`input[name="q${index}"]:checked`)?.value);
                    if (selected === q.correctAnswer) correctAnswers++;
                });
                
                const score = Math.round((correctAnswers / test.questions.length) * 100);
                const passed = score >= test.minScore;
                
                testUI.remove();
                
                if (passed) {
                    showNotification(`âœ… Test superato! Punteggio: ${score}%`, 'success');
                    await completeModuleAndNext();
                } else {
                    showNotification(`âŒ Test non superato. Punteggio: ${score}% (minimo ${test.minScore}%)\nRipassa il materiale e riprova.`, 'error');
                }
            });
        }

        async function updateModuleProgress(moduleIndex, completed) {
            showLoading('Aggiornamento progresso...');
            
            try {
                let progress = allProgress.find(p => 
                    p.student_id === currentUser.studentId && 
                    p.course_id === currentViewingCourse.id
                );
                
                if (!progress) {
                    const { data, error } = await supabase
                        .from('progress')
                        .insert([{
                            student_id: currentUser.studentId,
                            course_id: currentViewingCourse.id,
                            completed: false,
                            completed_modules: completed ? 1 : 0,
                            module_progress: { [moduleIndex]: completed }
                        }])
                        .select();
                    
                    if (error) throw error;
                    progress = data[0];
                    allProgress.push(progress);
                } else {
                    const moduleProgress = progress.module_progress || {};
                    moduleProgress[moduleIndex] = completed;
                    
                    const completedCount = Object.values(moduleProgress).filter(v => v === true).length;
                    
                    const { error } = await supabase
                        .from('progress')
                        .update({
                            completed_modules: completedCount,
                            module_progress: moduleProgress
                        })
                        .eq('id', progress.id);
                    
                    if (error) throw error;
                    
                    progress.completed_modules = completedCount;
                    progress.module_progress = moduleProgress;
                }
                
                hideLoading();
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore aggiornamento: ' + error.message, 'error');
            }
        }

        async function completeCourse() {
            showLoading('Completamento corso...');
            
            try {
                const progress = allProgress.find(p => 
                    p.student_id === currentUser.studentId && 
                    p.course_id === currentViewingCourse.id
                );
                
                if (progress) {
                    const { error } = await supabase
                        .from('progress')
                        .update({
                            completed: true,
                            completion_date: new Date().toISOString()
                        })
                        .eq('id', progress.id);
                    
                    if (error) throw error;
                    
                    progress.completed = true;
                    progress.completion_date = new Date().toISOString();
                }
                
                hideLoading();
                
                if (currentViewingCourse.has_certificate) {
                    showNotification('ğŸ‰ Congratulazioni! Corso completato!\nğŸ“ Puoi scaricare il certificato.', 'success');
                } else {
                    showNotification('ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Congratulazioni! Hai completato il corso!', 'success');
                }
                
                setTimeout(() => exitCourse(), 2000);
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        function exitCourse() {
            const viewer = document.getElementById('courseViewer');
            if (viewer) viewer.remove();
            
            document.getElementById('studentDashboard').classList.remove('hidden');
            loadStudentCourses();
        }

        function downloadCertificate(courseId) {
            const course = allCourses.find(c => c.id === courseId);
            if (!course) return;
            
            const progress = allProgress.find(p => 
                p.student_id === currentUser.studentId && 
                p.course_id === courseId
            );
            const dateStr = progress?.completion_date ? 
                new Date(progress.completion_date).toLocaleDateString('it-IT') : 
                new Date().toLocaleDateString('it-IT');
            
            // Trova i dati dello studente per ottenere il logo aziendale
            const student = allStudents.find(s => s.id === currentUser.studentId);
            
            // Usa la configurazione personalizzata
            generateCertificate(certificateConfig, {
                studentName: currentUser.name,
                courseName: course.title,
                completionDate: dateStr,
                companyLogo: student?.company_logo || null
            }, (blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Certificato_${course.title.replace(/\s+/g, '_')}.png`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('ğŸ“ Certificato scaricato!', 'success');
            });
        }

        function generateCertificate(config, data, callback) {
            const canvas = document.createElement('canvas');
            canvas.width = 1200;
            canvas.height = 800;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 1200, 800);
            
            // Border decorativo
            ctx.strokeStyle = config.primaryColor;
            ctx.lineWidth = 12;
            ctx.strokeRect(40, 40, 1120, 720);
            
            ctx.strokeStyle = config.secondaryColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(60, 60, 1080, 680);
            
            // Caricamento loghi (piattaforma sinistra, azienda destra)
            const logosToLoad = [];
            let loadedLogos = 0;
            
            if (config.platformLogo) {
                const platformLogo = new Image();
                platformLogo.crossOrigin = 'anonymous';
                platformLogo.onload = function() {
                    logosToLoad.push({ img: platformLogo, position: 'left' });
                    loadedLogos++;
                    if (loadedLogos === (config.platformLogo ? 1 : 0) + (data.companyLogo ? 1 : 0)) {
                        continueDrawing();
                    }
                };
                platformLogo.onerror = function() {
                    console.warn('Logo piattaforma non caricato');
                    loadedLogos++;
                    if (loadedLogos === (config.platformLogo ? 1 : 0) + (data.companyLogo ? 1 : 0)) {
                        continueDrawing();
                    }
                };
                platformLogo.src = config.platformLogo;
            }
            
            if (data.companyLogo) {
                const companyLogo = new Image();
                companyLogo.crossOrigin = 'anonymous';
                companyLogo.onload = function() {
                    logosToLoad.push({ img: companyLogo, position: 'right' });
                    loadedLogos++;
                    if (loadedLogos === (config.platformLogo ? 1 : 0) + (data.companyLogo ? 1 : 0)) {
                        continueDrawing();
                    }
                };
                companyLogo.onerror = function() {
                    console.warn('Logo azienda non caricato');
                    loadedLogos++;
                    if (loadedLogos === (config.platformLogo ? 1 : 0) + (data.companyLogo ? 1 : 0)) {
                        continueDrawing();
                    }
                };
                companyLogo.src = data.companyLogo;
            }
            
            if (!config.platformLogo && !data.companyLogo) {
                continueDrawing();
            }
            
            function continueDrawing() {
                // Disegna i loghi caricati
                logosToLoad.forEach(logoData => {
                    const logoWidth = 150;
                    const logoHeight = (logoData.img.height / logoData.img.width) * logoWidth;
                    const logoX = logoData.position === 'left' ? 80 : 970;
                    ctx.drawImage(logoData.img, logoX, 80, logoWidth, logoHeight);
                });
                
                const hasLogos = logosToLoad.length > 0;
                const startY = hasLogos ? 230 : 150;
                
                // Titolo
                ctx.fillStyle = config.secondaryColor;
                ctx.font = 'bold 56px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(config.title, 600, startY);
                
                // Decorazione sotto il titolo
                ctx.fillStyle = config.primaryColor;
                ctx.fillRect(450, startY + 20, 300, 4);
                
                // Sottotitolo
                ctx.fillStyle = config.secondaryColor;
                ctx.font = '28px Arial, sans-serif';
                ctx.fillText(config.subtitle, 600, startY + 100);
                
                // Nome studente (evidenziato)
                ctx.font = 'bold 48px Arial, sans-serif';
                ctx.fillStyle = config.primaryColor;
                ctx.fillText(data.studentName, 600, startY + 180);
                
                // Nome corso
                ctx.font = '32px Arial, sans-serif';
                ctx.fillStyle = config.secondaryColor;
                ctx.fillText('per aver completato il corso', 600, startY + 260);
                
                ctx.font = 'bold 38px Arial, sans-serif';
                ctx.fillStyle = config.primaryColor;
                ctx.fillText(`"${data.courseName}"`, 600, startY + 320);
                
                // Data
                ctx.fillStyle = '#6b7280';
                ctx.font = '22px Arial, sans-serif';
                ctx.fillText(`Rilasciato il ${data.completionDate}`, 600, startY + 400);
                
                // Firma
                if (config.signature) {
                    ctx.fillStyle = config.secondaryColor;
                    ctx.font = 'italic 28px Arial, sans-serif';
                    ctx.fillText(config.signature, 600, startY + 480);
                    
                    // Linea firma
                    ctx.strokeStyle = config.secondaryColor;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(450, startY + 460);
                    ctx.lineTo(750, startY + 460);
                    ctx.stroke();
                }
                
                // Footer
                if (config.footerText) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '18px Arial, sans-serif';
                    ctx.fillText(config.footerText, 600, 750);
                }
                
                // Callback con blob
                canvas.toBlob(callback);
            }
        }

        // ==========================================
        // ACCOUNT ACTIVATION
        // ==========================================

        function decodeActivationToken(token) {
            try {
                const decoded = atob(token);
                const [studentId, email, timestamp] = decoded.split('-');
                return { studentId, email, timestamp: parseInt(timestamp) };
            } catch (error) {
                return null;
            }
        }

        async function checkActivationLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const token = urlParams.get('token');
            const studentId = urlParams.get('id');
            
            console.log('ğŸ” Checking activation link:', { action, hasToken: !!token, hasId: !!studentId });
            
            if (action === 'activate' && token && studentId) {
                showLoading('Verifica link di attivazione...');
                
                const tokenData = decodeActivationToken(token);
                
                if (!tokenData) {
                    hideLoading();
                    showNotification('âŒ Link non valido', 'error');
                    return;
                }
                
                // Link non scade mai - valido fino all'attivazione dell'account
                console.log('â° Link creato:', new Date(tokenData.timestamp).toLocaleString());
                
                try {
                    const { data: students, error } = await supabase
                        .from('students')
                        .select('*')
                        .eq('id', studentId)
                        .single();
                    
                    if (error || !students) {
                        hideLoading();
                        showNotification('âŒ Studente non trovato nel database', 'error');
                        console.error('Errore caricamento studente:', error);
                        return;
                    }
                    
                    const student = students;
                    
                    if (student.password) {
                        hideLoading();
                        showNotification('âš ï¸ Account giÃ  attivato! Puoi fare il login.', 'success');
                        document.getElementById('loginEmail').value = student.email;
                        return;
                    }
                    
                    hideLoading();
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('activationScreen').classList.remove('hidden');
                    document.getElementById('activationEmail').textContent = student.email;
                    document.getElementById('activationName').textContent = `${student.name} ${student.surname}`;
                    
                    window.activatingStudent = student;
                    console.log('âœ… Schermata attivazione mostrata per:', student.email);
                    return;
                    
                } catch (error) {
                    hideLoading();
                    showNotification('âŒ Errore caricamento dati: ' + error.message, 'error');
                    console.error('Errore:', error);
                    return;
                }
            }
        }

        async function activateAccount(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('ï¿½ï¿½ï¿½ Le password non coincidono!', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showNotification('âŒ Password minimo 8 caratteri', 'error');
                return;
            }
            
            if (!window.activatingStudent) {
                showNotification('âŒ Errore dati studente', 'error');
                return;
            }
            
            showLoading('Attivazione account...');
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({
                        password: newPassword,
                        status: 'active'
                    })
                    .eq('id', window.activatingStudent.id);
                
                if (error) throw error;
                
                const studentIndex = allStudents.findIndex(s => s.id === window.activatingStudent.id);
                if (studentIndex !== -1) {
                    allStudents[studentIndex].password = newPassword;
                    allStudents[studentIndex].status = 'active';
                }
                
                delete window.activatingStudent;
                window.history.replaceState({}, document.title, window.location.pathname);
                
                hideLoading();
                showNotification('âœ… Account attivato! Ora puoi accedere.', 'success');
                
                setTimeout(() => {
                    document.getElementById('activationScreen').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    if (studentIndex !== -1) {
                        document.getElementById('loginEmail').value = allStudents[studentIndex].email;
                    }
                }, 2000);
                
            } catch (error) {
                hideLoading();
                showNotification('ï¿½ï¿½ Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // COURSE EDITOR FUNCTIONS
        // ==========================================

        let currentEditingCourse = null;
        let currentEditingModule = null;

        function openCourseEditor(courseId) {
            currentEditingCourse = allCourses.find(c => c.id === courseId);
            if (!currentEditingCourse) return;
            
            if (!currentEditingCourse.modules) {
                currentEditingCourse.modules = [];
            }
            
            document.getElementById('editorCourseTitle').textContent = currentEditingCourse.title;
            showModal('courseEditorModal');
            renderModulesList();
            showEmptyModuleEditor();
        }

        function renderModulesList() {
            const container = document.getElementById('modulesList');
            const modules = currentEditingCourse.modules || [];
            
            if (modules.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nessun modulo</p>';
                return;
            }
            
            container.innerHTML = modules.map((module, index) => `
                <div onclick="selectModule(${index})" class="p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 ${currentEditingModule === module ? 'bg-blue-50 border-blue-500' : ''}">
                    <div class="font-medium text-sm text-gray-800">${index + 1}. ${module.title || 'Senza titolo'}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${(module.media || []).length} media
                        ${module.test ? 'ï¿½ï¿½ï¿½ Test presente' : ''}
                    </div>
                </div>
            `).join('');
        }

        function addModule() {
            const newModule = {
                id: 'mod_' + Date.now(),
                title: 'Nuovo Modulo',
                description: '',
                media: [],
                test: null,
                order: currentEditingCourse.modules.length
            };
            
            currentEditingCourse.modules.push(newModule);
            renderModulesList();
            selectModule(currentEditingCourse.modules.length - 1);
        }

        function selectModule(index) {
            currentEditingModule = currentEditingCourse.modules[index];
            showModuleEditor();
        }

        function showEmptyModuleEditor() {
            document.getElementById('moduleEditorEmpty').classList.remove('hidden');
            document.getElementById('moduleEditorContent').classList.add('hidden');
            currentEditingModule = null;
        }

        function showModuleEditor() {
            if (!currentEditingModule) return;
            
            document.getElementById('moduleEditorEmpty').classList.add('hidden');
            document.getElementById('moduleEditorContent').classList.remove('hidden');
            
            document.getElementById('moduleTitle').value = currentEditingModule.title || '';
            document.getElementById('moduleDescription').value = currentEditingModule.description || '';
            
            renderMediaList();
            updateTestSection();
            renderModulesList();
        }

        function renderMediaList() {
            const container = document.getElementById('mediaList');
            const media = currentEditingModule.media || [];
            
            if (media.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Nessun media</p>';
                return;
            }
            
            const mediaIcons = {
                video: 'ğŸ¥',
                pdf: 'ï¿½ï¿½ï¿½',
                link: 'ğŸ”—',
                text: 'ğŸ“'
            };
            
            container.innerHTML = media.map((item, index) => `
                <div class="flex items-center justify-between p-2 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-2">
                        <span>${mediaIcons[item.type] || 'ğŸ“'}</span>
                        <span class="text-sm text-gray-800">${item.title}</span>
                    </div>
                    <button onclick="deleteMedia(${index})" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                </div>
            `).join('');
        }

        function addMedia() {
            showModal('addMediaModal');
            document.getElementById('mediaType').value = 'video';
            updateMediaForm();
        }

        function updateMediaForm() {
            const type = document.getElementById('mediaType').value;
            const urlField = document.getElementById('mediaUrlField');
            const textField = document.getElementById('mediaTextField');
            const urlInput = document.getElementById('mediaUrl');
            
            if (type === 'text') {
                urlField.classList.add('hidden');
                textField.classList.remove('hidden');
                urlInput.removeAttribute('required');
            } else {
                urlField.classList.remove('hidden');
                textField.classList.add('hidden');
                urlInput.setAttribute('required', 'required');
            }
        }

        function saveMedia(event) {
            event.preventDefault();
            
            const type = document.getElementById('mediaType').value;
            const title = document.getElementById('mediaTitle').value.trim();
            const url = document.getElementById('mediaUrl').value.trim();
            const text = document.getElementById('mediaText').value.trim();
            
            const mediaItem = {
                id: 'media_' + Date.now(),
                type,
                title,
                url: type === 'text' ? '' : url,
                content: type === 'text' ? text : ''
            };
            
            if (!currentEditingModule.media) {
                currentEditingModule.media = [];
            }
            
            currentEditingModule.media.push(mediaItem);
            renderMediaList();
            hideModal('addMediaModal');
            
            event.target.reset();
            showNotification('âœ… Media aggiunto!', 'success');
        }

        function deleteMedia(index) {
            currentEditingModule.media.splice(index, 1);
            renderMediaList();
            showNotification('âœ… Media eliminato', 'success');
        }

        function toggleModuleTest() {
            if (currentEditingModule.test) {
                currentEditingModule.test = null;
                showNotification('âœ… Test rimosso', 'success');
            } else {
                currentEditingModule.test = {
                    minScore: 70,
                    questions: []
                };
            }
            updateTestSection();
        }

        function updateTestSection() {
            const testSection = document.getElementById('testSection');
            const toggleBtn = document.getElementById('toggleTestBtn');
            const questionCount = document.getElementById('questionCount');
            
            if (currentEditingModule.test) {
                testSection.classList.remove('hidden');
                toggleBtn.textContent = 'âŒ Rimuovi Test';
                toggleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                document.getElementById('testMinScore').value = currentEditingModule.test.minScore || 70;
                questionCount.textContent = `${currentEditingModule.test.questions.length} domande`;
            } else {
                testSection.classList.add('hidden');
                toggleBtn.textContent = 'ï¿½ï¿½ Aggiungi Test';
                toggleBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            }
        }

        function manageQuestions() {
            showModal('questionsModal');
            renderQuestionsList();
        }

        function renderQuestionsList() {
            const container = document.getElementById('questionsList');
            const questions = currentEditingModule.test?.questions || [];
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna domanda</p>';
                return;
            }
            
            container.innerHTML = questions.map((q, index) => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-medium text-gray-800">${index + 1}. ${q.question}</span>
                        <button onclick="deleteQuestion(${index})" class="text-red-600 hover:text-red-800 text-sm">Elimina</button>
                    </div>
                    <div class="space-y-1 ml-4">
                        ${q.options.map((opt, i) => `
                            <div class="text-sm ${i === q.correctAnswer ? 'text-green-600 font-medium' : 'text-gray-600'}">
                                ${String.fromCharCode(65 + i)}. ${opt} ${i === q.correctAnswer ? 'âœ…' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function addQuestion() {
            const question = window.prompt('Inserisci la domanda:');
            if (!question) return;
            
            const optionA = window.prompt('Opzione A:');
            const optionB = window.prompt('Opzione B:');
            const optionC = window.prompt('Opzione C:');
            const optionD = window.prompt('Opzione D:');
            
            if (!optionA || !optionB || !optionC || !optionD) {
                showNotification('âš ï¿½ï¿½ï¿½ Tutte le opzioni sono obbligatorie!', 'error');
                return;
            }
            
            const correctAnswer = parseInt(window.prompt('Numero risposta corretta (0=A, 1=B, 2=C, 3=D):'));
            
            if (isNaN(correctAnswer) || correctAnswer < 0 || correctAnswer > 3) {
                showNotification('âš ï¸ Risposta corretta non valida!', 'error');
                return;
            }
            
            const newQuestion = {
                id: 'q_' + Date.now(),
                question,
                options: [optionA, optionB, optionC, optionD],
                correctAnswer
            };
            
            if (!currentEditingModule.test.questions) {
                currentEditingModule.test.questions = [];
            }
            
            currentEditingModule.test.questions.push(newQuestion);
            renderQuestionsList();
            updateTestSection();
            showNotification('âœ… Domanda aggiunta!', 'success');
        }

        function deleteQuestion(index) {
            currentEditingModule.test.questions.splice(index, 1);
            renderQuestionsList();
            updateTestSection();
            showNotification('âœ… Domanda eliminata', 'success');
        }

        async function saveModule() {
            if (!currentEditingModule) return;
            
            currentEditingModule.title = document.getElementById('moduleTitle').value.trim();
            currentEditingModule.description = document.getElementById('moduleDescription').value.trim();
            
            if (currentEditingModule.test) {
                currentEditingModule.test.minScore = parseInt(document.getElementById('testMinScore').value);
            }
            
            showLoading('Salvataggio modulo...');
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .update({ modules: currentEditingCourse.modules })
                    .eq('id', currentEditingCourse.id);
                
                if (error) throw error;
                
                const courseIndex = allCourses.findIndex(c => c.id === currentEditingCourse.id);
                if (courseIndex !== -1) {
                    allCourses[courseIndex] = currentEditingCourse;
                }
                
                hideLoading();
                showNotification('âœ… Modulo salvato!', 'success');
                renderModulesList();
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        async function deleteModule() {
            if (!currentEditingModule) return;
            
            const moduleIndex = currentEditingCourse.modules.indexOf(currentEditingModule);
            
            const confirmDelete = window.confirm(`Eliminare il modulo "${currentEditingModule.title}"?`);
            if (!confirmDelete) return;
            
            currentEditingCourse.modules.splice(moduleIndex, 1);
            
            showLoading('Eliminazione modulo...');
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .update({ modules: currentEditingCourse.modules })
                    .eq('id', currentEditingCourse.id);
                
                if (error) throw error;
                
                const courseIndex = allCourses.findIndex(c => c.id === currentEditingCourse.id);
                if (courseIndex !== -1) {
                    allCourses[courseIndex] = currentEditingCourse;
                }
                
                hideLoading();
                showNotification('âœ… Modulo eliminato!', 'success');
                renderModulesList();
                showEmptyModuleEditor();
                
            } catch (error) {
                hideLoading();
                showNotification('âŒ Errore: ' + error.message, 'error');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Avvio EduPlatform...');
            
            // ğŸ”¥ CONTROLLA LINK DI ATTIVAZIONE PRIMA DI TUTTO
            const urlParams = new URLSearchParams(window.location.search);
            const isActivationLink = urlParams.get('action') === 'activate' && urlParams.get('token') && urlParams.get('id');
            
            if (isActivationLink) {
                console.log('ğŸ”— Link di attivazione rilevato - avvio diretto');
                
                // Inizializza Supabase in background SENZA mostrare modal
                const config = loadSupabaseConfig();
                if (!config) {
                    showActivationConfigNeeded();
                    return;
                }
                
                supabase = window.supabase.createClient(config.url, config.key);
                
                try {
                    await loadAllData();
                    // Mostra SUBITO la schermata di attivazione
                    await checkActivationLink();
                } catch (error) {
                    console.error('Errore caricamento:', error);
                    showNotification('âŒ Errore caricamento dati: ' + error.message, 'error');
                }
                
                return;
            }
            
            // Solo se NON Ã¨ un link di attivazione, mostra modal Supabase
            const supabaseReady = await initSupabase();
            
            if (!supabaseReady) {
                console.log('âš ï¸ Supabase non configurato');
                return;
            }
            
            await loadEmailJSConfig();
            loadCertificateConfig();
            
            console.log('âœ… Piattaforma pronta!');
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a6b7da070a4edce',t:'MTc2NDUxNzcyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
